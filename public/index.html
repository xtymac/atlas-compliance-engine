<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ACE CMS Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --ink: #222222;
      --muted: #8a8f99;
      --border: #e5e5e5;
      --accent: #1677ff;
      --accent-soft: #e7f0ff;
      --topbar: #1f2022;
      --shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter","Noto Sans JP",system-ui,-apple-system,sans-serif;
      background: var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }
    .topbar {
      height: 64px;
      background: var(--topbar);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      font-weight: 600;
    }
    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
    }
    .topbar-logo-icon {
      width: 28px;
      height: 28px;
      background: #f59e0b;
      border-radius: 4px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 2px;
      padding: 4px;
    }
    .topbar-logo-icon span {
      background: #fff;
      border-radius: 1px;
    }
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
    }
    .topbar-user:hover {
      background: rgba(255,255,255,0.1);
    }
    .topbar-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #374151;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 11px;
      color: #ffffff;
    }
    .topbar-user-chevron {
      font-size: 10px;
      color: #9ca3af;
    }
    .topbar-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #374151;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 13px;
      color: #ffffff;
    }
    .shell {
      display: grid;
      grid-template-columns: 200px 1fr;
      min-height: calc(100vh - 64px);
    }
    aside.nav {
      background: #ffffff;
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .nav-top {
      padding: 12px 8px;
      flex: 1;
    }
    .nav-bottom {
      padding: 8px;
      border-top: 1px solid var(--border);
    }
    .nav-list { display: grid; gap: 2px; }
    .nav-list button {
      all: unset; cursor: pointer; display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 6px; font-weight: 500; font-size: 13px; color: #6b7280;
      transition: background 120ms ease;
    }
    .nav-list button:hover { background: #f3f4f6; }
    .nav-list button.active { background: #f3f4f6; color: #222; }
    .nav-list button .nav-icon { width: 16px; text-align: center; filter: grayscale(1); opacity: 0.7; }
    .nav-collapse-btn {
      all: unset;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      margin-top: 4px;
      transition: background 120ms ease;
    }
    .nav-collapse-btn:hover { background: #f3f4f6; }
    .workspace {
      padding: 32px 24px;
      background: #f6f6f6;
    }
    .hidden { display: none !important; }
    /* Models page */
    .header-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    h2 { margin: 0; font-size: 18px; letter-spacing: -0.01em; color: var(--ink); }
    p { margin: 0; color: var(--muted); }
    input, select {
      font: inherit; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border);
      background: #fff; color: var(--ink);
    }
    select { border-radius: 6px; }
    .btn {
      all: unset;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 500;
      color: var(--ink);
      font-size: 14px;
      line-height: 1.2;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.icon-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      display: grid;
      place-items: center;
      font-size: 16px;
      line-height: 1;
    }
    /* Content Containers */
    .content-box {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
    }
    .projects-box {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      position: relative;
      min-height: 500px;
    }
    /* Welcome Banner */
    .welcome-banner {
      background: transparent;
      padding: 0;
      margin-bottom: 0;
    }
    .welcome-banner h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--ink);
    }
    .welcome-banner p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }
    /* Cards */
    .cards { margin-top: 16px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card {
      background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px;
      display: grid; gap: 12px; box-shadow: none;
      position: relative;
      transition: border-color 120ms ease;
      cursor: pointer;
    }
    .card:hover {
      border-color: #d0d0d0;
    }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card h3 { margin: 0; font-size: 15px; font-weight: 600; color: var(--ink); }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.3; }
    .card footer { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; }
    .icon-row { display: flex; gap: 10px; }
    .icon { width: 16px; height: 16px; border: 1px solid var(--border); border-radius: 4px; display: grid; place-items: center; color: #6b7280; font-size: 11px; }
    .badge {
      padding: 3px 8px; background: #fff; color: var(--accent); border-radius: 4px;
      font-size: 12px; font-weight: 500; border: 1px solid var(--accent);
    }
    .badge.public {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      position: absolute;
      bottom: 24px;
      right: 24px;
    }
    .pagination-btn {
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 120ms ease;
    }
    .pagination-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }
    .pagination-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .pagination-select {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      margin-left: 8px;
    }
    .dropdown { position: relative; }
    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 110%;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      min-width: 180px;
      display: none;
      z-index: 10;
    }
    .dropdown-menu.active { display: block; }
    .dropdown-menu button {
      all: unset;
      display: block;
      width: 100%;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--ink);
      font-size: 13px;
    }
    .dropdown-menu button:hover { background: #f3f4f6; }
    /* Schema page */
    main.schema { background: var(--surface); }
    .schema-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .tabbar { display: flex; gap: 14px; margin: 10px 0 12px 0; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 0; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; color: #4b5563; }
    .tab.active { color: var(--ink); border-bottom-color: var(--accent); }
    .layout { display: grid; grid-template-columns: 240px 1fr 260px; gap: 16px; align-items: start; }
    .left-list {
      border: 1px solid var(--border); border-radius: 12px; background: #fdfdfd; padding: 14px;
      height: calc(100vh - 160px); overflow: auto;
    }
    .section-title { font-weight: 700; font-size: 12px; color: #6b7280; margin: 12px 0 8px; }
    .item { padding: 9px 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .item.active { background: #e6f0ff; color: #0f4bb8; }
    .group-row { border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; margin: 6px 0; background: #fff; }
    .group-row .muted { font-size: 12px; }
    .field-list {
      border: 1px solid var(--border); border-radius: 12px; background: #fff; box-shadow: var(--shadow);
      min-height: 400px; padding: 10px;
    }
    .field-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: grid;
      gap: 6px;
      margin: 8px 0;
      background: #fff;
      transition: transform 140ms ease, margin 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      cursor: pointer;
    }
    .field-card.drop-target { border-color: #2563eb; background: #f0f7ff; }
    .field-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .badge.required {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .badge.validation {
      background: #f3f4f6;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .field-placeholder {
      border: 1px dashed #2563eb;
      border-radius: 10px;
      height: 54px;
      margin: 8px 0;
      background: #f8fbff;
      transition: all 140ms ease;
    }
    /* Content page */
    .content-layout { display: grid; grid-template-columns: 220px 1fr; gap: 16px; }
    .content-sidebar {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fdfdfd;
      padding: 12px;
    }
    .content-table-wrap { position: relative; overflow: visible; border-radius: 12px; }
    .content-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: visible;
    }
    .content-table th, .content-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      text-align: left;
      font-size: 13px;
    }
    .content-table tr:last-child td { border-bottom: none; }
    .content-table tr.active-row td { background: #f0f7ff; }
    .status-dot { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.published { background: #16a34a; }
    .dot.draft { background: #f59e0b; }
    .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
    .cell-editable { background: #fff; }
    .inline-input {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 6px 8px;
      background: #fff;
      font: inherit;
      font-size: 13px;
    }
    .inline-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.15);
    }
    .cell-error {
      border-color: #ef4444 !important;
      background: #fef2f2;
    }
    .cell-error + .tooltip {
      display: block;
    }
    .tooltip {
      display: none;
      position: absolute;
      background: #111827;
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      z-index: 40;
      max-width: 240px;
      white-space: normal;
      transform: translateY(4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .cell-updated {
      animation: flash 1.2s ease;
    }
    @keyframes flash {
      0% { background: #e0f2fe; }
      100% { background: transparent; }
    }
    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.18);
      padding: 16px 18px 18px;
      display: grid;
      gap: 12px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-tabs { display: flex; gap: 12px; border-bottom: 1px solid var(--border); margin: 0 -6px; padding: 0 6px; }
    .modal-tab {
      padding: 10px 6px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      color: #4b5563;
    }
    .modal-tab.active { color: var(--ink); border-bottom-color: var(--accent); }
    .modal-body { display: grid; gap: 10px; }
    .modal-section { display: grid; gap: 8px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 6px; }
    .pill-switch { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #374151; }
    .pill-switch input { width: 16px; height: 16px; }
    textarea { resize: vertical; min-height: 60px; }
    .field-top { display: flex; align-items: center; justify-content: space-between; }
    .collapsible {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fbfcfd;
    }
    .collapsible-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .collapsible-body { margin-top: 8px; display: grid; gap: 8px; }
    .collapsible .chevron { font-size: 12px; color: var(--muted); }
    /* Quick Entry */
    .quick-grid { margin-top: 14px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .quick-card { cursor: pointer; border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: #fff; box-shadow: var(--shadow); transition: transform 120ms ease, box-shadow 120ms ease; }
    .quick-card:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,0.08); }
    .quick-card h3 { margin: 0 0 4px 0; font-size: 15px; }
    .quick-card .muted { font-size: 13px; }
    .quick-hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .field-meta { display: flex; align-items: center; gap: 10px; color: #6b7280; font-size: 12px; }
    .drag-handle { width: 14px; height: 14px; border: 1px solid var(--border); border-radius: 4px; display: grid; place-items: center; font-size: 11px; color: #6b7280; cursor: grab; }
    .field-type { padding: 2px 6px; border-radius: 999px; background: var(--accent-soft); color: #0f4bb8; font-size: 11px; font-weight: 700; }
    .palette {
      background: #fbfcfd;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      height: 100%;
      overflow: auto;
    }
    .palette-title { font-weight: 700; margin: 0 0 8px 0; }
    .palette-group { margin-bottom: 16px; }
    .palette-item {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fff;
      display: grid; gap: 4px; margin: 6px 0; cursor: grab; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }
    .palette-item:hover { border-color: var(--accent); }
    .palette-item strong { font-size: 13px; }
    .palette-item span { color: var(--muted); font-size: 12px; }
    .drop-hint {
      text-align: center; color: #9ca3af; font-size: 13px; padding: 12px 0;
      border: 1px dashed var(--border); border-radius: 10px; margin: 10px 0;
    }
    @media (max-width: 1200px) {
      .shell { grid-template-columns: 200px 1fr; }
      .layout { grid-template-columns: 200px 1fr; }
      .palette { display: none; }
    }
    @media (max-width: 900px) {
      .shell { grid-template-columns: 1fr; }
      aside.nav { flex-direction: row; overflow-x: auto; padding: 8px; }
      .nav-top, .nav-bottom { display: flex; gap: 8px; padding: 0; border: none; }
      .nav-collapse-btn { display: none; }
      .layout { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-logo">
      <div class="topbar-logo-icon">
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
      </div>
      <span>Re: Earth CMS</span>
    </div>
    <div class="topbar-user">
      <div class="topbar-user-avatar">M</div>
      <span>Mac Xiang</span>
      <span class="topbar-user-chevron">â–¼</span>
    </div>
    <div class="topbar-avatar">M</div>
  </div>

  <div class="shell">
    <aside class="nav">
      <div class="nav-top">
        <div class="nav-list">
          <button class="active" data-view="models"><span class="nav-icon">ğŸ </span> Home</button>
          <button data-view="quick"><span class="nav-icon">âš¡</span> Quick Entry</button>
          <button data-view="templates"><span class="nav-icon">ğŸ§­</span> Templates</button>
          <button data-view="schema"><span class="nav-icon">ğŸ§©</span> Schema</button>
          <button data-view="content"><span class="nav-icon">ğŸ—‚ï¸</span> Content</button>
        </div>
      </div>
      <div class="nav-bottom">
        <div class="nav-list">
          <button><span class="nav-icon">ğŸ”—</span> Integrations</button>
          <button><span class="nav-icon">âš™ï¸</span> My Integrations</button>
          <button><span class="nav-icon">âš¡</span> Settings</button>
          <button><span class="nav-icon">ğŸ‘¤</span> Account Settings</button>
        </div>
        <button class="nav-collapse-btn">
          <span>â—€</span>
        </button>
      </div>
    </aside>

    <div id="models-view" class="workspace">
      <div class="content-box">
        <div class="welcome-banner">
          <h1>Welcome to Re:Earth CMS, Mac Xiang!</h1>
          <p>Re:Earth CMS is a robust tool for collecting, creating, storing, and managing data, specifically designed for GIS applications.</p>
        </div>
      </div>

      <div class="projects-box">
        <div class="header-row">
          <h2>Projects</h2>
          <div class="dropdown" style="margin-left:auto;">
            <button id="new-model-btn" class="btn primary">+ New Project</button>
            <div id="new-model-menu" class="dropdown-menu">
              <button data-action="blank">ç©ºç™½ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ</button>
              <button data-action="template">æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆ</button>
            </div>
          </div>
        </div>

        <div class="header-row" style="margin-top:16px;">
          <div style="position:relative;">
            <input placeholder="search projects" style="width:220px; padding-right:36px;">
            <span style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:14px;">ğŸ”</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:auto;">
            <span class="muted">Sort by</span>
            <select>
              <option>Last Modified</option>
              <option>Name A-Z</option>
              <option>Name Z-A</option>
              <option>Created date</option>
            </select>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <div class="card-header">
              <h3>Open Data</h3>
              <span class="badge public">Public</span>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Street Atlas</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">1243</div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>ç©ºãå®¶ Empty houses</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">124124124124</div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Imaginary Cities</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">A collection of fictional cities with det...</div>
          </div>
        </div>

        <div class="pagination">
          <button class="pagination-btn" disabled>â€¹</button>
          <button class="pagination-btn active">1</button>
          <button class="pagination-btn">â€º</button>
          <select class="pagination-select">
            <option>10 / page</option>
            <option>20 / page</option>
            <option>50 / page</option>
          </select>
        </div>
      </div>
    </div>

    <div id="schema-wrapper" class="schema hidden">
      <main class="schema workspace">
        <div class="schema-header">
          <h2>å…¬å…±æ–½è¨­ä¸€è¦§</h2>
          <span class="muted">#public_facility</span>
      </div>
        <div class="tabbar">
          <div class="tab active">Fields</div>
          <div class="tab">Meta Data</div>
        </div>

        <div class="layout">
        <div class="left-list">
            <div class="section-title">MODELS <span style="float:right; color:#2563eb; cursor:pointer;">+ Add</span></div>
            <div id="model-list"></div>
            <div class="section-title">GROUPS</div>
            <div id="group-list"></div>
          </div>

          <div>
            <div id="field-list" class="field-list"></div>
          </div>
          <div class="palette">
            <h3 class="palette-title">Add Field</h3>
            <div id="palette"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="templates-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Templates</h2>
          <p>æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
        </div>
      </div>
      <div class="cards" id="templates-cards"></div>
    </div>

    <div id="content-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Content</h2>
          <p id="content-model-label">Select a model to view items</p>
        </div>
        <button id="new-item-btn" class="btn primary">+ New Item</button>
      </div>
      <div class="content-layout">
        <div class="content-sidebar">
          <div class="section-title">MODELS</div>
          <div id="content-model-list"></div>
        </div>
        <div>
          <div class="row" style="gap:8px; margin-bottom:8px; align-items:center;">
            <input id="content-search" class="input" placeholder="search text" style="max-width:220px;">
            <div class="dropdown" style="display:none;" id="content-actions-wrap">
              <button id="content-actions-btn" class="btn">â‹¯ Actions</button>
              <div id="content-actions-menu" class="dropdown-menu" style="min-width:180px;">
                <button data-action="delete-selected">Delete selected</button>
                <button data-action="publish-selected">Mark as Published</button>
                <button data-action="draft-selected">Mark as Draft</button>
                <button data-action="sort-asc">Sort by first column Aâ†’Z</button>
                <button data-action="sort-desc">Sort by first column Zâ†’A</button>
              </div>
            </div>
          </div>
          <div class="content-table-wrap">
            <table class="content-table" id="content-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="quick-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Quick Entry</h2>
          <p>ã‚ˆãä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç°¡æ˜“å…¥åŠ›ã§è¿½åŠ </p>
        </div>
      </div>
      <div class="quick-grid" id="quick-cards"></div>
      <div class="quick-hint">æœ€å°å…¥åŠ›ã§ãƒ‰ãƒ©ãƒ•ãƒˆã‚’ä½œæˆã—ã€Contentã§è©³ç´°ã‚’è¿½è¨˜ã§ãã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- Field Edit Modal -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Update Field</div>
          <h3 id="modal-title" style="margin:0;">Field</h3>
        </div>
        <button id="modal-close" class="btn">âœ•</button>
      </div>
      <div class="modal-tabs">
        <div class="modal-tab active" data-tab="settings">Settings</div>
        <div class="modal-tab" data-tab="validation">Validation</div>
        <div class="modal-tab" data-tab="default">Default value</div>
      </div>
      <div class="modal-body">
        <div class="modal-section modal-pane" data-pane="settings">
          <div>
            <label>Display name</label>
            <input id="field-display" placeholder="è¡¨ç¤ºå">
          </div>
          <div>
            <label>Field Key</label>
            <input id="field-key" placeholder="field_key">
            <div class="muted" style="font-size:12px;">åŠè§’è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³/ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿</div>
          </div>
          <div>
            <label>Description <span class="muted">(optional)</span></label>
            <textarea id="field-desc" maxlength="1000" placeholder="èª¬æ˜æ–‡"></textarea>
          </div>
          <div id="field-options-section" class="modal-section" style="display:none;">
            <label>Options (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
            <input id="field-options" placeholder="yes,no,unknown">
            <div class="pill-switch"><input type="checkbox" id="field-multi"> <label for="field-multi">Support multiple values</label></div>
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="validation">
          <div class="pill-switch"><input type="checkbox" id="field-required"> <label for="field-required">Required (â—)</label></div>
          <div id="field-pattern-section" style="display:none;">
            <label>Pattern (regex)</label>
            <input id="field-pattern" placeholder="ä¾‹: ^[0-9]{6}$">
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="default">
          <div>
            <label>Default value</label>
            <input id="field-default" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn">Cancel</button>
        <button id="modal-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Template Selection Modal -->
  <div id="template-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 860px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">æ¨™æº–ãƒ¢ãƒ‡ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é¸æŠ</div>
          <h3 style="margin:0;">Templates</h3>
        </div>
        <button id="template-modal-close" class="btn">âœ•</button>
      </div>
      <div class="row" style="gap:8px;">
        <input id="template-search" placeholder="æ¤œç´¢ (ä¾‹: AED, å…¬å…±æ–½è¨­, ã‚¤ãƒ™ãƒ³ãƒˆ)" style="flex:1;">
        <select id="template-filter" style="width:180px;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="facility">æ–½è¨­</option>
          <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="emergency">é˜²ç½</option>
        </select>
      </div>
      <div id="template-modal-cards" class="cards" style="margin-top:12px; max-height:60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="template-modal-cancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Template Edit Modal -->
  <div id="template-edit-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 540px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†</div>
          <h3 id="template-edit-title" style="margin:0;">Template</h3>
        </div>
        <button id="template-edit-close" class="btn">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <label>åç§°</label>
          <input id="tpl-edit-label" placeholder="å…¬å…±æ–½è¨­ä¸€è¦§">
        </div>
        <div class="modal-section">
          <label>Model Key</label>
          <input id="tpl-edit-key" placeholder="public_facility">
        </div>
        <div class="modal-section">
          <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
          <input id="tpl-edit-version" placeholder="v3.0">
        </div>
        <div class="modal-section">
          <label>åˆ†é¡</label>
          <input id="tpl-edit-category" placeholder="facility / emergency / event">
        </div>
        <div class="modal-section">
          <label>æ¦‚è¦</label>
          <textarea id="tpl-edit-summary" placeholder="æ¦‚è¦ã‚’å…¥åŠ›"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button id="tpl-edit-cancel" class="btn">Cancel</button>
        <button id="tpl-edit-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="item-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">New Item</div>
          <h3 id="item-modal-title" style="margin:0;">Item</h3>
        </div>
        <button id="item-modal-close" class="btn">âœ•</button>
      </div>
      <div id="item-form" class="modal-body" style="max-height: 60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="item-modal-cancel" class="btn">Cancel</button>
        <button id="item-modal-save" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Quick Entry Modal -->
  <div id="quick-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Quick Entry</div>
          <h3 id="quick-modal-title" style="margin:0;">Template</h3>
        </div>
        <button id="quick-modal-close" class="btn">âœ•</button>
      </div>
      <div id="quick-form" class="modal-body"></div>
      <div class="modal-actions">
        <button id="quick-modal-cancel" class="btn">Cancel</button>
        <button id="quick-modal-save" class="btn primary">Save Draft</button>
      </div>
    </div>
  </div>

  <script>
    // View switcher with persistence
    const navButtons = document.querySelectorAll('.nav-list button[data-view]');
    const crumbTitle = document.getElementById('crumb-title');
    const modelsView = document.getElementById('models-view');
    const schemaWrapper = document.getElementById('schema-wrapper');
    const templatesView = document.getElementById('templates-view');
    const quickView = document.getElementById('quick-view');
    const contentView = document.getElementById('content-view');

    function switchView(target) {
      const viewMap = {
        models: modelsView,
        schema: schemaWrapper,
        templates: templatesView,
        quick: quickView,
        content: contentView,
      };
      Object.values(viewMap).forEach((el) => el.classList.add('hidden'));
      if (viewMap[target]) viewMap[target].classList.remove('hidden');
      navButtons.forEach((b) => b.classList.toggle('active', b.dataset.view === target));
      crumbTitle.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      try {
        localStorage.setItem('ace_last_view', target);
      } catch (_) {}
      if (target === 'content') {
        renderContentModelList();
        renderContentTable();
        updateActionsVisibility();
      } else if (target === 'quick') {
        renderQuickCards();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        switchView(target);
      });
    });

    // Schema drag/drop
    const fieldListEl = document.getElementById('field-list');
    const paletteEl = document.getElementById('palette');

    const initialFields = [
      { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
      { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
      { label: "åç§° (Name)", key: "name", type: "Text" },
      { label: "åç§°_è‹±å­—", key: "nameEn", type: "Text" },
      { label: "åç§°_é€šç§°", key: "nameAlias", type: "Text" },
      { label: "POIã‚³ãƒ¼ãƒ‰", key: "poiCode", type: "Int", meta: "åŠè§’æ•°å­—" },
      { label: "å¤–éƒ¨è­˜åˆ¥å­", key: "externalIdentifier", type: "Text" },
      { label: "å¤–éƒ¨è­˜åˆ¥å­ã®å€¤", key: "externalIdentifierValue", type: "Text" },
      { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
      { label: "é€£çµ¡å…ˆ (Contact)", key: "contact", type: "Text" },
      { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
    ];

    const childcareFields = [
      { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
      { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
      { label: "æ–½è¨­å", key: "facilityName", type: "Text" },
      { label: "æ–½è¨­ç¨®åˆ¥", key: "facilityCategory", type: "Option", meta: "ä¿è‚²æ‰€,å¹¼ç¨šåœ’,èªå®šã“ã©ã‚‚åœ’,å­¦ç«¥,ãã®ä»–" },
      { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
      { label: "é›»è©±ç•ªå·", key: "phone", type: "Text" },
      { label: "é–‹æ‰€æ™‚é–“", key: "openingHours", type: "Text" },
      { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
    ];

    const paletteGroups = [
      { title: "Text", items: [
        { label: "Text", desc: "å˜è¡Œãƒ†ã‚­ã‚¹ãƒˆ", type: "Text" },
        { label: "TextArea", desc: "è¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆ", type: "TextArea" },
        { label: "Markdown", desc: "ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ", type: "Markdown" }
      ]},
      { title: "Asset", items: [
        { label: "Asset", desc: "ãƒ•ã‚¡ã‚¤ãƒ« / 3D Tiles / CityGML", type: "Asset" }
      ]},
      { title: "Time", items: [
        { label: "Date", desc: "Date picker", type: "Date" }
      ]},
      { title: "Boolean", items: [
        { label: "Boolean", desc: "true/false", type: "Boolean" }
      ]},
      { title: "Select", items: [
        { label: "Option", desc: "çµ±åˆ¶èªå½™ / Enum", type: "Option" }
      ]},
      { title: "Number", items: [
        { label: "Int", desc: "Integer", type: "Int" },
        { label: "Float", desc: "Fractional", type: "Float" }
      ]},
      { title: "Geo", items: [
        { label: "Coordinate", desc: "ç·¯åº¦ãƒ»çµŒåº¦ (GIF)", type: "Coordinate" }
      ]}
    ];

    const modelStore = {
      "public-facilities": {
        label: "å…¬å…±æ–½è¨­ä¸€è¦§",
        fields: [...initialFields],
        meta: initialFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","name","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: f.type === "Option" && f.meta ? f.meta.split(",") : [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6æ¡") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "é€£çµ¡å…ˆ", "ä½ç½®æƒ…å ±", "æ›´æ–°æƒ…å ±"]
      },
      "childcare-facilities": {
        label: "å­è‚²ã¦æ–½è¨­ä¸€è¦§",
        fields: [...childcareFields],
        meta: childcareFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","facilityName","facilityCategory","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: f.type === "Option" && f.meta ? f.meta.split(",") : [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6æ¡") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "ã‚µãƒ¼ãƒ“ã‚¹", "æ™‚é–“", "ãƒ¡ãƒ‡ã‚£ã‚¢"]
      },
      "aed-locations": {
        label: "AEDè¨­ç½®ç®‡æ‰€ä¸€è¦§",
        fields: [
          { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
          { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
          { label: "è¨­ç½®å ´æ‰€åç§°", key: "name", type: "Text" },
          { label: "è¨­ç½®å ´æ‰€è©³ç´°", key: "installationPlace", type: "Text" },
          { label: "å°å…å¯¾å¿œè¨­å‚™ã®æœ‰ç„¡", key: "pediatricSupport", type: "Option", meta: "yes,no" },
          { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
          { label: "å•ã„åˆã‚ã›å…ˆé›»è©±ç•ªå·", key: "contactPhone", type: "Text" },
          { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
          { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
        ],
        meta: [
          { display: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", description: "", required: true, options: [], allowMultiple: false, pattern: "^[0-9]{6}$", defaultValue: "" },
          { display: "ID", key: "identifier", description: "", required: true, options: [], allowMultiple: false, pattern: "^[A-Za-z0-9_-]+$", defaultValue: "" },
          { display: "è¨­ç½®å ´æ‰€åç§°", key: "name", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "è¨­ç½®å ´æ‰€è©³ç´°", key: "installationPlace", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "å°å…å¯¾å¿œè¨­å‚™ã®æœ‰ç„¡", key: "pediatricSupport", description: "", required: true, options: ["yes","no"], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "æ‰€åœ¨åœ° (Address)", key: "address", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "å•ã„åˆã‚ã›å…ˆé›»è©±ç•ªå·", key: "contactPhone", description: "", required: false, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" }
        ],
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "è¨­å‚™", "ä½ç½®æƒ…å ±", "æ›´æ–°æƒ…å ±"]
      }
    };
    const templateList = [
      { id: "public-facilities", label: "å…¬å…±æ–½è¨­ä¸€è¦§", key: "public_facility", version: "v3.0", category: "facility", summary: "åœ°æ–¹å…¬å…±å›£ä½“ãŒç®¡ç†ã™ã‚‹å…¬å…±æ–½è¨­ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿" },
      { id: "aed-locations", label: "AEDè¨­ç½®ç®‡æ‰€ä¸€è¦§", key: "aed_location", version: "v2.1", category: "emergency", summary: "AEDè¨­ç½®å ´æ‰€ã¨å¯¾å¿œå¯å¦ã‚’å«ã‚€ç·Šæ€¥åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿" },
      { id: "childcare-facilities", label: "å­è‚²ã¦æ–½è¨­ä¸€è¦§", key: "childcare_facility", version: "v1.4", category: "facility", summary: "ä¿è‚²ãƒ»å¹¼ç¨šåœ’ãƒ»å­¦ç«¥æ–½è¨­ã®ä¸€è¦§ã¨è¨­å‚™æƒ…å ±" }
    ];
    const quickTemplates = [
      {
        id: "public-facilities",
        label: "å…¬å…±æ–½è¨­ï¼ˆã‹ã‚“ãŸã‚“ï¼‰",
        description: "åç§°ãƒ»IDãƒ»æ‰€åœ¨åœ°ã‚’ã™ãç™»éŒ²",
        fields: [
          { key: "name", label: "æ–½è¨­å", required: true, placeholder: "ä¸­å¤®å›³æ›¸é¤¨" },
          { key: "identifier", label: "ID", required: true, placeholder: "åŠè§’æ•°å­—" },
          { key: "address", label: "æ‰€åœ¨åœ°", required: true, placeholder: "éƒ½é“åºœçœŒ å¸‚åŒºç”ºæ‘" },
          { key: "nameAlias", label: "åç§°_é€šç§°", required: false },
          { key: "poiCode", label: "POIã‚³ãƒ¼ãƒ‰", required: false, type: "number" }
        ]
      },
      {
        id: "aed-locations",
        label: "AEDè¨­ç½®ç®‡æ‰€ï¼ˆã‹ã‚“ãŸã‚“ï¼‰",
        description: "è¨­ç½®å ´æ‰€ã‚’æœ€å°å…¥åŠ›ã§è¿½åŠ ",
        fields: [
          { key: "name", label: "è¨­ç½®å ´æ‰€åç§°", required: true, placeholder: "å¸‚å½¹æ‰€ 1F" },
          { key: "installationPlace", label: "è¨­ç½®å ´æ‰€è©³ç´°", required: true, placeholder: "å—ä»˜å‰" },
          { key: "address", label: "æ‰€åœ¨åœ°", required: true, placeholder: "æ±äº¬éƒ½æ–°å®¿åŒº..." },
          { key: "pediatricSupport", label: "å°å…å¯¾å¿œè¨­å‚™ã®æœ‰ç„¡", required: false, placeholder: "yes / no" }
        ]
      },
      {
        id: "childcare-facilities",
        label: "å­è‚²ã¦æ–½è¨­ï¼ˆã‹ã‚“ãŸã‚“ï¼‰",
        description: "æ–½è¨­åã¨ç¨®åˆ¥ã ã‘ã§ä½œæˆ",
        fields: [
          { key: "facilityName", label: "æ–½è¨­å", required: true },
          { key: "facilityCategory", label: "æ–½è¨­ç¨®åˆ¥", required: true, placeholder: "ä¿è‚²æ‰€ ãªã©" },
          { key: "address", label: "æ‰€åœ¨åœ°", required: true },
          { key: "openingHours", label: "é–‹æ‰€æ™‚é–“", required: false, placeholder: "09:00-18:00" }
        ]
      }
    ];
    const contentStore = {
      "public-facilities": [
        { status: "Published", localGovernmentCode: "352080", identifier: "1200005", name: "ä¸­å¤®å›³æ›¸é¤¨", nameEn: "Central Library", nameAlias: "ä¸­å¤®å›³æ›¸é¤¨", poiCode: "1001", externalIdentifier: "lib-central", externalIdentifierValue: "LC-001", address: "å±±å£çœŒå²©å›½å¸‚", latitudeLongitude: "34.1, 132.2" },
        { status: "Draft", localGovernmentCode: "352080", identifier: "1200006", name: "å¸‚æ°‘ãƒ—ãƒ¼ãƒ«", nameEn: "City Pool", nameAlias: "å¸‚æ°‘ãƒ—ãƒ¼ãƒ«", poiCode: "1002", externalIdentifier: "pool-city", externalIdentifierValue: "PC-002", address: "å±±å£çœŒå²©å›½å¸‚", latitudeLongitude: "34.2, 132.3" }
      ],
      "aed-locations": [
        { status: "Published", localGovernmentCode: "131016", identifier: "aed-01", name: "å¸‚å½¹æ‰€ 1F", address: "æ±äº¬éƒ½æ–°å®¿åŒº", pediatricSupport: "yes", latitudeLongitude: "35.6, 139.7" }
      ],
      "childcare-facilities": [
        { status: "Published", localGovernmentCode: "131016", identifier: "cc-01", facilityName: "ã•ãã‚‰ä¿è‚²åœ’", address: "æ±äº¬éƒ½æ‰ä¸¦åŒº", facilityCategory: "ä¿è‚²æ‰€", latitudeLongitude: "35.7, 139.6" }
      ]
    };

    let currentModelId = "public-facilities";

    function currentFields() {
      return modelStore[currentModelId].fields;
    }
    function currentMeta() {
      return modelStore[currentModelId].meta;
    }
    function currentGroups() {
      return modelStore[currentModelId].groups || [];
    }
    const placeholder = document.createElement('div');
    placeholder.className = 'field-placeholder';
    let currentPlaceholderIndex = null;

    function removePlaceholder() {
      if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
      currentPlaceholderIndex = null;
    }

    function placeholderIndex() {
      if (!fieldListEl) return fields.length;
      const children = Array.from(fieldListEl.children);
      let idx = 0;
      for (const child of children) {
        if (child === placeholder) break;
        if (child.classList.contains('field-card')) idx++;
      }
      return idx;
    }

    function showPlaceholderAt(idx) {
      if (idx === currentPlaceholderIndex) return;
      removePlaceholder();
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      if (cards[idx]) {
        fieldListEl.insertBefore(placeholder, cards[idx]);
      } else {
        fieldListEl.appendChild(placeholder);
      }
      currentPlaceholderIndex = idx;
    }

    function calcInsertIndex(clientY) {
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      for (let i = 0; i < cards.length; i++) {
        const rect = cards[i].getBoundingClientRect();
        const upper = rect.top + rect.height * 0.35;
        const lower = rect.bottom - rect.height * 0.35;
        if (clientY < upper) return i;         // top zone: insert before
        if (clientY > lower) continue;         // bottom zone: keep scanning
        return i + 1;                          // middle zone: insert after
      }
      return cards.length;
    }

    function addField(item, index = currentFields().length) {
      const key = `${item.type.toLowerCase()}_${(Date.now()).toString(36).slice(-4)}`;
      const newField = { label: item.label, key, type: item.type, meta: item.desc };
      currentFields().splice(index, 0, newField);
      currentMeta().splice(index, 0, {
        display: item.label,
        key,
        description: "",
        required: false,
        options: [],
        allowMultiple: false,
        pattern: "",
        defaultValue: ""
      });
      renderFields();
      removePlaceholder();
    }

    function renderFields() {
      if (!fieldListEl) return;
      fieldListEl.innerHTML = "";
      currentFields().forEach((f, idx) => {
        const card = document.createElement('div');
        card.className = 'field-card';
        card.dataset.index = idx;
        card.innerHTML = `
          <div class="field-top">
            <div class="field-meta">
              <span class="drag-handle" draggable="true" title="Drag">â‰¡</span>
              <strong>${f.label}</strong>
            </div>
            <span class="field-type">${f.type}</span>
          </div>
          <div class="field-meta">
            <span>#${f.key}</span>
            ${f.meta ? `<span>â€¢ ${f.meta}</span>` : ""}
          </div>
          <div class="field-badges">
            <span class="field-type">${f.type}</span>
            ${currentMeta()[idx].required ? '<span class="badge required">â— Required</span>' : ""}
            ${currentMeta()[idx].pattern ? `<span class="badge validation">Pattern: ${currentMeta()[idx].pattern}</span>` : ""}
          </div>
        `;
        card.addEventListener('click', () => openModal(idx));
        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          card.classList.add('drop-target');
          const insertIdx = calcInsertIndex(e.clientY);
          showPlaceholderAt(insertIdx);
        });
        card.addEventListener('dragleave', () => {
          card.classList.remove('drop-target');
        });
        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drop-target');
          const data = e.dataTransfer.getData('application/json');
          if (!data) return;
          const item = JSON.parse(data);
          const insertIdx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
          addField(item, insertIdx);
        });
        fieldListEl.appendChild(card);
      });
    }

    function renderModelList() {
      const container = document.getElementById('model-list');
      if (!container) return;
      container.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const item = document.createElement('div');
        item.className = 'item';
        if (id === currentModelId) item.classList.add('active');
        item.dataset.model = id;
        item.textContent = modelStore[id].label;
        item.addEventListener('click', () => {
          currentModelId = id;
          renderModelList();
          renderGroups();
          renderFields();
          removePlaceholder();
        });
        container.appendChild(item);
      });
    }

    function renderGroups() {
      const container = document.getElementById('group-list');
      if (!container) return;
      container.innerHTML = "";
      const groups = currentGroups();
      if (groups.length === 0) return;
      const groupMeta = [
        { name: "åŸºæœ¬æƒ…å ± / è­˜åˆ¥å­", key: "Core / ID", examples: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰ã€åç§°ã€åç§°_ã‚«ãƒŠ" },
        { name: "æ‰€åœ¨åœ° / GISæƒ…å ±", key: "Location", examples: "æ‰€åœ¨åœ°_é€£çµè¡¨è¨˜ã€ç·¯åº¦ã€çµŒåº¦" },
        { name: "åˆ©ç”¨å¯èƒ½æ—¥æ™‚", key: "Schedule", examples: "åˆ©ç”¨å¯èƒ½æ›œæ—¥ã€é–‹å§‹æ™‚é–“ã€çµ‚äº†æ™‚é–“" },
        { name: "ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£", key: "Accessibility", examples: "è»Šæ¤…å­å¯ã€æˆä¹³å®¤ã€ãŠã‚€ã¤æ›¿ãˆã‚³ãƒ¼ãƒŠãƒ¼" },
        { name: "å‚ç…§ / ãƒ¡ãƒ‡ã‚£ã‚¢", key: "Media", examples: "URLã€ç”»åƒã€ç”»åƒ_ãƒ©ã‚¤ã‚»ãƒ³ã‚¹" }
      ];
      (groupMeta.length ? groupMeta : groups.map((g) => ({ name: g, key: "", examples: "" }))).forEach((g) => {
        const row = document.createElement('div');
        row.className = 'group-row';
        row.innerHTML = `
          <div style="font-weight:600;">${g.name}</div>
          <div class="muted">${g.key || ""}</div>
          <div class="muted">${g.examples || ""}</div>
        `;
        container.appendChild(row);
      });
    }

    function renderPalette() {
      if (!paletteEl) return;
      paletteEl.innerHTML = "";
      paletteGroups.forEach(group => {
        const wrapper = document.createElement('div');
        wrapper.className = 'palette-group';
        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = group.title;
        wrapper.appendChild(title);
        group.items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'palette-item';
          el.draggable = true;
          el.dataset.type = item.type;
          el.dataset.label = item.label;
          el.innerHTML = `<strong>${item.label}</strong><span>${item.desc}</span>`;
          el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('application/json', JSON.stringify(item));
          });
          wrapper.appendChild(el);
        });
        paletteEl.appendChild(wrapper);
      });
    }

    if (fieldListEl) {
      fieldListEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "#2563eb";
        const insertIdx = calcInsertIndex(e.clientY);
        showPlaceholderAt(insertIdx);
      });

      fieldListEl.addEventListener('dragleave', () => {
        fieldListEl.style.borderColor = "var(--border)";
        removePlaceholder();
      });

      fieldListEl.addEventListener('drop', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "var(--border)";
        const idx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
        const data = e.dataTransfer.getData('application/json');
        if (!data) return;
        const item = JSON.parse(data);
        addField(item, idx); // drop at placeholder or calculated position
      });
    }
  </script>
  <script>
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalSave = document.getElementById('modal-save');
    const tabs = document.querySelectorAll('.modal-tab');
    const panes = document.querySelectorAll('.modal-pane');
    const displayInput = document.getElementById('field-display');
    const keyInput = document.getElementById('field-key');
    const descInput = document.getElementById('field-desc');
    const optionsSection = document.getElementById('field-options-section');
    const optionsInput = document.getElementById('field-options');
    const multiInput = document.getElementById('field-multi');
    const requiredInput = document.getElementById('field-required');
    const patternSection = document.getElementById('field-pattern-section');
    const patternInput = document.getElementById('field-pattern');
    const defaultInput = document.getElementById('field-default');
    let editingIndex = null;

    function switchTab(tabName) {
      tabs.forEach(t => {
        const active = t.dataset.tab === tabName;
        t.classList.toggle('active', active);
      });
      panes.forEach(p => {
        const show = p.dataset.pane === tabName;
        p.classList.toggle('hidden', !show);
      });
    }
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

    function openModal(idx) {
      editingIndex = idx;
      const f = currentFields()[idx];
      const meta = currentMeta()[idx];
      modalTitle.textContent = `${meta.display || f.label}`;
      displayInput.value = meta.display || f.label || "";
      keyInput.value = meta.key || f.key || "";
      descInput.value = meta.description || "";
      optionsSection.style.display = f.type === "Option" ? "grid" : "none";
      optionsInput.value = (meta.options || []).join(",");
      multiInput.checked = !!meta.allowMultiple;
      requiredInput.checked = !!meta.required;
      patternSection.style.display = f.type === "Text" || f.type === "Coordinate" ? "block" : "none";
      patternInput.value = meta.pattern || "";
      defaultInput.value = meta.defaultValue || "";
      switchTab("settings");
      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      editingIndex = null;
    }
    modalClose.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    modalSave.addEventListener('click', () => {
      if (editingIndex === null) return closeModal();
      const f = currentFields()[editingIndex];
      const meta = currentMeta()[editingIndex];
      meta.display = displayInput.value.trim() || f.label;
      meta.key = keyInput.value.trim() || f.key;
      meta.description = descInput.value.trim();
      if (f.type === "Option") {
        meta.options = optionsInput.value
          .split(",")
          .map((v) => v.trim())
          .filter(Boolean);
        meta.allowMultiple = multiInput.checked;
      }
      meta.required = requiredInput.checked;
      meta.pattern = patternInput.value.trim();
      meta.defaultValue = defaultInput.value;

      // sync display/key back to field for rendering
      f.label = meta.display;
      f.key = meta.key;
      f.meta = meta.description;
      renderFields();
      closeModal();
    });

    function ensureModelFromTemplate(tplId) {
      if (modelStore[tplId]) return;
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      const baseFields = tpl.id === "aed-locations" ? modelStore["aed-locations"].fields : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].fields : modelStore["public-facilities"].fields;
      const baseMeta = tpl.id === "aed-locations" ? modelStore["aed-locations"].meta : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].meta : modelStore["public-facilities"].meta;
      modelStore[tplId] = {
        label: tpl.label,
        fields: JSON.parse(JSON.stringify(baseFields)),
        meta: JSON.parse(JSON.stringify(baseMeta)),
        groups: tpl.id === "aed-locations" ? modelStore["aed-locations"].groups : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].groups : modelStore["public-facilities"].groups
      };
    }

    function applyTemplate(tplId) {
      ensureModelFromTemplate(tplId);
      currentModelId = tplId;
      renderModelList();
      renderGroups();
      renderFields();
      removePlaceholder();
      // Switch to Schema view
      switchView('schema');
      closeTemplateModal();
    }

    function renderTemplates() {
      const container = document.getElementById('templates-cards');
      if (!container) return;
      container.innerHTML = "";
      templateList.forEach((tpl) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>${tpl.label}</h3><span class="badge">Template</span>
          </div>
          <div class="muted">#${tpl.key} â€¢ ${tpl.version || ""}</div>
          <div class="muted">${tpl.summary || ""}</div>
          <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
            <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
          </div>
          <div style="position:absolute; right:10px; bottom:10px;">
            <div class="dropdown menu-wrap">
              <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">â‹¯</button>
              <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Templates view apply buttons (delegated)
    document.addEventListener('click', (e) => {
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
      }
    });

    // New Model dropdown
    const newModelBtn = document.getElementById('new-model-btn');
    const newModelMenu = document.getElementById('new-model-menu');
    newModelBtn?.addEventListener('click', () => {
      newModelMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!newModelMenu.contains(e.target) && e.target !== newModelBtn) {
        newModelMenu.classList.remove('active');
      }
    });
    newModelMenu?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'template') {
        openTemplateModal();
      }
      if (e.target.dataset.action === 'blank') {
        const id = `custom-${Date.now()}`;
        modelStore[id] = { label: "Custom Model", fields: [], meta: [], groups: ["åŸºæœ¬æƒ…å ±"] };
        currentModelId = id;
        renderModelList();
        renderGroups();
        renderFields();
        removePlaceholder();
        switchView('schema');
      }
    });

    // Template modal handlers
    const templateModal = document.getElementById('template-modal-backdrop');
    const templateModalCards = document.getElementById('template-modal-cards');
    const templateSearch = document.getElementById('template-search');
    const templateFilter = document.getElementById('template-filter');
    document.getElementById('template-modal-close').addEventListener('click', closeTemplateModal);
    document.getElementById('template-modal-cancel').addEventListener('click', closeTemplateModal);

    // Template edit modal
    const tplEditBackdrop = document.getElementById('template-edit-backdrop');
    const tplEditTitle = document.getElementById('template-edit-title');
    const tplEditLabel = document.getElementById('tpl-edit-label');
    const tplEditKey = document.getElementById('tpl-edit-key');
    const tplEditVersion = document.getElementById('tpl-edit-version');
    const tplEditCategory = document.getElementById('tpl-edit-category');
    const tplEditSummary = document.getElementById('tpl-edit-summary');
    const tplEditSave = document.getElementById('tpl-edit-save');
    const tplEditClose = document.getElementById('template-edit-close');
    const tplEditCancel = document.getElementById('tpl-edit-cancel');
    let editingTemplateId = null;

    function renderTemplateModalCards() {
      const query = (templateSearch?.value || "").toLowerCase();
      const filter = templateFilter?.value || "all";
      templateModalCards.innerHTML = "";
      templateList
        .filter((tpl) => {
          const matchText = tpl.label.toLowerCase().includes(query) || tpl.key.toLowerCase().includes(query) || (tpl.summary || "").toLowerCase().includes(query);
          const matchCat = filter === "all" || tpl.category === filter;
          return matchText && matchCat;
        })
        .forEach((tpl) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>${tpl.label}</h3><span class="badge">Template</span>
            </div>
            <div class="muted">#${tpl.key} â€¢ ${tpl.version || ""} â€¢ ${tpl.category || ""}</div>
            <div class="muted">${tpl.summary || ""}</div>
            <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
              <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
            </div>
            <div style="position:absolute; right:10px; bottom:10px;">
              <div class="dropdown menu-wrap">
                <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">â‹¯</button>
                <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                  <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                  <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
                </div>
              </div>
            </div>
          `;
          templateModalCards.appendChild(card);
        });
    }
    function openTemplateModal() {
      renderTemplateModalCards();
      templateModal.style.display = "flex";
    }
    function closeTemplateModal() {
      templateModal.style.display = "none";
    }
    templateSearch?.addEventListener('input', renderTemplateModalCards);
    templateFilter?.addEventListener('change', renderTemplateModalCards);
    templateModal.addEventListener('click', (e) => {
      if (e.target === templateModal) closeTemplateModal();
    });

    function openTemplateEditModal(tplId) {
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      editingTemplateId = tplId;
      tplEditTitle.textContent = tpl.label;
      tplEditLabel.value = tpl.label;
      tplEditKey.value = tpl.key;
      tplEditVersion.value = tpl.version || "";
      tplEditCategory.value = tpl.category || "";
      tplEditSummary.value = tpl.summary || "";
      tplEditBackdrop.style.display = "flex";
    }
    function closeTemplateEditModal() {
      tplEditBackdrop.style.display = "none";
      editingTemplateId = null;
    }
    tplEditClose.addEventListener('click', closeTemplateEditModal);
    tplEditCancel.addEventListener('click', closeTemplateEditModal);
    tplEditBackdrop.addEventListener('click', (e) => {
      if (e.target === tplEditBackdrop) closeTemplateEditModal();
    });
    tplEditSave.addEventListener('click', () => {
      if (!editingTemplateId) return closeTemplateEditModal();
      const tpl = templateList.find((t) => t.id === editingTemplateId);
      if (!tpl) return closeTemplateEditModal();
      tpl.label = tplEditLabel.value.trim() || tpl.label;
      tpl.key = tplEditKey.value.trim() || tpl.key;
      tpl.version = tplEditVersion.value.trim();
      tpl.category = tplEditCategory.value.trim() || tpl.category;
      tpl.summary = tplEditSummary.value.trim();
      renderTemplates();
      renderTemplateModalCards();
      renderModelList();
      closeTemplateEditModal();
    });
    // delegated template menu (apply/preview/edit)
    document.addEventListener('click', (e) => {
      const menuBtn = e.target.closest('.tpl-menu-btn');
      if (menuBtn) {
        e.stopPropagation();
        const id = menuBtn.dataset.id;
        closeAllTplMenus();
        toggleTplMenu(id);
        return;
      }
      if (e.target?.dataset?.action === 'edit-template') {
        openTemplateEditModal(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'preview-template') {
        alert(`Preview for ${e.target.dataset.id} (stub)`);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      // click outside menus
      if (!e.target.closest('.tpl-menu')) {
        closeAllTplMenus();
      }
    });

    // Content view
    const quickCards = document.getElementById('quick-cards');
    const quickModal = document.getElementById('quick-modal-backdrop');
    const quickForm = document.getElementById('quick-form');
    const quickModalClose = document.getElementById('quick-modal-close');
    const quickModalCancel = document.getElementById('quick-modal-cancel');
    const quickModalSave = document.getElementById('quick-modal-save');
    const quickModalTitle = document.getElementById('quick-modal-title');
    const contentModelList = document.getElementById('content-model-list');
    const contentTable = document.getElementById('content-table');
    const contentSearch = document.getElementById('content-search');
    const contentActionsBtn = document.getElementById('content-actions-btn');
    const contentActionsWrap = document.getElementById('content-actions-wrap');
    const contentActionsMenu = document.getElementById('content-actions-menu');
    const contentModelLabel = document.getElementById('content-model-label');
    const newItemBtn = document.getElementById('new-item-btn');
    let currentUser = localStorage.getItem('ace_user') || `User-${Math.floor(Math.random()*1000)}`;
    const itemModal = document.getElementById('item-modal-backdrop');
    const itemForm = document.getElementById('item-form');
    const itemModalClose = document.getElementById('item-modal-close');
    const itemModalCancel = document.getElementById('item-modal-cancel');
    const itemModalSave = document.getElementById('item-modal-save');
    const itemModalTitle = document.getElementById('item-modal-title');
    let currentQuickTemplateId = null;

    function renderQuickCards() {
      if (!quickCards) return;
      quickCards.innerHTML = "";
      quickTemplates.forEach((tpl) => {
        const card = document.createElement('div');
        card.className = 'quick-card';
        card.dataset.id = tpl.id;
        card.innerHTML = `
          <h3>${tpl.label}</h3>
          <div class="muted">${tpl.description}</div>
        `;
        card.addEventListener('click', () => openQuickModal(tpl.id));
        quickCards.appendChild(card);
      });
    }

    function openQuickModal(tplId) {
      const tpl = quickTemplates.find((t) => t.id === tplId);
      if (!tpl) return;
      ensureModelFromTemplate(tpl.id);
      currentQuickTemplateId = tpl.id;
      quickModalTitle.textContent = tpl.label;
      quickForm.innerHTML = "";
      const intro = document.createElement('div');
      intro.className = 'muted';
      intro.style.fontSize = '12px';
      intro.textContent = 'å¿…é ˆã ã‘å…¥åŠ›ã—ã¦ä½œæˆã§ãã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¾Œã§è¿½åŠ å¯èƒ½ã€‚';
      quickForm.appendChild(intro);

      const requiredBlocks = [];
      const optionalBlocks = [];

      tpl.fields.forEach((field) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-section';
        const typeAttr = field.type === "number" ? 'type="number"' : 'type="text"';
        wrapper.innerHTML = `
          <label>${field.label} ${field.required ? '<span class="badge required">â—</span>' : ''}</label>
          <input class="input" ${typeAttr} data-key="${field.key}" placeholder="${field.placeholder || ''}">
        `;
        (field.required ? requiredBlocks : optionalBlocks).push(wrapper);
      });

      const requiredContainer = document.createElement('div');
      requiredContainer.className = 'modal-section';
      requiredBlocks.forEach((el) => requiredContainer.appendChild(el));
      quickForm.appendChild(requiredContainer);

      if (optionalBlocks.length) {
        const optionalContainer = document.createElement('div');
        optionalContainer.className = 'collapsible';
        optionalContainer.innerHTML = `
          <div class="collapsible-header">
            <div>
              <strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›® (${optionalBlocks.length})</strong>
              <div class="muted" style="font-size:12px;">å¾Œã§ç·¨é›†ã§ãã¾ã™</div>
            </div>
            <span class="chevron">â–¾</span>
          </div>
          <div class="collapsible-body hidden"></div>
        `;
        const body = optionalContainer.querySelector('.collapsible-body');
        optionalBlocks.forEach((el) => body.appendChild(el));
        optionalContainer.querySelector('.collapsible-header').addEventListener('click', () => {
          const isHidden = body.classList.contains('hidden');
          body.classList.toggle('hidden', !isHidden);
          optionalContainer.querySelector('.chevron').textContent = isHidden ? 'â–´' : 'â–¾';
        });
        quickForm.appendChild(optionalContainer);
      }
      quickModal.style.display = "flex";
    }

    function closeQuickModal() {
      quickModal.style.display = "none";
      currentQuickTemplateId = null;
    }
    quickModalClose?.addEventListener('click', closeQuickModal);
    quickModalCancel?.addEventListener('click', closeQuickModal);
    quickModal?.addEventListener('click', (e) => {
      if (e.target === quickModal) closeQuickModal();
    });

    quickModalSave?.addEventListener('click', () => {
      if (!currentQuickTemplateId) return closeQuickModal();
      const tpl = quickTemplates.find((t) => t.id === currentQuickTemplateId);
      if (!tpl) return closeQuickModal();
      const record = { status: "Draft" };
      let valid = true;
      const errors = [];
      tpl.fields.forEach((f) => {
        const el = quickForm.querySelector(`[data-key="${f.key}"]`);
        if (!el) return;
        const value = el.value.trim();
        if (f.required && !value) {
          valid = false;
          errors.push(`${f.label} ã¯å¿…é ˆã§ã™`);
        }
        if (value) record[f.key] = value;
      });
      if (!valid) {
        alert(errors.join("\n"));
        return;
      }
      if (!contentStore[tpl.id]) contentStore[tpl.id] = [];
      contentStore[tpl.id].push(record);
      currentModelId = tpl.id;
      renderModelList();
      renderContentModelList();
      renderContentTable();
      updateActionsVisibility();
      switchView('content');
      closeQuickModal();
    });

    function renderContentModelList() {
      if (!contentModelList) return;
      contentModelList.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const row = document.createElement('div');
        row.className = 'item';
        if (id === currentModelId) row.classList.add('active');
        row.textContent = modelStore[id].label;
        row.addEventListener('click', () => {
          currentModelId = id;
          renderContentModelList();
          renderContentTable();
          renderModelList();
          renderGroups();
          sendJoin(currentModelId);
        });
        contentModelList.appendChild(row);
      });
    }

    const updatedCells = [];

    function renderContentTable() {
      if (!contentTable) return;
      const thead = contentTable.querySelector('thead');
      const tbody = contentTable.querySelector('tbody');
      thead.innerHTML = "";
      tbody.innerHTML = "";
      const fields = currentFields().slice(0, 6); // show first few columns
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th><input type="checkbox" id="content-select-all"></th><th>Status</th>${fields.map((f) => `<th>${f.label}</th>`).join("")}`;
      thead.appendChild(headerRow);

      const items = (contentStore[currentModelId] || []).filter((item) => {
        const q = (contentSearch?.value || "").toLowerCase();
        if (!q) return true;
        return Object.values(item).some((v) => (v || "").toString().toLowerCase().includes(q));
      });

      items.forEach((item, rowIdx) => {
        const tr = document.createElement('tr');
        tr.dataset.row = rowIdx;
        tr.innerHTML = `
          <td><input type="checkbox" class="content-select-row" data-row="${rowIdx}"></td>
          <td><span class="status-dot"><span class="dot ${item.status === "Published" ? "published" : "draft"}"></span>
            <select class="inline-input" data-row="${rowIdx}" data-key="status">
              <option value="Published" ${item.status === "Published" ? "selected" : ""}>Published</option>
              <option value="Draft" ${item.status !== "Published" ? "selected" : ""}>Draft</option>
            </select>
          </span></td>
          ${fields.map((f) => `<td class="cell-editable" style="position:relative; overflow:visible;">
              <input class="inline-input" data-row="${rowIdx}" data-key="${f.key}" value="${item[f.key] || ""}">
              <div class="tooltip"></div>
            </td>`).join("")}
        `;
        tbody.appendChild(tr);
      });

      const tplKey = (templateList.find((t)=>t.id===currentModelId)?.key) || currentModelId;
      contentModelLabel.textContent = `${modelStore[currentModelId].label} / #${tplKey}`;
      applyUpdatedHighlights();
    }

    function openItemModal() {
      itemForm.innerHTML = "";
      itemModalTitle.textContent = modelStore[currentModelId].label;
      const intro = document.createElement('div');
      intro.className = 'muted';
      intro.style.fontSize = '12px';
      intro.textContent = 'å¿…é ˆé …ç›®ã ã‘å…¥åŠ›ã™ã‚Œã°ä½œæˆã§ãã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¾Œã§ç·¨é›†ã§ãã¾ã™ã€‚';
      itemForm.appendChild(intro);

      const requiredBlocks = [];
      const optionalBlocks = [];

      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-section';
        wrapper.innerHTML = `
          <label>${meta.display || f.label} ${meta.required ? '<span class="badge required">â—</span>' : ''}</label>
          ${renderInputForField(f, meta)}
        `;
        if (meta.required) {
          requiredBlocks.push(wrapper);
        } else {
          optionalBlocks.push(wrapper);
        }
      });
      const requiredContainer = document.createElement('div');
      requiredContainer.className = 'modal-section';
      requiredBlocks.forEach((el) => requiredContainer.appendChild(el));
      itemForm.appendChild(requiredContainer);

      if (optionalBlocks.length) {
        const optionalContainer = document.createElement('div');
        optionalContainer.className = 'collapsible';
        optionalContainer.innerHTML = `
          <div class="collapsible-header" id="optional-toggle">
            <div>
              <strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›® (${optionalBlocks.length})</strong>
              <div class="muted" style="font-size:12px;">å¾Œã§ç·¨é›†ã§ãã¾ã™</div>
            </div>
            <span class="chevron">â–¾</span>
          </div>
          <div class="collapsible-body hidden" id="optional-body"></div>
        `;
        const body = optionalContainer.querySelector('#optional-body');
        optionalBlocks.forEach((el) => body.appendChild(el));
        optionalContainer.querySelector('#optional-toggle').addEventListener('click', () => {
          const isHidden = body.classList.contains('hidden');
          body.classList.toggle('hidden', !isHidden);
          optionalContainer.querySelector('.chevron').textContent = isHidden ? 'â–´' : 'â–¾';
        });
        itemForm.appendChild(optionalContainer);
      }
      itemModal.style.display = "flex";
    }

    function renderInputForField(f, meta) {
      if (f.type === "Option" && meta.options?.length) {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${meta.options.map((opt) => `<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
      }
      if (f.type === "Int") {
        return `<input class="input" type="number" step="1" data-key="${meta.key}">`;
      }
      if (f.type === "Float") {
        return `<input class="input" type="number" step="any" data-key="${meta.key}">`;
      }
      if (f.type === "Boolean") {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        `;
      }
      if (f.type === "Date") {
        return `<input class="input" type="date" data-key="${meta.key}">`;
      }
      if (f.type === "Coordinate") {
        return `
          <div class="row" style="gap:8px;">
            <input class="input" type="text" placeholder="lat" data-key="${meta.key}-lat">
            <input class="input" type="text" placeholder="lng" data-key="${meta.key}-lng">
          </div>
        `;
      }
      return `<input class="input" type="text" data-key="${meta.key}" placeholder="${meta.pattern ? meta.pattern : ''}">`;
    }

    function closeItemModal() {
      itemModal.style.display = "none";
    }
    itemModalClose.addEventListener('click', closeItemModal);
    itemModalCancel.addEventListener('click', closeItemModal);
    itemModal.addEventListener('click', (e) => {
      if (e.target === itemModal) closeItemModal();
    });
    newItemBtn?.addEventListener('click', openItemModal);
    contentActionsBtn?.addEventListener('click', () => {
      contentActionsMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!contentActionsMenu.contains(e.target) && e.target !== contentActionsBtn) {
        contentActionsMenu.classList.remove('active');
      }
    });

    itemModalSave.addEventListener('click', () => {
      const inputs = itemForm.querySelectorAll('[data-key]');
      const record = { status: "Draft" };
      let valid = true;
      const errors = [];
      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        if (f.type === "Coordinate") {
          const lat = itemForm.querySelector(`[data-key="${meta.key}-lat"]`)?.value.trim();
          const lng = itemForm.querySelector(`[data-key="${meta.key}-lng"]`)?.value.trim();
          if (meta.required && (!lat || !lng)) {
            valid = false; errors.push(`${meta.display} ã¯å¿…é ˆ`);
          }
          if (lat && lng) record[meta.key] = `${lat}, ${lng}`;
          return;
        }
        const el = itemForm.querySelector(`[data-key="${meta.key}"]`);
        if (!el) return;
        const value = el.value.trim();
        if (meta.required && !value) {
          valid = false; errors.push(`${meta.display} ã¯å¿…é ˆ`);
        }
        if (meta.pattern && value && !(new RegExp(meta.pattern).test(value))) {
          valid = false; errors.push(`${meta.display} ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“`);
        }
        record[meta.key] = value;
      });
      if (!valid) {
        alert(errors.join("\n"));
        return;
      }
      if (!contentStore[currentModelId]) contentStore[currentModelId] = [];
      contentStore[currentModelId].push(record);
      renderContentTable();
      sendPatch(currentModelId, contentStore[currentModelId]);
      updateActionsVisibility();
      closeItemModal();
    });

    contentSearch?.addEventListener('input', renderContentTable);

    // Inline edit handlers
    contentTable?.addEventListener('focusin', (e) => {
      const rowIdx = e.target.dataset.row;
      const key = e.target.dataset.key;
      if (rowIdx !== undefined) {
        highlightRow(rowIdx);
        e.target.dataset.prev = e.target.value;
      }
      if (key) {
        e.target.classList.remove('cell-error');
        const tooltip = e.target.parentElement.querySelector('.tooltip');
        if (tooltip) tooltip.style.display = 'none';
      }
    });

    function validateCell(key, value, meta) {
      if (key === 'status') return { ok: true };
      if (meta?.required && !value) return { ok: false, reason: 'å¿…é ˆã§ã™' };
      let pattern = meta?.pattern;
      let hint = "";
      if (key === 'identifier') {
        pattern = '^\\d+$'; // ID must be digits
        hint = "æ•°å­—ã®ã¿ã€ç©ºæ¬„ä¸å¯";
      } else if (pattern) {
        hint = `Pattern: ${pattern}`;
      }
      if (pattern && value && !(new RegExp(pattern).test(value))) {
        return { ok: false, reason: hint || 'å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
      }
      return { ok: true };
    }

    function getMetaByKey(key) {
      const idx = currentMeta().findIndex((m) => m.key === key);
      return idx >= 0 ? currentMeta()[idx] : null;
    }

    contentTable?.addEventListener('focusout', (e) => {
      const rowIdx = e.target.dataset.row;
      const key = e.target.dataset.key;
      if (rowIdx === undefined || !key) return;
      const meta = getMetaByKey(key);
      const value = e.target.value.trim();
      const validation = validateCell(key, value, meta);
      if (!validation.ok) {
        e.target.classList.add('cell-error');
        const tooltip = e.target.parentElement.querySelector('.tooltip');
        if (tooltip) {
          tooltip.textContent = validation.reason || 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼';
          tooltip.style.display = 'block';
        }
        // keep user input (do not revert), just block save/broadcast
        return;
      }
      e.target.classList.remove('cell-error');
      const tooltip = e.target.parentElement.querySelector('.tooltip');
      if (tooltip) tooltip.style.display = 'none';
      const record = (contentStore[currentModelId] || [])[rowIdx];
      if (!record) return;
      const oldValue = record[key];
      record[key] = value;
      markCellUpdated(rowIdx, key);
      sendPatch(currentModelId, [{ rowId: Number(rowIdx), key, oldValue, newValue: value, ts: Date.now(), user: currentUser }]);
      // keep highlight if checkbox or focused; remove if neither
      const checkbox = contentTable.querySelector(`.content-select-row[data-row="${rowIdx}"]`);
      if (!(checkbox && checkbox.checked)) {
        unhighlightRow(rowIdx);
      }
    });

    contentTable?.addEventListener('input', (e) => {
      if (e.target.classList.contains('content-select-row')) {
        updateActionsVisibility();
        if (e.target.checked) {
          highlightRow(e.target.dataset.row);
        } else {
          unhighlightRow(e.target.dataset.row);
        }
      }
      if (e.target.id === 'content-select-all') {
        updateActionsVisibility();
        document.querySelectorAll('.content-select-row').forEach((c) => {
          if (c.checked) highlightRow(c.dataset.row); else unhighlightRow(c.dataset.row);
        });
      }
    });
    contentTable?.addEventListener('change', (e) => {
      if (e.target.id === 'content-select-all') {
        const checked = e.target.checked;
        document.querySelectorAll('.content-select-row').forEach((c) => (c.checked = checked));
        updateActionsVisibility();
      }
    });

    contentActionsMenu?.addEventListener('click', (e) => {
      const action = e.target.dataset.action;
      if (!action) return;
      const selected = Array.from(document.querySelectorAll('.content-select-row'))
        .filter((c) => c.checked)
        .map((c) => Number(c.dataset.row));
      const items = contentStore[currentModelId] || [];
      if (action === 'delete-selected') {
        contentStore[currentModelId] = items.filter((_, idx) => !selected.includes(idx));
      }
      if (action === 'publish-selected') {
        selected.forEach((idx) => { if (items[idx]) items[idx].status = "Published"; });
      }
      if (action === 'draft-selected') {
        selected.forEach((idx) => { if (items[idx]) items[idx].status = "Draft"; });
      }
      if (action === 'sort-asc' || action === 'sort-desc') {
        const key = currentFields()[0]?.key;
        if (key) {
          items.sort((a, b) => {
            const av = (a[key] || "").toString();
            const bv = (b[key] || "").toString();
            return action === 'sort-asc' ? av.localeCompare(bv, "ja") : bv.localeCompare(av, "ja");
          });
        }
      }
      renderContentTable();
      const edits = [];
      selected.forEach((idx) => {
        if (!items[idx]) return;
        edits.push({ rowId: idx, key: "status", oldValue: items[idx].status, newValue: items[idx].status, ts: Date.now(), user: currentUser });
      });
      sendPatch(currentModelId, edits);
      contentActionsMenu.classList.remove('active');
    });

    function updateActionsVisibility() {
      if (!contentActionsWrap) return;
      const anySelected = document.querySelector('.content-select-row:checked');
      contentActionsWrap.style.display = anySelected ? 'inline-block' : 'none';
    }

    function highlightRow(rowIdx) {
      const row = contentTable?.querySelector(`tr[data-row="${rowIdx}"]`);
      if (row) row.classList.add('active-row');
    }
    function unhighlightRow(rowIdx) {
      const row = contentTable?.querySelector(`tr[data-row="${rowIdx}"]`);
      if (row) row.classList.remove('active-row');
    }

    function markCellUpdated(rowIdx, key) {
      updatedCells.push({ rowIdx, key, ts: Date.now() });
    }

    function applyUpdatedHighlights() {
      if (!contentTable) return;
      updatedCells.splice(0).forEach(({ rowIdx, key }) => {
        const input = contentTable.querySelector(`input[data-row="${rowIdx}"][data-key="${key}"]`);
        if (input) {
          input.classList.add('cell-updated');
          setTimeout(() => input.classList.remove('cell-updated'), 1200);
        }
      });
    }

    function toggleTplMenu(id) {
      const menu = document.querySelector(`.tpl-menu[data-id="${id}"]`);
      if (!menu) return;
      menu.classList.toggle('active');
    }
    function closeAllTplMenus() {
      document.querySelectorAll('.tpl-menu').forEach((m) => m.classList.remove('active'));
    }

    // WebSocket sync (optional)
    let ws;
    function initWS() {
      try {
        ws = new WebSocket("ws://localhost:7070");
      } catch (e) {
        console.warn("WS not available");
        return;
      }
      ws.addEventListener("open", () => {
        sendJoin(currentModelId);
      });
      ws.addEventListener("message", (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === "snapshot" && msg.modelId === currentModelId) {
            contentStore[msg.modelId] = msg.items || contentStore[msg.modelId] || [];
            renderContentTable();
          }
          if (msg.type === "patch" && msg.modelId === currentModelId) {
            if (!contentStore[msg.modelId]) contentStore[msg.modelId] = [];
            msg.edits?.forEach((edit) => {
              if (!contentStore[msg.modelId][edit.rowId]) contentStore[msg.modelId][edit.rowId] = {};
              contentStore[msg.modelId][edit.rowId][edit.key] = edit.newValue;
              markCellUpdated(edit.rowId, edit.key);
            });
            renderContentTable();
          }
        } catch (_) {}
      });
      ws.addEventListener("close", () => {
        setTimeout(initWS, 2000);
      });
    }
    function sendPatch(modelId, edits) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "patch", modelId, edits, user: currentUser }));
    }
    function sendJoin(modelId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "join", modelId, user: currentUser }));
    }

    renderModelList();
    renderGroups();
    renderFields();
    renderPalette();
    renderTemplates();
    renderContentModelList();
    renderContentTable();
    renderQuickCards();
    initWS();
    updateActionsVisibility();

    // Restore last view
    const lastView = (() => {
      try {
        return localStorage.getItem('ace_last_view') || 'models';
      } catch (_) {
        return 'models';
      }
    })();
    switchView(lastView);
  </script>
</body>
</html>
