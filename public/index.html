<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ACE CMS Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f6f8;
      --surface: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #1677ff;
      --accent-soft: #e7f0ff;
      --topbar: #1f1f1f;
      --shadow: 0 8px 22px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter","Noto Sans JP",system-ui,-apple-system,sans-serif;
      background: var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }
    .topbar {
      height: 48px;
      background: var(--topbar);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      font-weight: 600;
    }
    .crumb { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .user-dot {
      width: 28px; height: 28px; border-radius: 50%;
      background: #374151; color: #f9fafb; display: grid; place-items: center;
      font-weight: 700; font-size: 13px;
    }
    .shell {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: calc(100vh - 48px);
    }
    aside.nav {
      background: #f9fafb;
      border-right: 1px solid var(--border);
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .brand { display: flex; align-items: center; gap: 8px; font-weight: 700; padding: 10px; border-radius: 8px; }
    .brand-icon { width: 22px; height: 22px; border-radius: 6px; background: linear-gradient(135deg, #111827, #2563eb); }
    .nav-list { display: grid; gap: 4px; }
    .nav-list button {
      all: unset; cursor: pointer; display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px; font-weight: 500; color: #374151;
    }
    .nav-list button.active { background: #e6f0ff; color: #0f4bb8; }
    .workspace { padding: 16px 18px; }
    .hidden { display: none !important; }
    /* Models page */
    .header-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    h2 { margin: 0; font-size: 18px; letter-spacing: -0.01em; }
    p { margin: 0; color: var(--muted); }
    input, select {
      font: inherit; padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #fff; color: var(--ink);
    }
    .btn {
      all: unset;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 600;
      color: var(--ink);
      font-size: 13px;
      line-height: 1.2;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.icon-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      display: grid;
      place-items: center;
      font-size: 16px;
      line-height: 1;
    }
    .cards { margin-top: 14px; display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .card {
      background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 14px;
      display: grid; gap: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.03);
      position: relative;
    }
    .card h3 { margin: 0; font-size: 15px; }
    .muted { color: var(--muted); font-size: 13px; }
    .card footer { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; }
    .icon-row { display: flex; gap: 10px; }
    .icon { width: 16px; height: 16px; border: 1px solid var(--border); border-radius: 4px; display: grid; place-items: center; color: #6b7280; font-size: 11px; }
    .badge {
      padding: 4px 8px; background: #e7f0ff; color: #0f4bb8; border-radius: 999px;
      font-size: 11px; font-weight: 700;
    }
    .dropdown { position: relative; }
    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 110%;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.08);
      min-width: 200px;
      display: none;
      z-index: 10;
    }
    .dropdown-menu.active { display: block; }
    .dropdown-menu button {
      all: unset;
      display: block;
      width: 100%;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--ink);
      font-size: 13px;
    }
    .dropdown-menu button:hover { background: #f3f4f6; }
    /* Schema page */
    main.schema { background: var(--surface); }
    .schema-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .tabbar { display: flex; gap: 14px; margin: 10px 0 12px 0; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 0; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; color: #4b5563; }
    .tab.active { color: var(--ink); border-bottom-color: var(--accent); }
    .layout { display: grid; grid-template-columns: 240px 1fr 260px; gap: 16px; align-items: start; }
    .left-list {
      border: 1px solid var(--border); border-radius: 12px; background: #fdfdfd; padding: 14px;
      height: calc(100vh - 160px); overflow: auto;
    }
    .section-title { font-weight: 700; font-size: 12px; color: #6b7280; margin: 12px 0 8px; }
    .item { padding: 9px 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .item.active { background: #e6f0ff; color: #0f4bb8; }
    .group-row { border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; margin: 6px 0; background: #fff; }
    .group-row .muted { font-size: 12px; }
    .field-list {
      border: 1px solid var(--border); border-radius: 12px; background: #fff; box-shadow: var(--shadow);
      min-height: 400px; padding: 10px;
    }
    .field-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: grid;
      gap: 6px;
      margin: 8px 0;
      background: #fff;
      transition: transform 140ms ease, margin 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      cursor: pointer;
    }
    .field-card.drop-target { border-color: #2563eb; background: #f0f7ff; }
    .field-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .badge.required {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .badge.validation {
      background: #f3f4f6;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .field-placeholder {
      border: 1px dashed #2563eb;
      border-radius: 10px;
      height: 54px;
      margin: 8px 0;
      background: #f8fbff;
      transition: all 140ms ease;
    }
    /* Content page */
    .content-layout { display: grid; grid-template-columns: 220px 1fr; gap: 16px; }
    .content-sidebar {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fdfdfd;
      padding: 12px;
    }
    .content-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .content-table th, .content-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      text-align: left;
      font-size: 13px;
    }
    .content-table tr:last-child td { border-bottom: none; }
    .status-dot { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.published { background: #16a34a; }
    .dot.draft { background: #f59e0b; }
    .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
    .cell-editable { background: #fff; }
    .inline-input {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 6px 8px;
      background: #fff;
      font: inherit;
      font-size: 13px;
    }
    .inline-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.15);
    }
    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.18);
      padding: 16px 18px 18px;
      display: grid;
      gap: 12px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-tabs { display: flex; gap: 12px; border-bottom: 1px solid var(--border); margin: 0 -6px; padding: 0 6px; }
    .modal-tab {
      padding: 10px 6px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      color: #4b5563;
    }
    .modal-tab.active { color: var(--ink); border-bottom-color: var(--accent); }
    .modal-body { display: grid; gap: 10px; }
    .modal-section { display: grid; gap: 8px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 6px; }
    .pill-switch { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #374151; }
    .pill-switch input { width: 16px; height: 16px; }
    textarea { resize: vertical; min-height: 60px; }
    .field-top { display: flex; align-items: center; justify-content: space-between; }
    .field-meta { display: flex; align-items: center; gap: 10px; color: #6b7280; font-size: 12px; }
    .drag-handle { width: 14px; height: 14px; border: 1px solid var(--border); border-radius: 4px; display: grid; place-items: center; font-size: 11px; color: #6b7280; cursor: grab; }
    .field-type { padding: 2px 6px; border-radius: 999px; background: var(--accent-soft); color: #0f4bb8; font-size: 11px; font-weight: 700; }
    .palette {
      background: #fbfcfd;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      height: 100%;
      overflow: auto;
    }
    .palette-title { font-weight: 700; margin: 0 0 8px 0; }
    .palette-group { margin-bottom: 16px; }
    .palette-item {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fff;
      display: grid; gap: 4px; margin: 6px 0; cursor: grab; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }
    .palette-item:hover { border-color: var(--accent); }
    .palette-item strong { font-size: 13px; }
    .palette-item span { color: var(--muted); font-size: 12px; }
    .drop-hint {
      text-align: center; color: #9ca3af; font-size: 13px; padding: 12px 0;
      border: 1px dashed var(--border); border-radius: 10px; margin: 10px 0;
    }
    @media (max-width: 1200px) {
      .shell { grid-template-columns: 220px 1fr; }
      .layout { grid-template-columns: 240px 1fr; }
      .palette { display: none; }
    }
    @media (max-width: 900px) {
      .shell { grid-template-columns: 1fr; }
      aside.nav { flex-direction: row; overflow-x: auto; }
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="crumb">
      <span>Re:Earth CMS</span>
      <span style="opacity:0.7;">/</span>
      <span id="crumb-title">Models</span>
    </div>
    <div class="user-dot">M</div>
  </div>

  <div class="shell">
    <aside class="nav">
      <div class="brand">
        <div class="brand-icon"></div>
        ACE CMS
      </div>
      <div class="nav-list">
        <button data-view="templates">ğŸ§­ Templates</button>
        <button class="active" data-view="models">ğŸ“¦ Models</button>
        <button data-view="schema">ğŸ§© Schema</button>
        <button data-view="content">ğŸ—‚ï¸ Content</button>
        <button>ğŸ—„ï¸ Asset</button>
        <button>ğŸ“¨ Request</button>
      </div>
    </aside>

    <div id="models-view" class="workspace">
      <div class="header-row">
        <div>
          <h2>Models</h2>
          <p>æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’ç®¡ç†</p>
        </div>
        <div class="header-row" style="margin-left:auto;">
          <input placeholder="search models" style="width:200px;">
          <select>
            <option>Sort by updatedAt</option>
            <option>Sort by name</option>
            <option>Sort by createdAt</option>
          </select>
          <div class="dropdown">
            <button id="new-model-btn" class="btn primary">+ New Model</button>
            <div id="new-model-menu" class="dropdown-menu">
              <button data-action="blank">ç©ºç™½ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ</button>
              <button data-action="template">æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆ</button>
            </div>
          </div>
        </div>
      </div>
      <div class="cards">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>å…¬å…±æ–½è¨­ä¸€è¦§</h3><span class="badge">Template</span>
          </div>
          <div class="muted">#public_facility</div>
          <footer>
            <div class="icon-row">
              <div class="icon">â‰¡</div><div class="icon">â–¦</div><div class="icon">â†“</div><div class="icon">â‹¯</div>
            </div>
          </footer>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>AEDè¨­ç½®ç®‡æ‰€ä¸€è¦§</h3><span class="badge">Template</span>
          </div>
          <div class="muted">#aed_location</div>
          <footer>
            <div class="icon-row">
              <div class="icon">â‰¡</div><div class="icon">â–¦</div><div class="icon">â†“</div><div class="icon">â‹¯</div>
            </div>
          </footer>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>æ–°è¦ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«</h3><span class="badge" style="background:#eef2ff;color:#4338ca;">Custom</span>
          </div>
          <div class="muted">è‡ªç”±ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®šç¾©</div>
          <button class="btn primary" style="justify-self:start;">Start</button>
        </div>
      </div>
    </div>

    <div id="schema-wrapper" class="schema hidden">
      <main class="schema workspace">
        <div class="schema-header">
          <h2>å…¬å…±æ–½è¨­ä¸€è¦§</h2>
          <span class="muted">#public_facility</span>
      </div>
        <div class="tabbar">
          <div class="tab active">Fields</div>
          <div class="tab">Meta Data</div>
        </div>

        <div class="layout">
        <div class="left-list">
            <div class="section-title">MODELS <span style="float:right; color:#2563eb; cursor:pointer;">+ Add</span></div>
            <div id="model-list"></div>
            <div class="section-title">GROUPS</div>
            <div id="group-list"></div>
          </div>

          <div>
            <div id="field-list" class="field-list"></div>
          </div>
          <div class="palette">
            <h3 class="palette-title">Add Field</h3>
            <div id="palette"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="templates-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Templates</h2>
          <p>æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
        </div>
      </div>
      <div class="cards" id="templates-cards"></div>
    </div>

    <div id="content-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Content</h2>
          <p id="content-model-label">Select a model to view items</p>
        </div>
        <button id="new-item-btn" class="btn primary">+ New Item</button>
      </div>
      <div class="content-layout">
        <div class="content-sidebar">
          <div class="section-title">MODELS</div>
          <div id="content-model-list"></div>
        </div>
        <div>
          <div class="row" style="gap:8px; margin-bottom:8px;">
            <input id="content-search" class="input" placeholder="search text" style="max-width:220px;">
          </div>
          <div style="overflow:auto; border-radius:12px;">
            <table class="content-table" id="content-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Field Edit Modal -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Update Field</div>
          <h3 id="modal-title" style="margin:0;">Field</h3>
        </div>
        <button id="modal-close" class="btn">âœ•</button>
      </div>
      <div class="modal-tabs">
        <div class="modal-tab active" data-tab="settings">Settings</div>
        <div class="modal-tab" data-tab="validation">Validation</div>
        <div class="modal-tab" data-tab="default">Default value</div>
      </div>
      <div class="modal-body">
        <div class="modal-section modal-pane" data-pane="settings">
          <div>
            <label>Display name</label>
            <input id="field-display" placeholder="è¡¨ç¤ºå">
          </div>
          <div>
            <label>Field Key</label>
            <input id="field-key" placeholder="field_key">
            <div class="muted" style="font-size:12px;">åŠè§’è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³/ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿</div>
          </div>
          <div>
            <label>Description <span class="muted">(optional)</span></label>
            <textarea id="field-desc" maxlength="1000" placeholder="èª¬æ˜æ–‡"></textarea>
          </div>
          <div id="field-options-section" class="modal-section" style="display:none;">
            <label>Options (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
            <input id="field-options" placeholder="yes,no,unknown">
            <div class="pill-switch"><input type="checkbox" id="field-multi"> <label for="field-multi">Support multiple values</label></div>
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="validation">
          <div class="pill-switch"><input type="checkbox" id="field-required"> <label for="field-required">Required (â—)</label></div>
          <div id="field-pattern-section" style="display:none;">
            <label>Pattern (regex)</label>
            <input id="field-pattern" placeholder="ä¾‹: ^[0-9]{6}$">
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="default">
          <div>
            <label>Default value</label>
            <input id="field-default" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn">Cancel</button>
        <button id="modal-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Template Selection Modal -->
  <div id="template-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 860px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">æ¨™æº–ãƒ¢ãƒ‡ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é¸æŠ</div>
          <h3 style="margin:0;">Templates</h3>
        </div>
        <button id="template-modal-close" class="btn">âœ•</button>
      </div>
      <div class="row" style="gap:8px;">
        <input id="template-search" placeholder="æ¤œç´¢ (ä¾‹: AED, å…¬å…±æ–½è¨­, ã‚¤ãƒ™ãƒ³ãƒˆ)" style="flex:1;">
        <select id="template-filter" style="width:180px;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="facility">æ–½è¨­</option>
          <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="emergency">é˜²ç½</option>
        </select>
      </div>
      <div id="template-modal-cards" class="cards" style="margin-top:12px; max-height:60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="template-modal-cancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Template Edit Modal -->
  <div id="template-edit-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 540px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†</div>
          <h3 id="template-edit-title" style="margin:0;">Template</h3>
        </div>
        <button id="template-edit-close" class="btn">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <label>åç§°</label>
          <input id="tpl-edit-label" placeholder="å…¬å…±æ–½è¨­ä¸€è¦§">
        </div>
        <div class="modal-section">
          <label>Model Key</label>
          <input id="tpl-edit-key" placeholder="public_facility">
        </div>
        <div class="modal-section">
          <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
          <input id="tpl-edit-version" placeholder="v3.0">
        </div>
        <div class="modal-section">
          <label>åˆ†é¡</label>
          <input id="tpl-edit-category" placeholder="facility / emergency / event">
        </div>
        <div class="modal-section">
          <label>æ¦‚è¦</label>
          <textarea id="tpl-edit-summary" placeholder="æ¦‚è¦ã‚’å…¥åŠ›"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button id="tpl-edit-cancel" class="btn">Cancel</button>
        <button id="tpl-edit-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="item-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">New Item</div>
          <h3 id="item-modal-title" style="margin:0;">Item</h3>
        </div>
        <button id="item-modal-close" class="btn">âœ•</button>
      </div>
      <div id="item-form" class="modal-body" style="max-height: 60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="item-modal-cancel" class="btn">Cancel</button>
        <button id="item-modal-save" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    // View switcher with persistence
    const navButtons = document.querySelectorAll('.nav-list button[data-view]');
    const crumbTitle = document.getElementById('crumb-title');
    const modelsView = document.getElementById('models-view');
    const schemaWrapper = document.getElementById('schema-wrapper');
    const templatesView = document.getElementById('templates-view');
    const contentView = document.getElementById('content-view');

    function switchView(target) {
      const viewMap = {
        models: modelsView,
        schema: schemaWrapper,
        templates: templatesView,
        content: contentView,
      };
      Object.values(viewMap).forEach((el) => el.classList.add('hidden'));
      if (viewMap[target]) viewMap[target].classList.remove('hidden');
      navButtons.forEach((b) => b.classList.toggle('active', b.dataset.view === target));
      crumbTitle.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      try {
        localStorage.setItem('ace_last_view', target);
      } catch (_) {}
      if (target === 'content') {
        renderContentModelList();
        renderContentTable();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        switchView(target);
      });
    });

    // Schema drag/drop
    const fieldListEl = document.getElementById('field-list');
    const paletteEl = document.getElementById('palette');

    const initialFields = [
      { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
      { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
      { label: "åç§° (Name)", key: "name", type: "Text" },
      { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
      { label: "é€£çµ¡å…ˆ (Contact)", key: "contact", type: "Text" },
      { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
    ];

    const childcareFields = [
      { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
      { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
      { label: "æ–½è¨­å", key: "facilityName", type: "Text" },
      { label: "æ–½è¨­ç¨®åˆ¥", key: "facilityCategory", type: "Option", meta: "ä¿è‚²æ‰€,å¹¼ç¨šåœ’,èªå®šã“ã©ã‚‚åœ’,å­¦ç«¥,ãã®ä»–" },
      { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
      { label: "é›»è©±ç•ªå·", key: "phone", type: "Text" },
      { label: "é–‹æ‰€æ™‚é–“", key: "openingHours", type: "Text" },
      { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
    ];

    const paletteGroups = [
      { title: "Text", items: [
        { label: "Text", desc: "å˜è¡Œãƒ†ã‚­ã‚¹ãƒˆ", type: "Text" },
        { label: "TextArea", desc: "è¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆ", type: "TextArea" },
        { label: "Markdown", desc: "ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ", type: "Markdown" }
      ]},
      { title: "Asset", items: [
        { label: "Asset", desc: "ãƒ•ã‚¡ã‚¤ãƒ« / 3D Tiles / CityGML", type: "Asset" }
      ]},
      { title: "Time", items: [
        { label: "Date", desc: "Date picker", type: "Date" }
      ]},
      { title: "Boolean", items: [
        { label: "Boolean", desc: "true/false", type: "Boolean" }
      ]},
      { title: "Select", items: [
        { label: "Option", desc: "çµ±åˆ¶èªå½™ / Enum", type: "Option" }
      ]},
      { title: "Number", items: [
        { label: "Int", desc: "Integer", type: "Int" },
        { label: "Float", desc: "Fractional", type: "Float" }
      ]},
      { title: "Geo", items: [
        { label: "Coordinate", desc: "ç·¯åº¦ãƒ»çµŒåº¦ (GIF)", type: "Coordinate" }
      ]}
    ];

    const modelStore = {
      "public-facilities": {
        label: "å…¬å…±æ–½è¨­ä¸€è¦§",
        fields: [...initialFields],
        meta: initialFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","name","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6æ¡") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "é€£çµ¡å…ˆ", "ä½ç½®æƒ…å ±", "æ›´æ–°æƒ…å ±"]
      },
      "childcare-facilities": {
        label: "å­è‚²ã¦æ–½è¨­ä¸€è¦§",
        fields: [...childcareFields],
        meta: childcareFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","facilityName","facilityCategory","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: f.type === "Option" && f.meta ? f.meta.split(",") : [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6æ¡") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "ã‚µãƒ¼ãƒ“ã‚¹", "æ™‚é–“", "ãƒ¡ãƒ‡ã‚£ã‚¢"]
      },
      "aed-locations": {
        label: "AEDè¨­ç½®ç®‡æ‰€ä¸€è¦§",
        fields: [
          { label: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", type: "Text", meta: "åŠè§’æ•°å­—6æ¡" },
          { label: "ID", key: "identifier", type: "Text", meta: "åŠè§’è‹±æ•°å­—" },
          { label: "è¨­ç½®å ´æ‰€åç§°", key: "name", type: "Text" },
          { label: "è¨­ç½®å ´æ‰€è©³ç´°", key: "installationPlace", type: "Text" },
          { label: "å°å…å¯¾å¿œè¨­å‚™ã®æœ‰ç„¡", key: "pediatricSupport", type: "Option", meta: "yes,no" },
          { label: "æ‰€åœ¨åœ° (Address)", key: "address", type: "Text" },
          { label: "å•ã„åˆã‚ã›å…ˆé›»è©±ç•ªå·", key: "contactPhone", type: "Text" },
          { label: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
          { label: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", type: "Date" }
        ],
        meta: [
          { display: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰", key: "localGovernmentCode", description: "", required: true, options: [], allowMultiple: false, pattern: "^[0-9]{6}$", defaultValue: "" },
          { display: "ID", key: "identifier", description: "", required: true, options: [], allowMultiple: false, pattern: "^[A-Za-z0-9_-]+$", defaultValue: "" },
          { display: "è¨­ç½®å ´æ‰€åç§°", key: "name", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "è¨­ç½®å ´æ‰€è©³ç´°", key: "installationPlace", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "å°å…å¯¾å¿œè¨­å‚™ã®æœ‰ç„¡", key: "pediatricSupport", description: "", required: true, options: ["yes","no"], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "æ‰€åœ¨åœ° (Address)", key: "address", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "å•ã„åˆã‚ã›å…ˆé›»è©±ç•ªå·", key: "contactPhone", description: "", required: false, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "ç·¯åº¦ / çµŒåº¦", key: "latitudeLongitude", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæœ€çµ‚æ›´æ–°æ—¥", key: "datasetUpdatedAt", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" }
        ],
        groups: ["åŸºæœ¬æƒ…å ±", "æ‰€åœ¨åœ° (Address)", "è¨­å‚™", "ä½ç½®æƒ…å ±", "æ›´æ–°æƒ…å ±"]
      }
    };
    const templateList = [
      { id: "public-facilities", label: "å…¬å…±æ–½è¨­ä¸€è¦§", key: "public_facility", version: "v3.0", category: "facility", summary: "åœ°æ–¹å…¬å…±å›£ä½“ãŒç®¡ç†ã™ã‚‹å…¬å…±æ–½è¨­ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿" },
      { id: "aed-locations", label: "AEDè¨­ç½®ç®‡æ‰€ä¸€è¦§", key: "aed_location", version: "v2.1", category: "emergency", summary: "AEDè¨­ç½®å ´æ‰€ã¨å¯¾å¿œå¯å¦ã‚’å«ã‚€ç·Šæ€¥åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿" },
      { id: "childcare-facilities", label: "å­è‚²ã¦æ–½è¨­ä¸€è¦§", key: "childcare_facility", version: "v1.4", category: "facility", summary: "ä¿è‚²ãƒ»å¹¼ç¨šåœ’ãƒ»å­¦ç«¥æ–½è¨­ã®ä¸€è¦§ã¨è¨­å‚™æƒ…å ±" }
    ];
    const contentStore = {
      "public-facilities": [
        { status: "Published", localGovernmentCode: "352080", identifier: "1200005", name: "ä¸­å¤®å›³æ›¸é¤¨", address: "å±±å£çœŒå²©å›½å¸‚", latitudeLongitude: "34.1, 132.2" },
        { status: "Draft", localGovernmentCode: "352080", identifier: "1200006", name: "å¸‚æ°‘ãƒ—ãƒ¼ãƒ«", address: "å±±å£çœŒå²©å›½å¸‚", latitudeLongitude: "34.2, 132.3" }
      ],
      "aed-locations": [
        { status: "Published", localGovernmentCode: "131016", identifier: "aed-01", name: "å¸‚å½¹æ‰€ 1F", address: "æ±äº¬éƒ½æ–°å®¿åŒº", pediatricSupport: "yes", latitudeLongitude: "35.6, 139.7" }
      ],
      "childcare-facilities": [
        { status: "Published", localGovernmentCode: "131016", identifier: "cc-01", facilityName: "ã•ãã‚‰ä¿è‚²åœ’", address: "æ±äº¬éƒ½æ‰ä¸¦åŒº", facilityCategory: "ä¿è‚²æ‰€", latitudeLongitude: "35.7, 139.6" }
      ]
    };

    let currentModelId = "public-facilities";

    function currentFields() {
      return modelStore[currentModelId].fields;
    }
    function currentMeta() {
      return modelStore[currentModelId].meta;
    }
    function currentGroups() {
      return modelStore[currentModelId].groups || [];
    }
    const placeholder = document.createElement('div');
    placeholder.className = 'field-placeholder';
    let currentPlaceholderIndex = null;

    function removePlaceholder() {
      if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
      currentPlaceholderIndex = null;
    }

    function placeholderIndex() {
      if (!fieldListEl) return fields.length;
      const children = Array.from(fieldListEl.children);
      let idx = 0;
      for (const child of children) {
        if (child === placeholder) break;
        if (child.classList.contains('field-card')) idx++;
      }
      return idx;
    }

    function showPlaceholderAt(idx) {
      if (idx === currentPlaceholderIndex) return;
      removePlaceholder();
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      if (cards[idx]) {
        fieldListEl.insertBefore(placeholder, cards[idx]);
      } else {
        fieldListEl.appendChild(placeholder);
      }
      currentPlaceholderIndex = idx;
    }

    function calcInsertIndex(clientY) {
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      for (let i = 0; i < cards.length; i++) {
        const rect = cards[i].getBoundingClientRect();
        const upper = rect.top + rect.height * 0.35;
        const lower = rect.bottom - rect.height * 0.35;
        if (clientY < upper) return i;         // top zone: insert before
        if (clientY > lower) continue;         // bottom zone: keep scanning
        return i + 1;                          // middle zone: insert after
      }
      return cards.length;
    }

    function addField(item, index = currentFields().length) {
      const key = `${item.type.toLowerCase()}_${(Date.now()).toString(36).slice(-4)}`;
      const newField = { label: item.label, key, type: item.type, meta: item.desc };
      currentFields().splice(index, 0, newField);
      currentMeta().splice(index, 0, {
        display: item.label,
        key,
        description: "",
        required: false,
        options: [],
        allowMultiple: false,
        pattern: "",
        defaultValue: ""
      });
      renderFields();
      removePlaceholder();
    }

    function renderFields() {
      if (!fieldListEl) return;
      fieldListEl.innerHTML = "";
      currentFields().forEach((f, idx) => {
        const card = document.createElement('div');
        card.className = 'field-card';
        card.dataset.index = idx;
        card.innerHTML = `
          <div class="field-top">
            <div class="field-meta">
              <span class="drag-handle" draggable="true" title="Drag">â‰¡</span>
              <strong>${f.label}</strong>
            </div>
            <span class="field-type">${f.type}</span>
          </div>
          <div class="field-meta">
            <span>#${f.key}</span>
            ${f.meta ? `<span>â€¢ ${f.meta}</span>` : ""}
          </div>
          <div class="field-badges">
            <span class="field-type">${f.type}</span>
            ${currentMeta()[idx].required ? '<span class="badge required">â— Required</span>' : ""}
            ${currentMeta()[idx].pattern ? `<span class="badge validation">Pattern: ${currentMeta()[idx].pattern}</span>` : ""}
          </div>
        `;
        card.addEventListener('click', () => openModal(idx));
        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          card.classList.add('drop-target');
          const insertIdx = calcInsertIndex(e.clientY);
          showPlaceholderAt(insertIdx);
        });
        card.addEventListener('dragleave', () => {
          card.classList.remove('drop-target');
        });
        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drop-target');
          const data = e.dataTransfer.getData('application/json');
          if (!data) return;
          const item = JSON.parse(data);
          const insertIdx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
          addField(item, insertIdx);
        });
        fieldListEl.appendChild(card);
      });
    }

    function renderModelList() {
      const container = document.getElementById('model-list');
      if (!container) return;
      container.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const item = document.createElement('div');
        item.className = 'item';
        if (id === currentModelId) item.classList.add('active');
        item.dataset.model = id;
        item.textContent = modelStore[id].label;
        item.addEventListener('click', () => {
          currentModelId = id;
          renderModelList();
          renderGroups();
          renderFields();
          removePlaceholder();
        });
        container.appendChild(item);
      });
    }

    function renderGroups() {
      const container = document.getElementById('group-list');
      if (!container) return;
      container.innerHTML = "";
      const groups = currentGroups();
      if (groups.length === 0) return;
      const groupMeta = [
        { name: "åŸºæœ¬æƒ…å ± / è­˜åˆ¥å­", key: "Core / ID", examples: "å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰ã€åç§°ã€åç§°_ã‚«ãƒŠ" },
        { name: "æ‰€åœ¨åœ° / GISæƒ…å ±", key: "Location", examples: "æ‰€åœ¨åœ°_é€£çµè¡¨è¨˜ã€ç·¯åº¦ã€çµŒåº¦" },
        { name: "åˆ©ç”¨å¯èƒ½æ—¥æ™‚", key: "Schedule", examples: "åˆ©ç”¨å¯èƒ½æ›œæ—¥ã€é–‹å§‹æ™‚é–“ã€çµ‚äº†æ™‚é–“" },
        { name: "ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£", key: "Accessibility", examples: "è»Šæ¤…å­å¯ã€æˆä¹³å®¤ã€ãŠã‚€ã¤æ›¿ãˆã‚³ãƒ¼ãƒŠãƒ¼" },
        { name: "å‚ç…§ / ãƒ¡ãƒ‡ã‚£ã‚¢", key: "Media", examples: "URLã€ç”»åƒã€ç”»åƒ_ãƒ©ã‚¤ã‚»ãƒ³ã‚¹" }
      ];
      (groupMeta.length ? groupMeta : groups.map((g) => ({ name: g, key: "", examples: "" }))).forEach((g) => {
        const row = document.createElement('div');
        row.className = 'group-row';
        row.innerHTML = `
          <div style="font-weight:600;">${g.name}</div>
          <div class="muted">${g.key || ""}</div>
          <div class="muted">${g.examples || ""}</div>
        `;
        container.appendChild(row);
      });
    }

    function renderPalette() {
      if (!paletteEl) return;
      paletteEl.innerHTML = "";
      paletteGroups.forEach(group => {
        const wrapper = document.createElement('div');
        wrapper.className = 'palette-group';
        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = group.title;
        wrapper.appendChild(title);
        group.items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'palette-item';
          el.draggable = true;
          el.dataset.type = item.type;
          el.dataset.label = item.label;
          el.innerHTML = `<strong>${item.label}</strong><span>${item.desc}</span>`;
          el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('application/json', JSON.stringify(item));
          });
          wrapper.appendChild(el);
        });
        paletteEl.appendChild(wrapper);
      });
    }

    if (fieldListEl) {
      fieldListEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "#2563eb";
        const insertIdx = calcInsertIndex(e.clientY);
        showPlaceholderAt(insertIdx);
      });

      fieldListEl.addEventListener('dragleave', () => {
        fieldListEl.style.borderColor = "var(--border)";
        removePlaceholder();
      });

      fieldListEl.addEventListener('drop', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "var(--border)";
        const idx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
        const data = e.dataTransfer.getData('application/json');
        if (!data) return;
        const item = JSON.parse(data);
        addField(item, idx); // drop at placeholder or calculated position
      });
    }
  </script>
  <script>
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalSave = document.getElementById('modal-save');
    const tabs = document.querySelectorAll('.modal-tab');
    const panes = document.querySelectorAll('.modal-pane');
    const displayInput = document.getElementById('field-display');
    const keyInput = document.getElementById('field-key');
    const descInput = document.getElementById('field-desc');
    const optionsSection = document.getElementById('field-options-section');
    const optionsInput = document.getElementById('field-options');
    const multiInput = document.getElementById('field-multi');
    const requiredInput = document.getElementById('field-required');
    const patternSection = document.getElementById('field-pattern-section');
    const patternInput = document.getElementById('field-pattern');
    const defaultInput = document.getElementById('field-default');
    let editingIndex = null;

    function switchTab(tabName) {
      tabs.forEach(t => {
        const active = t.dataset.tab === tabName;
        t.classList.toggle('active', active);
      });
      panes.forEach(p => {
        const show = p.dataset.pane === tabName;
        p.classList.toggle('hidden', !show);
      });
    }
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

    function openModal(idx) {
      editingIndex = idx;
      const f = currentFields()[idx];
      const meta = currentMeta()[idx];
      modalTitle.textContent = `${meta.display || f.label}`;
      displayInput.value = meta.display || f.label || "";
      keyInput.value = meta.key || f.key || "";
      descInput.value = meta.description || "";
      optionsSection.style.display = f.type === "Option" ? "grid" : "none";
      optionsInput.value = (meta.options || []).join(",");
      multiInput.checked = !!meta.allowMultiple;
      requiredInput.checked = !!meta.required;
      patternSection.style.display = f.type === "Text" || f.type === "Coordinate" ? "block" : "none";
      patternInput.value = meta.pattern || "";
      defaultInput.value = meta.defaultValue || "";
      switchTab("settings");
      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      editingIndex = null;
    }
    modalClose.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    modalSave.addEventListener('click', () => {
      if (editingIndex === null) return closeModal();
      const f = currentFields()[editingIndex];
      const meta = currentMeta()[editingIndex];
      meta.display = displayInput.value.trim() || f.label;
      meta.key = keyInput.value.trim() || f.key;
      meta.description = descInput.value.trim();
      if (f.type === "Option") {
        meta.options = optionsInput.value
          .split(",")
          .map((v) => v.trim())
          .filter(Boolean);
        meta.allowMultiple = multiInput.checked;
      }
      meta.required = requiredInput.checked;
      meta.pattern = patternInput.value.trim();
      meta.defaultValue = defaultInput.value;

      // sync display/key back to field for rendering
      f.label = meta.display;
      f.key = meta.key;
      f.meta = meta.description;
      renderFields();
      closeModal();
    });

    function ensureModelFromTemplate(tplId) {
      if (modelStore[tplId]) return;
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      const baseFields = tpl.id === "aed-locations" ? modelStore["aed-locations"].fields : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].fields : modelStore["public-facilities"].fields;
      const baseMeta = tpl.id === "aed-locations" ? modelStore["aed-locations"].meta : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].meta : modelStore["public-facilities"].meta;
      modelStore[tplId] = {
        label: tpl.label,
        fields: JSON.parse(JSON.stringify(baseFields)),
        meta: JSON.parse(JSON.stringify(baseMeta)),
        groups: tpl.id === "aed-locations" ? modelStore["aed-locations"].groups : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].groups : modelStore["public-facilities"].groups
      };
    }

    function applyTemplate(tplId) {
      ensureModelFromTemplate(tplId);
      currentModelId = tplId;
      renderModelList();
      renderGroups();
      renderFields();
      removePlaceholder();
      // Switch to Schema view
      switchView('schema');
      closeTemplateModal();
    }

    function renderTemplates() {
      const container = document.getElementById('templates-cards');
      if (!container) return;
      container.innerHTML = "";
      templateList.forEach((tpl) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>${tpl.label}</h3><span class="badge">Template</span>
          </div>
          <div class="muted">#${tpl.key} â€¢ ${tpl.version || ""}</div>
          <div class="muted">${tpl.summary || ""}</div>
          <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
            <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
          </div>
          <div style="position:absolute; right:10px; bottom:10px;">
            <div class="dropdown menu-wrap">
              <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">â‹¯</button>
              <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Templates view apply buttons (delegated)
    document.addEventListener('click', (e) => {
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
      }
    });

    // New Model dropdown
    const newModelBtn = document.getElementById('new-model-btn');
    const newModelMenu = document.getElementById('new-model-menu');
    newModelBtn?.addEventListener('click', () => {
      newModelMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!newModelMenu.contains(e.target) && e.target !== newModelBtn) {
        newModelMenu.classList.remove('active');
      }
    });
    newModelMenu?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'template') {
        openTemplateModal();
      }
      if (e.target.dataset.action === 'blank') {
        const id = `custom-${Date.now()}`;
        modelStore[id] = { label: "Custom Model", fields: [], meta: [], groups: ["åŸºæœ¬æƒ…å ±"] };
        currentModelId = id;
        renderModelList();
        renderGroups();
        renderFields();
        removePlaceholder();
        switchView('schema');
      }
    });

    // Template modal handlers
    const templateModal = document.getElementById('template-modal-backdrop');
    const templateModalCards = document.getElementById('template-modal-cards');
    const templateSearch = document.getElementById('template-search');
    const templateFilter = document.getElementById('template-filter');
    document.getElementById('template-modal-close').addEventListener('click', closeTemplateModal);
    document.getElementById('template-modal-cancel').addEventListener('click', closeTemplateModal);

    // Template edit modal
    const tplEditBackdrop = document.getElementById('template-edit-backdrop');
    const tplEditTitle = document.getElementById('template-edit-title');
    const tplEditLabel = document.getElementById('tpl-edit-label');
    const tplEditKey = document.getElementById('tpl-edit-key');
    const tplEditVersion = document.getElementById('tpl-edit-version');
    const tplEditCategory = document.getElementById('tpl-edit-category');
    const tplEditSummary = document.getElementById('tpl-edit-summary');
    const tplEditSave = document.getElementById('tpl-edit-save');
    const tplEditClose = document.getElementById('template-edit-close');
    const tplEditCancel = document.getElementById('tpl-edit-cancel');
    let editingTemplateId = null;

    function renderTemplateModalCards() {
      const query = (templateSearch?.value || "").toLowerCase();
      const filter = templateFilter?.value || "all";
      templateModalCards.innerHTML = "";
      templateList
        .filter((tpl) => {
          const matchText = tpl.label.toLowerCase().includes(query) || tpl.key.toLowerCase().includes(query) || (tpl.summary || "").toLowerCase().includes(query);
          const matchCat = filter === "all" || tpl.category === filter;
          return matchText && matchCat;
        })
        .forEach((tpl) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>${tpl.label}</h3><span class="badge">Template</span>
            </div>
            <div class="muted">#${tpl.key} â€¢ ${tpl.version || ""} â€¢ ${tpl.category || ""}</div>
            <div class="muted">${tpl.summary || ""}</div>
            <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
              <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
            </div>
            <div style="position:absolute; right:10px; bottom:10px;">
              <div class="dropdown menu-wrap">
                <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">â‹¯</button>
                <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                  <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                  <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
                </div>
              </div>
            </div>
          `;
          templateModalCards.appendChild(card);
        });
    }
    function openTemplateModal() {
      renderTemplateModalCards();
      templateModal.style.display = "flex";
    }
    function closeTemplateModal() {
      templateModal.style.display = "none";
    }
    templateSearch?.addEventListener('input', renderTemplateModalCards);
    templateFilter?.addEventListener('change', renderTemplateModalCards);
    templateModal.addEventListener('click', (e) => {
      if (e.target === templateModal) closeTemplateModal();
    });

    function openTemplateEditModal(tplId) {
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      editingTemplateId = tplId;
      tplEditTitle.textContent = tpl.label;
      tplEditLabel.value = tpl.label;
      tplEditKey.value = tpl.key;
      tplEditVersion.value = tpl.version || "";
      tplEditCategory.value = tpl.category || "";
      tplEditSummary.value = tpl.summary || "";
      tplEditBackdrop.style.display = "flex";
    }
    function closeTemplateEditModal() {
      tplEditBackdrop.style.display = "none";
      editingTemplateId = null;
    }
    tplEditClose.addEventListener('click', closeTemplateEditModal);
    tplEditCancel.addEventListener('click', closeTemplateEditModal);
    tplEditBackdrop.addEventListener('click', (e) => {
      if (e.target === tplEditBackdrop) closeTemplateEditModal();
    });
    tplEditSave.addEventListener('click', () => {
      if (!editingTemplateId) return closeTemplateEditModal();
      const tpl = templateList.find((t) => t.id === editingTemplateId);
      if (!tpl) return closeTemplateEditModal();
      tpl.label = tplEditLabel.value.trim() || tpl.label;
      tpl.key = tplEditKey.value.trim() || tpl.key;
      tpl.version = tplEditVersion.value.trim();
      tpl.category = tplEditCategory.value.trim() || tpl.category;
      tpl.summary = tplEditSummary.value.trim();
      renderTemplates();
      renderTemplateModalCards();
      renderModelList();
      closeTemplateEditModal();
    });
    // delegated template menu (apply/preview/edit)
    document.addEventListener('click', (e) => {
      const menuBtn = e.target.closest('.tpl-menu-btn');
      if (menuBtn) {
        e.stopPropagation();
        const id = menuBtn.dataset.id;
        closeAllTplMenus();
        toggleTplMenu(id);
        return;
      }
      if (e.target?.dataset?.action === 'edit-template') {
        openTemplateEditModal(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'preview-template') {
        alert(`Preview for ${e.target.dataset.id} (stub)`);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      // click outside menus
      if (!e.target.closest('.tpl-menu')) {
        closeAllTplMenus();
      }
    });

    // Content view
    const contentModelList = document.getElementById('content-model-list');
    const contentTable = document.getElementById('content-table');
    const contentSearch = document.getElementById('content-search');
    const contentModelLabel = document.getElementById('content-model-label');
    const newItemBtn = document.getElementById('new-item-btn');
    const itemModal = document.getElementById('item-modal-backdrop');
    const itemForm = document.getElementById('item-form');
    const itemModalClose = document.getElementById('item-modal-close');
    const itemModalCancel = document.getElementById('item-modal-cancel');
    const itemModalSave = document.getElementById('item-modal-save');
    const itemModalTitle = document.getElementById('item-modal-title');

    function renderContentModelList() {
      if (!contentModelList) return;
      contentModelList.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const row = document.createElement('div');
        row.className = 'item';
        if (id === currentModelId) row.classList.add('active');
        row.textContent = modelStore[id].label;
        row.addEventListener('click', () => {
          currentModelId = id;
          renderContentModelList();
          renderContentTable();
          renderModelList();
          renderGroups();
        });
        contentModelList.appendChild(row);
      });
    }

    function renderContentTable() {
      if (!contentTable) return;
      const thead = contentTable.querySelector('thead');
      const tbody = contentTable.querySelector('tbody');
      thead.innerHTML = "";
      tbody.innerHTML = "";
      const fields = currentFields().slice(0, 6); // show first few columns
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th>Status</th>${fields.map((f) => `<th>${f.label}</th>`).join("")}<th></th>`;
      thead.appendChild(headerRow);

      const items = (contentStore[currentModelId] || []).filter((item) => {
        const q = (contentSearch?.value || "").toLowerCase();
        if (!q) return true;
        return Object.values(item).some((v) => (v || "").toString().toLowerCase().includes(q));
      });

      items.forEach((item, rowIdx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="status-dot"><span class="dot ${item.status === "Published" ? "published" : "draft"}"></span>
            <select class="inline-input" data-row="${rowIdx}" data-key="status">
              <option value="Published" ${item.status === "Published" ? "selected" : ""}>Published</option>
              <option value="Draft" ${item.status !== "Published" ? "selected" : ""}>Draft</option>
            </select>
          </span></td>
          ${fields.map((f) => `<td class="cell-editable"><input class="inline-input" data-row="${rowIdx}" data-key="${f.key}" value="${item[f.key] || ""}"></td>`).join("")}
          <td><button class="btn" data-action="delete-row" data-row="${rowIdx}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      const tplKey = (templateList.find((t)=>t.id===currentModelId)?.key) || currentModelId;
      contentModelLabel.textContent = `${modelStore[currentModelId].label} / #${tplKey}`;
    }

    function openItemModal() {
      itemForm.innerHTML = "";
      itemModalTitle.textContent = modelStore[currentModelId].label;
      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-section';
        wrapper.innerHTML = `
          <label>${meta.display || f.label} ${meta.required ? '<span class="badge required">â—</span>' : ''}</label>
          ${renderInputForField(f, meta)}
        `;
        itemForm.appendChild(wrapper);
      });
      itemModal.style.display = "flex";
    }

    function renderInputForField(f, meta) {
      if (f.type === "Option" && meta.options?.length) {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${meta.options.map((opt) => `<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
      }
      if (f.type === "Boolean") {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        `;
      }
      if (f.type === "Date") {
        return `<input class="input" type="date" data-key="${meta.key}">`;
      }
      if (f.type === "Coordinate") {
        return `
          <div class="row" style="gap:8px;">
            <input class="input" type="text" placeholder="lat" data-key="${meta.key}-lat">
            <input class="input" type="text" placeholder="lng" data-key="${meta.key}-lng">
          </div>
        `;
      }
      return `<input class="input" type="text" data-key="${meta.key}" placeholder="${meta.pattern ? meta.pattern : ''}">`;
    }

    function closeItemModal() {
      itemModal.style.display = "none";
    }
    itemModalClose.addEventListener('click', closeItemModal);
    itemModalCancel.addEventListener('click', closeItemModal);
    itemModal.addEventListener('click', (e) => {
      if (e.target === itemModal) closeItemModal();
    });
    newItemBtn?.addEventListener('click', openItemModal);

    itemModalSave.addEventListener('click', () => {
      const inputs = itemForm.querySelectorAll('[data-key]');
      const record = { status: "Draft" };
      let valid = true;
      const errors = [];
      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        if (f.type === "Coordinate") {
          const lat = itemForm.querySelector(`[data-key="${meta.key}-lat"]`)?.value.trim();
          const lng = itemForm.querySelector(`[data-key="${meta.key}-lng"]`)?.value.trim();
          if (meta.required && (!lat || !lng)) {
            valid = false; errors.push(`${meta.display} ã¯å¿…é ˆ`);
          }
          if (lat && lng) record[meta.key] = `${lat}, ${lng}`;
          return;
        }
        const el = itemForm.querySelector(`[data-key="${meta.key}"]`);
        if (!el) return;
        const value = el.value.trim();
        if (meta.required && !value) {
          valid = false; errors.push(`${meta.display} ã¯å¿…é ˆ`);
        }
        if (meta.pattern && value && !(new RegExp(meta.pattern).test(value))) {
          valid = false; errors.push(`${meta.display} ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“`);
        }
        record[meta.key] = value;
      });
      if (!valid) {
        alert(errors.join("\n"));
        return;
      }
      if (!contentStore[currentModelId]) contentStore[currentModelId] = [];
      contentStore[currentModelId].push(record);
      renderContentTable();
      closeItemModal();
    });

    contentSearch?.addEventListener('input', renderContentTable);

    // Inline edit handlers
    contentTable?.addEventListener('input', (e) => {
      const rowIdx = e.target.dataset.row;
      const key = e.target.dataset.key;
      if (rowIdx === undefined || !key) return;
      const record = (contentStore[currentModelId] || [])[rowIdx];
      if (!record) return;
      record[key] = e.target.value;
      sendPatch(currentModelId, contentStore[currentModelId]);
    });
    contentTable?.addEventListener('click', (e) => {
      if (e.target?.dataset?.action === 'delete-row') {
        const rowIdx = e.target.dataset.row;
        if (rowIdx === undefined) return;
        (contentStore[currentModelId] || []).splice(rowIdx, 1);
        renderContentTable();
        sendPatch(currentModelId, contentStore[currentModelId]);
      }
    });

    function toggleTplMenu(id) {
      const menu = document.querySelector(`.tpl-menu[data-id="${id}"]`);
      if (!menu) return;
      menu.classList.toggle('active');
    }
    function closeAllTplMenus() {
      document.querySelectorAll('.tpl-menu').forEach((m) => m.classList.remove('active'));
    }

    // WebSocket sync (optional)
    let ws;
    function initWS() {
      try {
        ws = new WebSocket("ws://localhost:7070");
      } catch (e) {
        console.warn("WS not available");
        return;
      }
      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ type: "join", modelId: currentModelId }));
      });
      ws.addEventListener("message", (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === "snapshot" && msg.modelId === currentModelId) {
            contentStore[msg.modelId] = msg.items || [];
            renderContentTable();
          }
          if (msg.type === "patch" && msg.modelId === currentModelId) {
            contentStore[msg.modelId] = msg.items || [];
            renderContentTable();
          }
        } catch (_) {}
      });
      ws.addEventListener("close", () => {
        setTimeout(initWS, 2000);
      });
    }
    function sendPatch(modelId, items) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "patch", modelId, items }));
    }

    renderModelList();
    renderGroups();
    renderFields();
    renderPalette();
    renderTemplates();
    renderContentModelList();
    renderContentTable();
    initWS();

    // Restore last view
    const lastView = (() => {
      try {
        return localStorage.getItem('ace_last_view') || 'models';
      } catch (_) {
        return 'models';
      }
    })();
    switchView(lastView);
  </script>
</body>
</html>
