<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ACE CMS Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --ink: #222222;
      --muted: #8a8f99;
      --border: #e5e5e5;
      --accent: #1677ff;
      --accent-soft: #e7f0ff;
      --topbar: #1f2022;
      --shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter","Noto Sans JP",system-ui,-apple-system,sans-serif;
      background: var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }
    .topbar {
      height: 64px;
      background: var(--topbar);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      font-weight: 600;
    }
    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
    }
    .topbar-logo-icon {
      width: 28px;
      height: 28px;
      background: #f59e0b;
      border-radius: 4px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 2px;
      padding: 4px;
    }
    .topbar-logo-icon span {
      background: #fff;
      border-radius: 1px;
    }
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
    }
    .topbar-user:hover {
      background: rgba(255,255,255,0.1);
    }
    .topbar-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #374151;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 11px;
      color: #ffffff;
    }
    .topbar-user-chevron {
      font-size: 10px;
      color: #9ca3af;
    }
    .topbar-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #374151;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 13px;
      color: #ffffff;
    }
    .shell {
      display: grid;
      grid-template-columns: 200px 1fr;
      min-height: calc(100vh - 64px);
    }
    aside.nav {
      background: #ffffff;
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .nav-top {
      padding: 12px 8px;
      flex: 1;
    }
    .nav-bottom {
      padding: 8px;
      border-top: 1px solid var(--border);
    }
    .nav-list { display: grid; gap: 2px; }
    .nav-list button {
      all: unset; cursor: pointer; display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 6px; font-weight: 500; font-size: 13px; color: #6b7280;
      transition: background 120ms ease;
    }
    .nav-list button:hover { background: #f3f4f6; }
    .nav-list button.active { background: #e7f3ff; color: #1677ff; }
    .nav-list button.active .nav-icon { filter: none; opacity: 1; }
    .nav-list button .nav-icon { width: 16px; text-align: center; filter: grayscale(1); opacity: 0.7; }
    .nav-collapse-btn {
      all: unset;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      margin-top: 4px;
      transition: background 120ms ease;
    }
    .nav-collapse-btn:hover { background: #f3f4f6; }
    .workspace {
      padding: 32px 24px;
      background: #f6f6f6;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 64px);
    }
    .hidden { display: none !important; }
    /* Models page */
    .header-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    h2 { margin: 0; font-size: 18px; letter-spacing: -0.01em; color: var(--ink); }
    p { margin: 0; color: var(--muted); }
    input, select {
      font: inherit; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border);
      background: #fff; color: var(--ink);
    }
    select { border-radius: 6px; }
    .btn {
      all: unset;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 500;
      color: var(--ink);
      font-size: 14px;
      line-height: 1.2;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.icon-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      display: grid;
      place-items: center;
      font-size: 16px;
      line-height: 1;
    }
    /* Content Containers */
    .content-box {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
    }
    .projects-box {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      padding-bottom: 72px;
      position: relative;
      flex: 1;
      min-height: 400px;
    }
    /* Welcome Banner */
    .welcome-banner {
      background: transparent;
      padding: 0;
      margin-bottom: 0;
    }
    .welcome-banner h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--ink);
    }
    .welcome-banner p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }
    /* Cards */
    .cards { margin-top: 16px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card {
      background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px;
      display: grid; gap: 12px; box-shadow: none;
      position: relative;
      transition: border-color 120ms ease;
      cursor: pointer;
    }
    .card:hover {
      border-color: #d0d0d0;
    }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card h3 { margin: 0; font-size: 15px; font-weight: 600; color: var(--ink); }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.3; }
    .card footer { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; }
    .icon-row { display: flex; gap: 10px; }
    .icon { width: 16px; height: 16px; border: 1px solid var(--border); border-radius: 4px; display: grid; place-items: center; color: #6b7280; font-size: 11px; }
    .badge {
      padding: 3px 8px; background: #fff; color: var(--accent); border-radius: 4px;
      font-size: 12px; font-weight: 500; border: 1px solid var(--accent);
    }
    .badge.public {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      position: absolute;
      bottom: 24px;
      right: 24px;
    }
    .pagination-btn {
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 120ms ease;
    }
    .pagination-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }
    .pagination-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .pagination-select {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      margin-left: 8px;
    }
    .dropdown { position: relative; }
    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 110%;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      min-width: 180px;
      display: none;
      z-index: 10;
    }
    .dropdown-menu.active { display: block; }
    .dropdown-menu button {
      all: unset;
      display: block;
      width: 100%;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--ink);
      font-size: 13px;
    }
    .dropdown-menu button:hover { background: #f3f4f6; }
    /* Dropdown item styles */
    .dropdown-item {
      display: block;
      width: 100%;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--ink);
      font-size: 13px;
      text-align: left;
    }
    .dropdown-item:hover { background: #f3f4f6; }
    /* Group Add Dropdown */
    .group-add-dropdown {
      position: relative;
      display: inline-block;
    }
    .group-add-dropdown .dropdown-menu {
      position: fixed;
      width: 200px;
      z-index: 1000;
    }
    /* GIF Group List */
    .gif-group-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 12px;
    }
    .gif-group-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .gif-group-item:hover {
      background: #f3f4f6;
      border-color: var(--accent);
    }
    .gif-group-item .group-icon {
      width: 36px;
      height: 36px;
      background: #e5e7eb;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 18px;
    }
    .gif-group-item .group-info {
      flex: 1;
    }
    .gif-group-item .group-name {
      font-weight: 500;
      color: #111827;
      font-size: 14px;
    }
    .gif-group-item .group-name-en {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    /* Form styles for New Group Modal */
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      color: #374151;
      margin-bottom: 6px;
    }
    .required-mark {
      color: #ef4444;
      margin-right: 2px;
    }
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
      font-family: inherit;
    }
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .char-count {
      text-align: right;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .form-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.4;
    }
    .search-box {
      margin-bottom: 8px;
    }
    /* Schema page */
    main.schema { background: var(--surface); padding: 0 !important; }
    .schema-layout-wrapper {
      display: grid;
      grid-template-columns: 220px 1fr 280px;
      min-height: calc(100vh - 64px);
      background: #f6f6f6;
    }
    .schema-sidebar {
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 0;
      overflow-y: auto;
    }
    .schema-sidebar-section {
      padding: 0;
    }
    .schema-sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 16px 8px 16px;
    }
    .schema-sidebar-header .section-title {
      margin: 0;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .schema-sidebar-header .add-btn {
      color: var(--accent);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .schema-sidebar-header .add-btn:hover { text-decoration: underline; }
    .schema-model-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      color: var(--ink);
      border-left: 3px solid transparent;
      transition: all 120ms ease;
    }
    .schema-model-item:hover { background: #f3f4f6; }
    .schema-model-item.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .schema-group-item {
      padding: 10px 16px;
      cursor: grab;
      font-size: 14px;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 3px solid transparent;
      transition: all 120ms ease;
    }
    .schema-group-item:hover { background: #f3f4f6; }
    .schema-group-item:active { cursor: grabbing; }
    .schema-group-item.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .schema-group-icon {
      width: 18px;
      height: 18px;
      border: 2px solid #5eead4;
      border-radius: 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 2px;
      flex-shrink: 0;
    }
    .schema-group-icon span {
      width: 100%;
      height: 2px;
      background: #5eead4;
      border-radius: 1px;
    }
    .field-group-icon {
      width: 28px;
      height: 28px;
      padding: 4px;
      gap: 3px;
    }
    .field-group-icon span {
      height: 3px;
    }
    .schema-main {
      background: #fff;
      padding: 24px;
      overflow-y: auto;
    }
    .schema-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0;
    }
    .schema-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .schema-back-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--muted);
      transition: all 120ms ease;
    }
    .schema-back-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    .schema-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .schema-header .schema-key {
      color: var(--muted);
      font-size: 14px;
      font-weight: 400;
    }
    .schema-header-menu {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--muted);
      border-radius: 4px;
    }
    .schema-header-menu:hover { background: #f3f4f6; }
    .tabbar { display: flex; gap: 24px; margin: 16px 0; border-bottom: 1px solid var(--border); }
    .tab { padding: 12px 0; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent; color: var(--muted); font-size: 14px; }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover:not(.active) { color: var(--ink); }
    .layout { display: none; }
    .left-list { display: none; }
    .section-title { font-weight: 700; font-size: 11px; color: #6b7280; margin: 12px 0 8px; letter-spacing: 0.05em; text-transform: uppercase; }
    .item { padding: 9px 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .item.active { background: #e6f0ff; color: #0f4bb8; }
    .group-row { display: none; }
    .field-list {
      background: #fff;
      min-height: 400px;
      padding: 0;
      border: none;
      border-radius: 0;
      box-shadow: none;
    }
    .field-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
      background: #fff;
      transition: all 140ms ease;
      cursor: pointer;
    }
    .field-card:hover { border-color: #d0d0d0; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .field-card.drop-target { border-color: #2563eb; background: #f0f7ff; }
    .field-card-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .field-card-center {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }
    .field-card-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .field-card-name {
      font-weight: 500;
      font-size: 14px;
      color: var(--ink);
    }
    .field-card-key {
      color: var(--muted);
      font-size: 13px;
    }
    .field-card-action {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--muted);
      border-radius: 4px;
      opacity: 0;
      transition: opacity 120ms ease;
    }
    .field-card:hover .field-card-action { opacity: 1; }
    .field-card-action:hover { background: #f3f4f6; color: var(--ink); }
    .field-type-icon {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .field-type-icon.text { background: #fef3c7; color: #d97706; }
    .field-type-icon.textarea { background: #dbeafe; color: #2563eb; }
    .field-type-icon.markdown { background: #e0e7ff; color: #4f46e5; }
    .field-type-icon.asset { background: #f3e8ff; color: #9333ea; }
    .field-type-icon.date { background: #dcfce7; color: #16a34a; }
    .field-type-icon.boolean { background: #fce7f3; color: #db2777; }
    .field-type-icon.option { background: #cffafe; color: #0891b2; }
    .field-type-icon.int, .field-type-icon.float { background: #fef3c7; color: #ea580c; }
    .field-type-icon.coordinate { background: #d1fae5; color: #059669; }
    .field-type-icon.url { background: #e0f2fe; color: #0284c7; }
    .field-type-icon.group { background: #dbeafe; color: #2563eb; }
    .field-badges { display: none; }
    .badge.required {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .badge.validation {
      background: #f3f4f6;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .field-placeholder {
      border: 1px dashed #2563eb;
      border-radius: 8px;
      height: 54px;
      margin: 8px 0;
      background: #f8fbff;
      transition: all 140ms ease;
    }
    /* Content page */
    .content-layout { display: grid; grid-template-columns: 220px 1fr; gap: 0; }
    .content-sidebar {
      border-right: 1px solid var(--border);
      background: #fff;
      padding: 0;
      min-height: calc(100vh - 180px);
    }
    .content-sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .content-sidebar-header .section-title {
      margin: 0;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.05em;
    }
    .content-sidebar-header .add-model-btn {
      color: var(--accent);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .content-sidebar-header .add-model-btn:hover { text-decoration: underline; }
    .content-model-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 13px;
      color: var(--ink);
      border-left: 3px solid transparent;
      transition: all 120ms ease;
    }
    .content-model-item:hover { background: #f3f4f6; }
    .content-model-item.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .content-main { padding: 0 20px 20px; background: #fff; }
    .content-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .content-header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .content-header-title h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .content-header-title .model-key {
      color: var(--muted);
      font-size: 13px;
      font-weight: 400;
    }
    .content-save-view {
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
    }
    .content-save-view:hover { color: var(--accent); }
    .content-toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .content-search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }
    .content-search-input {
      width: 200px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
    }
    .content-search-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--muted);
    }
    .content-search-btn:hover { border-color: var(--accent); color: var(--accent); }
    .content-filter-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
    }
    .content-filter-btn:hover { border-color: var(--accent); color: var(--accent); }
    .content-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .content-toolbar-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--muted);
    }
    .content-toolbar-btn:hover { border-color: var(--accent); color: var(--accent); }
    .content-table-wrap { position: relative; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    .content-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      min-width: 900px;
    }
    .content-table th {
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 500;
      color: var(--ink);
      background: #fafafa;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .content-table th .sort-icon { color: var(--muted); margin-left: 4px; font-size: 10px; }
    .content-table td {
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
      font-size: 13px;
      white-space: nowrap;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .content-table tr:last-child td { border-bottom: none; }
    .content-table tr:hover td { background: #f9fafb; }
    .content-table tr.active-row td { background: #f0f7ff; }
    .content-table .col-checkbox { width: 40px; text-align: center; }
    .content-table .col-icon { width: 36px; text-align: center; padding: 8px 6px; }
    .icon-edit, .icon-detail {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 120ms ease;
    }
    .icon-edit { color: var(--accent); }
    .icon-edit:hover { background: var(--accent-soft); }
    .icon-detail {
      background: #f3f4f6;
      color: #6b7280;
      font-size: 10px;
      font-weight: 600;
    }
    .icon-detail:hover { background: #e5e7eb; }
    .status-dot { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.published { background: #16a34a; }
    .dot.draft { background: #f59e0b; }
    .content-pagination {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      padding: 12px 0;
      font-size: 13px;
      color: var(--muted);
    }
    .content-pagination .page-info { margin-right: 8px; }
    .content-pagination-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
    }
    .content-pagination-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
    .content-pagination-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .content-pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .content-pagination-select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }
    .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
    .cell-editable { background: #fff; }
    .inline-input {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 6px 8px;
      background: #fff;
      font: inherit;
      font-size: 13px;
    }
    .inline-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.15);
    }
    .cell-error {
      border-color: #ef4444 !important;
      background: #fef2f2;
    }
    .cell-error + .tooltip {
      display: block;
    }
    .tooltip {
      display: none;
      position: absolute;
      background: #111827;
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      z-index: 40;
      max-width: 240px;
      white-space: normal;
      transform: translateY(4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .cell-updated {
      animation: flash 1.2s ease;
    }
    @keyframes flash {
      0% { background: #e0f2fe; }
      100% { background: transparent; }
    }
    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.18);
      padding: 16px 18px 18px;
      display: grid;
      gap: 12px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-tabs { display: flex; gap: 12px; border-bottom: 1px solid var(--border); margin: 0 -6px; padding: 0 6px; }
    .modal-tab {
      padding: 10px 6px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      color: #4b5563;
    }
    .modal-tab.active { color: var(--ink); border-bottom-color: var(--accent); }
    .modal-body { display: grid; gap: 10px; }
    .modal-section { display: grid; gap: 8px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 6px; }
    .pill-switch { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #374151; }
    .pill-switch input { width: 16px; height: 16px; }
    textarea { resize: vertical; min-height: 60px; }
    .field-top { display: flex; align-items: center; justify-content: space-between; }
    .collapsible {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fbfcfd;
    }
    .collapsible-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .collapsible-body { margin-top: 8px; display: grid; gap: 8px; }
    .collapsible .chevron { font-size: 12px; color: var(--muted); }
    /* Quick Entry */
    .quick-grid { margin-top: 14px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .quick-card { cursor: pointer; border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: #fff; box-shadow: var(--shadow); transition: transform 120ms ease, box-shadow 120ms ease; }
    .quick-card:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,0.08); }
    .quick-card h3 { margin: 0 0 4px 0; font-size: 15px; }
    .quick-card .muted { font-size: 13px; }
    .quick-hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .field-meta { display: none; }
    .drag-handle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #9ca3af;
      cursor: grab;
      flex-shrink: 0;
    }
    .drag-handle:hover { color: #6b7280; }
    .field-type { display: none; }
    .field-top { display: none; }
    .palette {
      background: #fff;
      padding: 20px;
      border-left: 1px solid var(--border);
      border-radius: 0;
      height: auto;
      overflow-y: auto;
    }
    .palette-title {
      font-weight: 600;
      font-size: 16px;
      margin: 0 0 16px 0;
      color: var(--ink);
    }
    .palette-group { margin-bottom: 20px; }
    .palette-group .section-title {
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
      margin: 0 0 8px 0;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .palette-item {
      border: none;
      border-radius: 8px;
      padding: 10px 12px;
      background: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 4px 0;
      cursor: grab;
      box-shadow: none;
      transition: background 120ms ease;
    }
    .palette-item:hover { background: #f3f4f6; }
    .palette-item-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .palette-item-icon.text { background: #fef3c7; color: #d97706; }
    .palette-item-icon.textarea { background: #dbeafe; color: #2563eb; }
    .palette-item-icon.markdown { background: #e0e7ff; color: #4f46e5; }
    .palette-item-icon.asset { background: #f3e8ff; color: #9333ea; }
    .palette-item-icon.date { background: #dcfce7; color: #16a34a; }
    .palette-item-icon.boolean { background: #fce7f3; color: #db2777; }
    .palette-item-icon.option { background: #cffafe; color: #0891b2; }
    .palette-item-icon.int, .palette-item-icon.float { background: #fef3c7; color: #ea580c; }
    .palette-item-icon.coordinate { background: #d1fae5; color: #059669; }
    .palette-item-icon.url { background: #e0f2fe; color: #0284c7; }
    .palette-item-content { display: flex; flex-direction: column; gap: 2px; }
    .palette-item strong { font-size: 14px; font-weight: 500; color: var(--ink); }
    .palette-item span { color: var(--muted); font-size: 12px; }
    .drop-hint {
      text-align: center; color: #9ca3af; font-size: 13px; padding: 12px 0;
      border: 1px dashed var(--border); border-radius: 10px; margin: 10px 0;
    }
    @media (max-width: 1200px) {
      .shell { grid-template-columns: 200px 1fr; }
      .schema-layout-wrapper { grid-template-columns: 180px 1fr; }
      .palette { display: none; }
    }
    @media (max-width: 900px) {
      .shell { grid-template-columns: 1fr; }
      aside.nav { flex-direction: row; overflow-x: auto; padding: 8px; }
      .nav-top, .nav-bottom { display: flex; gap: 8px; padding: 0; border: none; }
      .nav-collapse-btn { display: none; }
      .layout { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
      .schema-layout-wrapper { grid-template-columns: 1fr; }
      .schema-sidebar { display: none; }
    }
    /* Excel Import Modal */
    .upload-dropzone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 48px 24px;
      text-align: center;
      transition: all 200ms ease;
      cursor: pointer;
    }
    .upload-dropzone:hover,
    .upload-dropzone.drag-over {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .upload-text {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .upload-text strong { color: var(--ink); }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .excel-field-list {
      max-height: 400px;
      overflow-y: auto;
      display: grid;
      gap: 8px;
    }
    .excel-field-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      background: #fff;
      display: grid;
      gap: 6px;
    }
    .excel-field-card .field-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .excel-field-card .field-name {
      font-weight: 600;
      font-size: 14px;
    }
    .excel-field-card .field-key {
      color: var(--muted);
      font-size: 12px;
    }
    .excel-field-card select,
    .excel-field-card input {
      font-size: 13px;
      padding: 6px 8px;
    }
    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .warning-banner {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-logo">
      <div class="topbar-logo-icon">
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
      </div>
      <span>Re: Earth CMS</span>
    </div>
    <div class="topbar-user">
      <div class="topbar-user-avatar">M</div>
      <span>Mac Xiang</span>
      <span class="topbar-user-chevron">‚ñº</span>
    </div>
    <div class="topbar-avatar">M</div>
  </div>

  <div class="shell">
    <aside class="nav">
      <div class="nav-top">
        <div class="nav-list">
          <button class="active" data-view="models"><span class="nav-icon">üè†</span> Home</button>
          <button data-view="quick"><span class="nav-icon">‚ö°</span> Quick Entry</button>
          <button data-view="templates"><span class="nav-icon">üß≠</span> Templates</button>
          <button data-view="schema"><span class="nav-icon">üß©</span> Schema</button>
          <button data-view="content"><span class="nav-icon">üóÇÔ∏è</span> Content</button>
        </div>
      </div>
      <div class="nav-bottom">
        <div class="nav-list">
          <button><span class="nav-icon">üîó</span> Integrations</button>
          <button><span class="nav-icon">‚öôÔ∏è</span> My Integrations</button>
          <button><span class="nav-icon">‚ö°</span> Settings</button>
          <button><span class="nav-icon">üë§</span> Account Settings</button>
        </div>
        <button class="nav-collapse-btn">
          <span>‚óÄ</span>
        </button>
      </div>
    </aside>

    <div id="models-view" class="workspace">
      <div class="content-box">
        <div class="welcome-banner">
          <h1>Welcome to Re:Earth CMS, Mac Xiang!</h1>
          <p>Re:Earth CMS is a robust tool for collecting, creating, storing, and managing data, specifically designed for GIS applications.</p>
        </div>
      </div>

      <div class="projects-box">
        <div class="header-row">
          <h2>Projects</h2>
          <div class="dropdown" style="margin-left:auto;">
            <button id="new-model-btn" class="btn primary">+ New Project</button>
            <div id="new-model-menu" class="dropdown-menu">
              <button data-action="blank">Á©∫ÁôΩ„ÅÆ„É¢„Éá„É´„Çí‰ΩúÊàê</button>
              <button data-action="template">Ê®ôÊ∫ñ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ‰ΩúÊàê</button>
            </div>
          </div>
        </div>

        <div class="header-row" style="margin-top:16px;">
          <div style="position:relative;">
            <input placeholder="search projects" style="width:220px; padding-right:36px;">
            <span style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:14px;">üîç</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:auto;">
            <span class="muted">Sort by</span>
            <select>
              <option>Last Modified</option>
              <option>Name A-Z</option>
              <option>Name Z-A</option>
              <option>Created date</option>
            </select>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <div class="card-header">
              <h3>Open Data</h3>
              <span class="badge public">Public</span>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Street Atlas</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">1243</div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Á©∫„ÅçÂÆ∂ Empty houses</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">124124124124</div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Imaginary Cities</h3>
              <span class="badge public">Public</span>
            </div>
            <div class="muted">A collection of fictional cities with det...</div>
          </div>
        </div>

        <div class="pagination">
          <button class="pagination-btn" disabled>‚Äπ</button>
          <button class="pagination-btn active">1</button>
          <button class="pagination-btn">‚Ä∫</button>
          <select class="pagination-select">
            <option>10 / page</option>
            <option>20 / page</option>
            <option>50 / page</option>
          </select>
        </div>
      </div>
    </div>

    <div id="schema-wrapper" class="schema hidden">
      <main class="schema workspace">
        <div class="schema-layout-wrapper">
          <!-- Left Sidebar -->
          <div class="schema-sidebar">
            <div class="schema-sidebar-section">
              <div class="schema-sidebar-header">
                <span class="section-title">Models</span>
                <span class="add-btn">+ Add</span>
              </div>
              <div id="model-list"></div>
            </div>
            <div class="schema-sidebar-section">
              <div class="schema-sidebar-header">
                <span class="section-title">Groups</span>
                <div class="group-add-dropdown">
                  <span class="add-btn" id="add-group-btn">+ Add</span>
                  <div id="add-group-menu" class="dropdown-menu">
                    <div class="dropdown-item" id="new-group-option">New Group</div>
                    <div class="dropdown-item" id="gif-group-option">ÂÖ±ÈÄöË™ûÂΩôÂü∫Áõ§ÔºàGIFÔºâ</div>
                  </div>
                </div>
              </div>
              <div id="group-list"></div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="schema-main">
            <div class="schema-header">
              <div class="schema-header-left">
                <button id="schema-back-btn" class="schema-back-btn hidden" title="Back to model">‚Üê</button>
                <h2 id="schema-model-title">ÂÖ¨ÂÖ±ÊñΩË®≠‰∏ÄË¶ß</h2>
                <span class="schema-key" id="schema-model-key">#public_facility</span>
              </div>
              <button class="schema-header-menu">‚ãÆ</button>
            </div>
            <div class="tabbar">
              <div class="tab active">Fields</div>
              <div class="tab">Meta Data</div>
            </div>
            <div id="field-list" class="field-list"></div>
          </div>

          <!-- Right Palette -->
          <div class="palette">
            <h3 class="palette-title">Add Field</h3>
            <div id="palette"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="templates-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Templates</h2>
          <p>Ê®ôÊ∫ñ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî® / „Éó„É¨„Éì„É•„Éº</p>
        </div>
        <button id="excel-import-btn" class="btn primary">+ Create from Excel (AI)</button>
      </div>
      <div class="cards" id="templates-cards"></div>
    </div>

    <div id="content-view" class="workspace hidden" style="padding:0; background:#fff;">
      <div class="content-layout">
        <div class="content-sidebar">
          <div class="content-sidebar-header">
            <span class="section-title">MODELS</span>
            <span class="add-model-btn">+ Add</span>
          </div>
          <div id="content-model-list"></div>
        </div>
        <div class="content-main">
          <div class="content-header-bar">
            <div class="content-header-title">
              <h3 id="content-model-name">ÂÖ¨ÂÖ±ÊñΩË®≠‰∏ÄË¶ß</h3>
              <span class="model-key" id="content-model-key">#public_facility</span>
            </div>
            <button id="new-item-btn" class="btn primary">+ New Item</button>
          </div>
          <div class="content-save-view">Save as new view</div>
          <div class="content-toolbar">
            <div class="content-search-wrap">
              <input id="content-search" class="content-search-input" placeholder="input search text">
              <button class="content-search-btn">üîç</button>
            </div>
            <button class="content-filter-btn">+ Filter</button>
            <div class="dropdown" style="display:none;" id="content-actions-wrap">
              <button id="content-actions-btn" class="btn">‚ãØ Actions</button>
              <div id="content-actions-menu" class="dropdown-menu" style="min-width:180px;">
                <button data-action="delete-selected">Delete selected</button>
                <button data-action="publish-selected">Mark as Published</button>
                <button data-action="draft-selected">Mark as Draft</button>
                <button data-action="sort-asc">Sort by first column A‚ÜíZ</button>
                <button data-action="sort-desc">Sort by first column Z‚ÜíA</button>
              </div>
            </div>
            <div class="content-toolbar-right">
              <button class="content-toolbar-btn" title="Settings">‚öô</button>
              <button class="content-toolbar-btn" title="Refresh">‚Üª</button>
              <button class="content-toolbar-btn" title="Toggle columns">T</button>
              <button class="content-toolbar-btn" title="Download">‚¨á</button>
              <button class="content-toolbar-btn" title="Fullscreen">‚õ∂</button>
            </div>
          </div>
          <div class="content-table-wrap">
            <table class="content-table" id="content-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="content-pagination" id="content-pagination">
            <span class="page-info" id="page-info">1-5 of 5 items</span>
            <button class="content-pagination-btn" disabled>‚Äπ</button>
            <button class="content-pagination-btn active">1</button>
            <button class="content-pagination-btn">‚Ä∫</button>
            <select class="content-pagination-select">
              <option>20 / page</option>
              <option>50 / page</option>
              <option>100 / page</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="quick-view" class="workspace hidden">
      <div class="header-row">
        <div>
          <h2>Quick Entry</h2>
          <p>„Çà„Åè‰Ωø„ÅÜ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁ∞°ÊòìÂÖ•Âäõ„ÅßËøΩÂä†</p>
        </div>
      </div>
      <div class="quick-grid" id="quick-cards"></div>
      <div class="quick-hint">ÊúÄÂ∞èÂÖ•Âäõ„Åß„Éâ„É©„Éï„Éà„Çí‰ΩúÊàê„Åó„ÄÅContent„ÅßË©≥Á¥∞„ÇíËøΩË®ò„Åß„Åç„Åæ„Åô„ÄÇ</div>
    </div>
  </div>

  <!-- Field Edit Modal -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Update Field</div>
          <h3 id="modal-title" style="margin:0;">Field</h3>
        </div>
        <button id="modal-close" class="btn">‚úï</button>
      </div>
      <div class="modal-tabs">
        <div class="modal-tab active" data-tab="settings">Settings</div>
        <div class="modal-tab" data-tab="validation">Validation</div>
        <div class="modal-tab" data-tab="default">Default value</div>
      </div>
      <div class="modal-body">
        <div class="modal-section modal-pane" data-pane="settings">
          <div>
            <label>Display name</label>
            <input id="field-display" placeholder="Ë°®Á§∫Âêç">
          </div>
          <div>
            <label>Field Key</label>
            <input id="field-key" placeholder="field_key">
            <div class="muted" style="font-size:12px;">ÂçäËßíËã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥/„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø</div>
          </div>
          <div>
            <label>Description <span class="muted">(optional)</span></label>
            <textarea id="field-desc" maxlength="1000" placeholder="Ë™¨ÊòéÊñá"></textarea>
          </div>
          <div id="field-options-section" class="modal-section" style="display:none;">
            <label>Options („Ç´„É≥„ÉûÂå∫Âàá„Çä)</label>
            <input id="field-options" placeholder="yes,no,unknown">
            <div class="pill-switch"><input type="checkbox" id="field-multi"> <label for="field-multi">Support multiple values</label></div>
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="validation">
          <div class="pill-switch"><input type="checkbox" id="field-required"> <label for="field-required">Required (‚óé)</label></div>
          <div id="field-pattern-section" style="display:none;">
            <label>Pattern (regex)</label>
            <input id="field-pattern" placeholder="‰æã: ^[0-9]{6}$">
          </div>
        </div>
        <div class="modal-section modal-pane hidden" data-pane="default">
          <div>
            <label>Default value</label>
            <input id="field-default" placeholder="„Éá„Éï„Ç©„É´„ÉàÂÄ§">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn">Cancel</button>
        <button id="modal-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Template Selection Modal -->
  <div id="template-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 860px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Ê®ôÊ∫ñ„É¢„Éá„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÈÅ∏Êäû</div>
          <h3 style="margin:0;">Templates</h3>
        </div>
        <button id="template-modal-close" class="btn">‚úï</button>
      </div>
      <div class="row" style="gap:8px;">
        <input id="template-search" placeholder="Ê§úÁ¥¢ (‰æã: AED, ÂÖ¨ÂÖ±ÊñΩË®≠, „Ç§„Éô„É≥„Éà)" style="flex:1;">
        <select id="template-filter" style="width:180px;">
          <option value="all">„Åô„Åπ„Å¶</option>
          <option value="facility">ÊñΩË®≠</option>
          <option value="event">„Ç§„Éô„É≥„Éà</option>
          <option value="emergency">Èò≤ÁÅΩ</option>
        </select>
      </div>
      <div id="template-modal-cards" class="cards" style="margin-top:12px; max-height:60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="template-modal-cancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Template Edit Modal -->
  <div id="template-edit-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 540px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁ∑®ÈõÜ</div>
          <h3 id="template-edit-title" style="margin:0;">Template</h3>
        </div>
        <button id="template-edit-close" class="btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <label>ÂêçÁß∞</label>
          <input id="tpl-edit-label" placeholder="ÂÖ¨ÂÖ±ÊñΩË®≠‰∏ÄË¶ß">
        </div>
        <div class="modal-section">
          <label>Model Key</label>
          <input id="tpl-edit-key" placeholder="public_facility">
        </div>
        <div class="modal-section">
          <label>„Éê„Éº„Ç∏„Éß„É≥</label>
          <input id="tpl-edit-version" placeholder="v3.0">
        </div>
        <div class="modal-section">
          <label>ÂàÜÈ°û</label>
          <input id="tpl-edit-category" placeholder="facility / emergency / event">
        </div>
        <div class="modal-section">
          <label>Ê¶ÇË¶Å</label>
          <textarea id="tpl-edit-summary" placeholder="Ê¶ÇË¶Å„ÇíÂÖ•Âäõ"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button id="tpl-edit-cancel" class="btn">Cancel</button>
        <button id="tpl-edit-save" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="item-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">New Item</div>
          <h3 id="item-modal-title" style="margin:0;">Item</h3>
        </div>
        <button id="item-modal-close" class="btn">‚úï</button>
      </div>
      <div id="item-form" class="modal-body" style="max-height: 60vh; overflow:auto;"></div>
      <div class="modal-actions">
        <button id="item-modal-cancel" class="btn">Cancel</button>
        <button id="item-modal-save" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Quick Entry Modal -->
  <div id="quick-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Quick Entry</div>
          <h3 id="quick-modal-title" style="margin:0;">Template</h3>
        </div>
        <button id="quick-modal-close" class="btn">‚úï</button>
      </div>
      <div id="quick-form" class="modal-body"></div>
      <div class="modal-actions">
        <button id="quick-modal-cancel" class="btn">Cancel</button>
        <button id="quick-modal-save" class="btn primary">Save Draft</button>
      </div>
    </div>
  </div>

  <!-- New Group Modal -->
  <div id="new-group-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header">
        <h3 style="margin:0;">New Group</h3>
        <button id="new-group-modal-close" class="btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label"><span class="required-mark">*</span> Group name</label>
          <input type="text" id="new-group-name" class="form-input" placeholder="">
        </div>
        <div class="form-group">
          <label class="form-label">Group description</label>
          <textarea id="new-group-description" class="form-textarea" rows="4" placeholder=""></textarea>
        </div>
        <div class="form-group">
          <label class="form-label"><span class="required-mark">*</span> Group key</label>
          <input type="text" id="new-group-key" class="form-input" maxlength="32" placeholder="">
          <div class="char-count"><span id="group-key-count">0</span> / 32</div>
          <div class="form-hint">Group key must be unique and at least 3 characters long. It can only contain letters, numbers, underscores, and dashes.</div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="new-group-cancel" class="btn">Cancel</button>
        <button id="new-group-save" class="btn primary" disabled>OK</button>
      </div>
    </div>
  </div>

  <!-- GIF Group Modal -->
  <div id="gif-group-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <h3 style="margin:0;">ÂÖ±ÈÄöË™ûÂΩôÂü∫Áõ§ÔºàGIFÔºâ</h3>
        <button id="gif-group-modal-close" class="btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="search-box">
          <input type="text" id="gif-group-search" class="form-input" placeholder="Search groups...">
        </div>
        <div id="gif-group-list" class="gif-group-list"></div>
      </div>
    </div>
  </div>

  <!-- Excel Import Modal -->
  <div id="excel-import-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <div>
          <div class="muted" style="font-size:12px;">Create Template from Excel</div>
          <h3 id="excel-import-title" style="margin:0;">Import Excel File</h3>
        </div>
        <button id="excel-import-close" class="btn">‚úï</button>
      </div>

      <!-- Upload Step -->
      <div id="excel-upload-step" class="modal-body">
        <div class="upload-dropzone" id="excel-dropzone">
          <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" hidden>
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">
            <strong>Drop Excel file here or click to browse</strong>
            <span class="muted">Supports .xlsx, .xls, and .csv files (max 10MB)</span>
          </div>
          <button class="btn primary" id="excel-browse-btn">Browse Files</button>
        </div>
      </div>

      <!-- Loading Step -->
      <div id="excel-loading-step" class="modal-body hidden">
        <div style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
          <div style="font-weight: 500; margin-bottom: 8px;">Analyzing Excel file...</div>
          <div class="muted">AI is generating schema based on your data</div>
        </div>
      </div>

      <!-- Preview Step -->
      <div id="excel-preview-step" class="modal-body hidden">
        <div id="excel-warning-banner" class="warning-banner hidden"></div>
        <div class="modal-tabs">
          <div class="modal-tab active" data-excel-tab="fields">Fields (<span id="excel-field-count">0</span>)</div>
          <div class="modal-tab" data-excel-tab="settings">Template Settings</div>
          <div class="modal-tab" data-excel-tab="json">JSON Preview</div>
        </div>

        <!-- Fields Tab -->
        <div class="modal-section excel-tab-pane" data-excel-pane="fields">
          <div id="excel-field-list" class="excel-field-list"></div>
        </div>

        <!-- Settings Tab -->
        <div class="modal-section excel-tab-pane hidden" data-excel-pane="settings">
          <div style="display: grid; gap: 12px;">
            <div>
              <label>Template Name</label>
              <input id="excel-tpl-label" placeholder="My Template">
            </div>
            <div>
              <label>Template ID (kebab-case)</label>
              <input id="excel-tpl-id" placeholder="my-template" pattern="^[a-z0-9-]+$">
              <div class="muted" style="font-size:12px;">Â∞èÊñáÂ≠óËã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø</div>
            </div>
            <div>
              <label>Description</label>
              <textarea id="excel-tpl-desc" placeholder="Description of the template"></textarea>
            </div>
          </div>
        </div>

        <!-- JSON Tab -->
        <div class="modal-section excel-tab-pane hidden" data-excel-pane="json">
          <pre id="excel-json-preview" style="background:#f5f5f5; padding:12px; border-radius:8px; overflow:auto; max-height: 300px; font-size: 12px;"></pre>
        </div>
      </div>

      <div class="modal-actions">
        <button id="excel-import-cancel" class="btn">Cancel</button>
        <button id="excel-import-save" class="btn primary hidden">Create Template</button>
      </div>
    </div>
  </div>

  <script>
    // View switcher with persistence
    const navButtons = document.querySelectorAll('.nav-list button[data-view]');
    const crumbTitle = document.getElementById('crumb-title');
    const modelsView = document.getElementById('models-view');
    const schemaWrapper = document.getElementById('schema-wrapper');
    const templatesView = document.getElementById('templates-view');
    const quickView = document.getElementById('quick-view');
    const contentView = document.getElementById('content-view');

    function switchView(target) {
      const viewMap = {
        models: modelsView,
        schema: schemaWrapper,
        templates: templatesView,
        quick: quickView,
        content: contentView,
      };
      Object.values(viewMap).forEach((el) => el && el.classList.add('hidden'));
      if (viewMap[target]) viewMap[target].classList.remove('hidden');
      navButtons.forEach((b) => b.classList.toggle('active', b.dataset.view === target));
      if (crumbTitle) crumbTitle.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      try {
        localStorage.setItem('ace_last_view', target);
      } catch (_) {}
      if (target === 'content') {
        renderContentModelList();
        renderContentTable();
        updateActionsVisibility();
      } else if (target === 'quick') {
        renderQuickCards();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.view;
        switchView(target);
      });
    });

    // Schema drag/drop
    const fieldListEl = document.getElementById('field-list');
    const paletteEl = document.getElementById('palette');

    const initialFields = [
      { label: "ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ", key: "localGovernmentCode", type: "Text", meta: "ÂçäËßíÊï∞Â≠ó6Ê°Å" },
      { label: "ID", key: "identifier", type: "Text", meta: "ÂçäËßíËã±Êï∞Â≠ó" },
      { label: "ÂêçÁß∞ (Name)", key: "name", type: "Text" },
      { label: "ÂêçÁß∞_Ëã±Â≠ó", key: "nameEn", type: "Text" },
      { label: "ÂêçÁß∞_ÈÄöÁß∞", key: "nameAlias", type: "Text" },
      { label: "POI„Ç≥„Éº„Éâ", key: "poiCode", type: "Int", meta: "ÂçäËßíÊï∞Â≠ó" },
      { label: "Â§ñÈÉ®Ë≠òÂà•Â≠ê", key: "externalIdentifier", type: "Text" },
      { label: "Â§ñÈÉ®Ë≠òÂà•Â≠ê„ÅÆÂÄ§", key: "externalIdentifierValue", type: "Text" },
      { label: "ÊâÄÂú®Âú∞ (Address)", key: "address", type: "Text" },
      { label: "ÈÄ£Áµ°ÂÖà (Contact)", key: "contact", type: "Text" },
      { label: "Á∑ØÂ∫¶ / ÁµåÂ∫¶", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "„Éá„Éº„Çø„Çª„ÉÉ„ÉàÊúÄÁµÇÊõ¥Êñ∞Êó•", key: "datasetUpdatedAt", type: "Date" }
    ];

    const childcareFields = [
      { label: "ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ", key: "localGovernmentCode", type: "Text", meta: "ÂçäËßíÊï∞Â≠ó6Ê°Å" },
      { label: "ID", key: "identifier", type: "Text", meta: "ÂçäËßíËã±Êï∞Â≠ó" },
      { label: "ÊñΩË®≠Âêç", key: "facilityName", type: "Text" },
      { label: "ÊñΩË®≠Á®ÆÂà•", key: "facilityCategory", type: "Option", meta: "‰øùËÇ≤ÊâÄ,ÂπºÁ®öÂúí,Ë™çÂÆö„Åì„Å©„ÇÇÂúí,Â≠¶Á´•,„Åù„ÅÆ‰ªñ" },
      { label: "ÊâÄÂú®Âú∞ (Address)", key: "address", type: "Text" },
      { label: "ÈõªË©±Áï™Âè∑", key: "phone", type: "Text" },
      { label: "ÈñãÊâÄÊôÇÈñì", key: "openingHours", type: "Text" },
      { label: "Á∑ØÂ∫¶ / ÁµåÂ∫¶", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
      { label: "„Éá„Éº„Çø„Çª„ÉÉ„ÉàÊúÄÁµÇÊõ¥Êñ∞Êó•", key: "datasetUpdatedAt", type: "Date" }
    ];

    const paletteGroups = [
      { title: "Text", items: [
        { label: "Text", desc: "Heading and titles, one-line field", type: "Text" },
        { label: "TextArea", desc: "Multi line text", type: "TextArea" },
        { label: "Markdown text", desc: "Rich text which supports md style", type: "Markdown" }
      ]},
      { title: "Asset", items: [
        { label: "Asset", desc: "Asset file", type: "Asset" }
      ]},
      { title: "Time", items: [
        { label: "Date", desc: "Date picker", type: "Date" }
      ]},
      { title: "Boolean", items: [
        { label: "Boolean", desc: "true/false field", type: "Boolean" }
      ]},
      { title: "Select", items: [
        { label: "Option", desc: "Multiple select", type: "Option" }
      ]},
      { title: "Number", items: [
        { label: "Int", desc: "Integer", type: "Int" },
        { label: "Float", desc: "Fractional", type: "Float" }
      ]},
      { title: "URL", items: [
        { label: "URL", desc: "http/https URL", type: "URL" }
      ]},
      { title: "Relation", items: [
        { label: "Reference", desc: "Reference to other model", type: "Reference" }
      ]},
      { title: "Geo", items: [
        { label: "Coordinate", desc: "Á∑ØÂ∫¶„ÉªÁµåÂ∫¶ (GIF)", type: "Coordinate" }
      ]}
    ];

    const modelStore = {
      "public-facilities": {
        label: "ÂÖ¨ÂÖ±ÊñΩË®≠‰∏ÄË¶ß",
        fields: [...initialFields],
        meta: initialFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","name","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: f.type === "Option" && f.meta ? f.meta.split(",") : [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6Ê°Å") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["Âü∫Êú¨ÊÉÖÂ†±", "ÊâÄÂú®Âú∞ (Address)", "ÈÄ£Áµ°ÂÖà", "‰ΩçÁΩÆÊÉÖÂ†±", "Êõ¥Êñ∞ÊÉÖÂ†±"]
      },
      "childcare-facilities": {
        label: "Â≠êËÇ≤„Å¶ÊñΩË®≠‰∏ÄË¶ß",
        fields: [...childcareFields],
        meta: childcareFields.map((f) => ({
          display: f.label,
          key: f.key,
          description: "",
          required: ["localGovernmentCode","identifier","facilityName","facilityCategory","address","latitudeLongitude","datasetUpdatedAt"].includes(f.key),
          options: f.type === "Option" && f.meta ? f.meta.split(",") : [],
          allowMultiple: false,
          pattern: f.meta && f.meta.includes("6Ê°Å") ? "^[0-9]{6}$" : "",
          defaultValue: ""
        })),
        groups: ["Âü∫Êú¨ÊÉÖÂ†±", "ÊâÄÂú®Âú∞ (Address)", "„Çµ„Éº„Éì„Çπ", "ÊôÇÈñì", "„É°„Éá„Ç£„Ç¢"]
      },
      "aed-locations": {
        label: "AEDË®≠ÁΩÆÁÆáÊâÄ‰∏ÄË¶ß",
        fields: [
          { label: "ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ", key: "localGovernmentCode", type: "Text", meta: "ÂçäËßíÊï∞Â≠ó6Ê°Å" },
          { label: "ID", key: "identifier", type: "Text", meta: "ÂçäËßíËã±Êï∞Â≠ó" },
          { label: "Ë®≠ÁΩÆÂ†¥ÊâÄÂêçÁß∞", key: "name", type: "Text" },
          { label: "Ë®≠ÁΩÆÂ†¥ÊâÄË©≥Á¥∞", key: "installationPlace", type: "Text" },
          { label: "Â∞èÂÖêÂØæÂøúË®≠ÂÇô„ÅÆÊúâÁÑ°", key: "pediatricSupport", type: "Option", meta: "yes,no" },
          { label: "ÊâÄÂú®Âú∞ (Address)", key: "address", type: "Text" },
          { label: "Âïè„ÅÑÂêà„Çè„ÅõÂÖàÈõªË©±Áï™Âè∑", key: "contactPhone", type: "Text" },
          { label: "Á∑ØÂ∫¶ / ÁµåÂ∫¶", key: "latitudeLongitude", type: "Coordinate", meta: "GIF bounds -90/90 -180/180" },
          { label: "„Éá„Éº„Çø„Çª„ÉÉ„ÉàÊúÄÁµÇÊõ¥Êñ∞Êó•", key: "datasetUpdatedAt", type: "Date" }
        ],
        meta: [
          { display: "ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ", key: "localGovernmentCode", description: "", required: true, options: [], allowMultiple: false, pattern: "^[0-9]{6}$", defaultValue: "" },
          { display: "ID", key: "identifier", description: "", required: true, options: [], allowMultiple: false, pattern: "^[A-Za-z0-9_-]+$", defaultValue: "" },
          { display: "Ë®≠ÁΩÆÂ†¥ÊâÄÂêçÁß∞", key: "name", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "Ë®≠ÁΩÆÂ†¥ÊâÄË©≥Á¥∞", key: "installationPlace", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "Â∞èÂÖêÂØæÂøúË®≠ÂÇô„ÅÆÊúâÁÑ°", key: "pediatricSupport", description: "", required: true, options: ["yes","no"], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "ÊâÄÂú®Âú∞ (Address)", key: "address", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "Âïè„ÅÑÂêà„Çè„ÅõÂÖàÈõªË©±Áï™Âè∑", key: "contactPhone", description: "", required: false, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "Á∑ØÂ∫¶ / ÁµåÂ∫¶", key: "latitudeLongitude", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" },
          { display: "„Éá„Éº„Çø„Çª„ÉÉ„ÉàÊúÄÁµÇÊõ¥Êñ∞Êó•", key: "datasetUpdatedAt", description: "", required: true, options: [], allowMultiple: false, pattern: "", defaultValue: "" }
        ],
        groups: ["Âü∫Êú¨ÊÉÖÂ†±", "ÊâÄÂú®Âú∞ (Address)", "Ë®≠ÂÇô", "‰ΩçÁΩÆÊÉÖÂ†±", "Êõ¥Êñ∞ÊÉÖÂ†±"]
      }
    };
    const templateList = [
      { id: "public-facilities", label: "ÂÖ¨ÂÖ±ÊñΩË®≠‰∏ÄË¶ß", key: "public_facility", version: "v3.0", category: "facility", summary: "Âú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„ÅåÁÆ°ÁêÜ„Åô„ÇãÂÖ¨ÂÖ±ÊñΩË®≠„ÅÆË©≥Á¥∞„Éá„Éº„Çø" },
      { id: "aed-locations", label: "AEDË®≠ÁΩÆÁÆáÊâÄ‰∏ÄË¶ß", key: "aed_location", version: "v2.1", category: "emergency", summary: "AEDË®≠ÁΩÆÂ†¥ÊâÄ„Å®ÂØæÂøúÂèØÂê¶„ÇíÂê´„ÇÄÁ∑äÊÄ•ÂåªÁôÇ„Éá„Éº„Çø" },
      { id: "childcare-facilities", label: "Â≠êËÇ≤„Å¶ÊñΩË®≠‰∏ÄË¶ß", key: "childcare_facility", version: "v1.4", category: "facility", summary: "‰øùËÇ≤„ÉªÂπºÁ®öÂúí„ÉªÂ≠¶Á´•ÊñΩË®≠„ÅÆ‰∏ÄË¶ß„Å®Ë®≠ÂÇôÊÉÖÂ†±" }
    ];
    const quickTemplates = [
      {
        id: "public-facilities",
        label: "ÂÖ¨ÂÖ±ÊñΩË®≠Ôºà„Åã„Çì„Åü„ÇìÔºâ",
        description: "ÂêçÁß∞„ÉªID„ÉªÊâÄÂú®Âú∞„Çí„Åô„ÅêÁôªÈå≤",
        fields: [
          { key: "name", label: "ÊñΩË®≠Âêç", required: true, placeholder: "‰∏≠Â§ÆÂõ≥Êõ∏È§®" },
          { key: "identifier", label: "ID", required: true, placeholder: "ÂçäËßíÊï∞Â≠ó" },
          { key: "address", label: "ÊâÄÂú®Âú∞", required: true, placeholder: "ÈÉΩÈÅìÂ∫úÁúå Â∏ÇÂå∫Áî∫Êùë" },
          { key: "nameAlias", label: "ÂêçÁß∞_ÈÄöÁß∞", required: false },
          { key: "poiCode", label: "POI„Ç≥„Éº„Éâ", required: false, type: "number" }
        ]
      },
      {
        id: "aed-locations",
        label: "AEDË®≠ÁΩÆÁÆáÊâÄÔºà„Åã„Çì„Åü„ÇìÔºâ",
        description: "Ë®≠ÁΩÆÂ†¥ÊâÄ„ÇíÊúÄÂ∞èÂÖ•Âäõ„ÅßËøΩÂä†",
        fields: [
          { key: "name", label: "Ë®≠ÁΩÆÂ†¥ÊâÄÂêçÁß∞", required: true, placeholder: "Â∏ÇÂΩπÊâÄ 1F" },
          { key: "installationPlace", label: "Ë®≠ÁΩÆÂ†¥ÊâÄË©≥Á¥∞", required: true, placeholder: "Âèó‰ªòÂâç" },
          { key: "address", label: "ÊâÄÂú®Âú∞", required: true, placeholder: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫..." },
          { key: "pediatricSupport", label: "Â∞èÂÖêÂØæÂøúË®≠ÂÇô„ÅÆÊúâÁÑ°", required: false, placeholder: "yes / no" }
        ]
      },
      {
        id: "childcare-facilities",
        label: "Â≠êËÇ≤„Å¶ÊñΩË®≠Ôºà„Åã„Çì„Åü„ÇìÔºâ",
        description: "ÊñΩË®≠Âêç„Å®Á®ÆÂà•„Å†„Åë„Åß‰ΩúÊàê",
        fields: [
          { key: "facilityName", label: "ÊñΩË®≠Âêç", required: true },
          { key: "facilityCategory", label: "ÊñΩË®≠Á®ÆÂà•", required: true, placeholder: "‰øùËÇ≤ÊâÄ „Å™„Å©" },
          { key: "address", label: "ÊâÄÂú®Âú∞", required: true },
          { key: "openingHours", label: "ÈñãÊâÄÊôÇÈñì", required: false, placeholder: "09:00-18:00" }
        ]
      }
    ];
    const contentStore = {
      "public-facilities": [
        { status: "Published", localGovernmentCode: "352080", identifier: "1200005", name: "01kafp2rw7ah5...", nameEn: "-", nameAlias: "01kafp2rw7afz...", poiCode: "-", externalIdentifier: "01kafp2rw75c0...", externalIdentifierValue: "01kafp2rw...", address: "Â±±Âè£ÁúåÂ≤©ÂõΩÂ∏Ç‰∏≠Â§ÆÁî∫1-1-1", latitudeLongitude: "34.1689, 132.2196" },
        { status: "Published", localGovernmentCode: "352080", identifier: "1200004", name: "01kafnjw124wg...", nameEn: "-", nameAlias: "01kafnjw1298w...", poiCode: "-", externalIdentifier: "01kafnjw12j24n...", externalIdentifierValue: "01kafnjw1...", address: "Â±±Âè£ÁúåÂ≤©ÂõΩÂ∏ÇÈ∫ªÈáåÂ∏ÉÁî∫2-3-4", latitudeLongitude: "34.1721, 132.2234" },
        { status: "Published", localGovernmentCode: "352080", identifier: "1200003", name: "01kafn5xyy3gjj...", nameEn: "-", nameAlias: "01kafn5xyy9aa...", poiCode: "-", externalIdentifier: "01kafn5xyyjsjy...", externalIdentifierValue: "01kafn5xy...", address: "Â±±Âè£ÁúåÂ≤©ÂõΩÂ∏Ç‰ªäÊ¥•Áî∫3-5-6", latitudeLongitude: "34.1756, 132.2189" },
        { status: "Draft", localGovernmentCode: "352080", identifier: "1200002", name: "01kafmtd40t97...", nameEn: "-", nameAlias: "01kafmtd400p...", poiCode: "-", externalIdentifier: "01kafmtd407ec...", externalIdentifierValue: "01kafmtd...", address: "Â±±Âè£ÁúåÂ≤©ÂõΩÂ∏ÇÂÆ§„ÅÆÊú®Áî∫4-7-8", latitudeLongitude: "34.1645, 132.2267" },
        { status: "Draft", localGovernmentCode: "352080", identifier: "1200001", name: "01kafgc46hgp...", nameEn: "-", nameAlias: "01kafgc46jm5b...", poiCode: "-", externalIdentifier: "01kafgc46jnyw...", externalIdentifierValue: "01kafgc46...", address: "Â±±Âè£ÁúåÂ≤©ÂõΩÂ∏ÇÂ±±ÊâãÁî∫5-9-10", latitudeLongitude: "34.1698, 132.2145" }
      ],
      "childcare-facilities": [
        { status: "Published", localGovernmentCode: "131016", identifier: "cc-001", facilityName: "„Åï„Åè„Çâ‰øùËÇ≤Âúí", address: "Êù±‰∫¨ÈÉΩÊùâ‰∏¶Âå∫È´òÂÜÜÂØ∫Âåó1-2-3", facilityCategory: "‰øùËÇ≤ÊâÄ", openingHours: "07:00-19:00", latitudeLongitude: "35.7052, 139.6498" },
        { status: "Published", localGovernmentCode: "131016", identifier: "cc-002", facilityName: "„Å≤„Åæ„Çè„ÇäÂπºÁ®öÂúí", address: "Êù±‰∫¨ÈÉΩÊùâ‰∏¶Âå∫Èòø‰ΩêË∞∑Âçó2-4-6", facilityCategory: "ÂπºÁ®öÂúí", openingHours: "08:30-14:00", latitudeLongitude: "35.7034, 139.6356" },
        { status: "Published", localGovernmentCode: "131016", identifier: "cc-003", facilityName: "„Å§„Å∞„ÇÅÂ≠¶Á´•„ÇØ„É©„Éñ", address: "Êù±‰∫¨ÈÉΩÊùâ‰∏¶Âå∫ËçªÁ™™3-5-8", facilityCategory: "Â≠¶Á´•‰øùËÇ≤", openingHours: "14:00-19:00", latitudeLongitude: "35.7089, 139.6201" },
        { status: "Draft", localGovernmentCode: "131016", identifier: "cc-004", facilityName: "„Åì„Åô„ÇÇ„Åô‰øùËÇ≤Âúí", address: "Êù±‰∫¨ÈÉΩÊùâ‰∏¶Âå∫Ë•øËçªÂåó4-7-9", facilityCategory: "‰øùËÇ≤ÊâÄ", openingHours: "07:30-18:30", latitudeLongitude: "35.7123, 139.5989" }
      ],
      "aed-locations": [
        { status: "Published", localGovernmentCode: "131016", identifier: "aed-001", name: "Êñ∞ÂÆøÂå∫ÂΩπÊâÄ 1FÂèó‰ªò", installationPlace: "Ê≠£Èù¢ÁéÑÈñ¢ÂÖ•Âè£Âè≥ÂÅ¥", address: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Ê≠åËàû‰ºéÁî∫1-4-1", pediatricSupport: "yes", contactPhone: "03-3209-1111", latitudeLongitude: "35.6938, 139.7035" },
        { status: "Published", localGovernmentCode: "131016", identifier: "aed-002", name: "Êñ∞ÂÆøÈßÖÊù±Âè£‰∫§Áï™", installationPlace: "‰∫§Áï™ÂÜÖÂÖ•Âè£‰ªòËøë", address: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Êñ∞ÂÆø3-38-1", pediatricSupport: "yes", contactPhone: "03-3354-0110", latitudeLongitude: "35.6896, 139.7006" },
        { status: "Published", localGovernmentCode: "131016", identifier: "aed-003", name: "Êñ∞ÂÆø‰∏≠Â§ÆÂÖ¨ÂúíÁÆ°ÁêÜ‰∫ãÂãôÊâÄ", installationPlace: "ÁÆ°ÁêÜÊ£ü1F‰∫ãÂãôÂÆ§", address: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Ë•øÊñ∞ÂÆø2-11", pediatricSupport: "no", contactPhone: "03-3342-4509", latitudeLongitude: "35.6912, 139.6891" },
        { status: "Draft", localGovernmentCode: "131016", identifier: "aed-004", name: "Êñ∞ÂÆø„Çπ„Éù„Éº„ÉÑ„Çª„É≥„Çø„Éº", installationPlace: "2F„É≠„Éì„ÉºËá™Ë≤©Ê©üÊ®™", address: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Â§ß‰πÖ‰øù3-5-1", pediatricSupport: "yes", contactPhone: "03-3232-0171", latitudeLongitude: "35.7012, 139.6978" },
        { status: "Draft", localGovernmentCode: "131016", identifier: "aed-005", name: "ËêΩÂêàÁ¨¨‰∏ÄÂú∞Âüü„Çª„É≥„Çø„Éº", installationPlace: "1F‰∫ãÂãôÂÆ§ÂâçÂªä‰∏ã", address: "Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫‰∏ãËêΩÂêà4-6-7", pediatricSupport: "no", contactPhone: "03-3954-6611", latitudeLongitude: "35.7156, 139.6834" }
      ]
    };

    let currentModelId = "public-facilities";
    let currentGroupId = null; // null means viewing model, otherwise viewing group

    // Group store with fields for each group
    const groupStore = {
      "name": {
        label: "ÂêçÁß∞ (Name)",
        key: "name",
        fields: [
          { label: "Âú∞ÊñπÂÖ¨ÂÖ±Âõ£‰ΩìÂêç", key: "localGovernmentName", type: "Text" },
          { label: "ÂêçÁß∞", key: "name", type: "Text", required: true },
          { label: "ÂêçÁß∞_„Ç´„Éä", key: "nameKana", type: "Text" },
          { label: "ÂêçÁß∞_Ëã±Â≠ó", key: "nameEn", type: "Text" },
          { label: "ÂêçÁß∞_ÈÄöÁß∞", key: "alternateName", type: "Text" }
        ],
        meta: [
          { display: "Âú∞ÊñπÂÖ¨ÂÖ±Âõ£‰ΩìÂêç", key: "localGovernmentName", required: false },
          { display: "ÂêçÁß∞", key: "name", required: true },
          { display: "ÂêçÁß∞_„Ç´„Éä", key: "nameKana", required: false },
          { display: "ÂêçÁß∞_Ëã±Â≠ó", key: "nameEn", required: false },
          { display: "ÂêçÁß∞_ÈÄöÁß∞", key: "alternateName", required: false }
        ]
      },
      "external-id": {
        label: "Â§ñÈÉ®Ë≠òÂà•Â≠ê",
        key: "externalId",
        fields: [
          { label: "Â§ñÈÉ®Ë≠òÂà•Â≠ê„Çø„Ç§„Éó", key: "externalIdentifierType", type: "Text" },
          { label: "Â§ñÈÉ®Ë≠òÂà•Â≠ê", key: "externalIdentifier", type: "Text" }
        ],
        meta: [
          { display: "Â§ñÈÉ®Ë≠òÂà•Â≠ê„Çø„Ç§„Éó", key: "externalIdentifierType", required: false },
          { display: "Â§ñÈÉ®Ë≠òÂà•Â≠ê", key: "externalIdentifier", required: false }
        ]
      },
      "address": {
        label: "ÊâÄÂú®Âú∞ (Address)",
        key: "address",
        fields: [
          { label: "ÊâÄÂú®Âú∞", key: "address", type: "Text" },
          { label: "ÊñπÊõ∏", key: "addressDetail", type: "Text" },
          { label: "ÈÉµ‰æøÁï™Âè∑", key: "postalCode", type: "Text" }
        ],
        meta: [
          { display: "ÊâÄÂú®Âú∞", key: "address", required: true },
          { display: "ÊñπÊõ∏", key: "addressDetail", required: false },
          { display: "ÈÉµ‰æøÁï™Âè∑", key: "postalCode", required: false }
        ]
      },
      "contact": {
        label: "ÈÄ£Áµ°ÂÖà (Contact)",
        key: "contact",
        fields: [
          { label: "ÈõªË©±Áï™Âè∑", key: "telephone", type: "Text" },
          { label: "ÂÜÖÁ∑öÁï™Âè∑", key: "extension", type: "Text" },
          { label: "FAXÁï™Âè∑", key: "fax", type: "Text" },
          { label: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ", key: "email", type: "Text" }
        ],
        meta: [
          { display: "ÈõªË©±Áï™Âè∑", key: "telephone", required: false },
          { display: "ÂÜÖÁ∑öÁï™Âè∑", key: "extension", required: false },
          { display: "FAXÁï™Âè∑", key: "fax", required: false },
          { display: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ", key: "email", required: false }
        ]
      },
      "schedule": {
        label: "Âà©Áî®ÂèØËÉΩÊôÇÈñì",
        key: "schedule",
        fields: [
          { label: "Âà©Áî®ÂèØËÉΩÊõúÊó•", key: "availableDays", type: "Option" },
          { label: "ÈñãÂßãÊôÇÈñì", key: "startTime", type: "Text" },
          { label: "ÁµÇ‰∫ÜÊôÇÈñì", key: "endTime", type: "Text" },
          { label: "Âà©Áî®ÂèØËÉΩÊôÇÈñìÁâπË®ò‰∫ãÈ†Ö", key: "scheduleNote", type: "TextArea" }
        ],
        meta: [
          { display: "Âà©Áî®ÂèØËÉΩÊõúÊó•", key: "availableDays", required: false },
          { display: "ÈñãÂßãÊôÇÈñì", key: "startTime", required: false },
          { display: "ÁµÇ‰∫ÜÊôÇÈñì", key: "endTime", required: false },
          { display: "Âà©Áî®ÂèØËÉΩÊôÇÈñìÁâπË®ò‰∫ãÈ†Ö", key: "scheduleNote", required: false }
        ]
      },
      "accessibility": {
        label: "ËªäÊ§ÖÂ≠ê",
        key: "accessibility",
        fields: [
          { label: "ËªäÊ§ÖÂ≠êÂØæÂøú", key: "wheelchairAccessible", type: "Boolean" },
          { label: "„Éê„É™„Ç¢„Éï„É™„ÉºÂØæÂøú", key: "barrierFree", type: "Boolean" },
          { label: "ÂÇôËÄÉ", key: "accessibilityNote", type: "TextArea" }
        ],
        meta: [
          { display: "ËªäÊ§ÖÂ≠êÂØæÂøú", key: "wheelchairAccessible", required: false },
          { display: "„Éê„É™„Ç¢„Éï„É™„ÉºÂØæÂøú", key: "barrierFree", required: false },
          { display: "ÂÇôËÄÉ", key: "accessibilityNote", required: false }
        ]
      },
      "media": {
        label: "ÁîªÂÉè (Media)",
        key: "media",
        fields: [
          { label: "ÁîªÂÉè", key: "image", type: "Asset" },
          { label: "ÁîªÂÉè_„É©„Ç§„Çª„É≥„Çπ", key: "imageLicense", type: "Text" },
          { label: "URL", key: "url", type: "URL" }
        ],
        meta: [
          { display: "ÁîªÂÉè", key: "image", required: false },
          { display: "ÁîªÂÉè_„É©„Ç§„Çª„É≥„Çπ", key: "imageLicense", required: false },
          { display: "URL", key: "url", required: false }
        ]
      }
    };

    let groupList = ["name", "external-id", "address", "contact", "schedule", "accessibility", "media"];

    // GIF Group Ê®°ÊùøÂÆö‰πâ
    const gifGroupTemplates = [
      { id: 'name', label: 'ÊñΩË®≠', labelEn: 'Facility', icon: 'üè¢' },
      { id: 'external-id', label: 'Â§ñÈÉ®Ë≠òÂà•Â≠ê', labelEn: 'External ID', icon: 'üîó' },
      { id: 'address', label: 'ÊâÄÂú®Âú∞', labelEn: 'Address', icon: 'üìç' },
      { id: 'contact', label: 'ÈÄ£Áµ°ÂÖà', labelEn: 'Contact', icon: 'üìû' },
      { id: 'schedule', label: 'Âà©Áî®ÂèØËÉΩÊôÇÈñì', labelEn: 'Schedule', icon: 'üïê' },
      { id: 'accessibility', label: 'Accessibility', labelEn: 'Accessibility', icon: '‚ôø' },
      { id: 'media', label: 'ÁîªÂÉè', labelEn: 'Media', icon: 'üñºÔ∏è' }
    ];

    // ÊâìÂºÄ/ÂÖ≥Èó≠ New Group Modal
    function openNewGroupModal() {
      document.getElementById('add-group-menu').classList.remove('active');
      document.getElementById('new-group-modal-backdrop').style.display = 'flex';
      // Ê∏ÖÁ©∫Ë°®Âçï
      document.getElementById('new-group-name').value = '';
      document.getElementById('new-group-description').value = '';
      document.getElementById('new-group-key').value = '';
      document.getElementById('group-key-count').textContent = '0';
      document.getElementById('new-group-save').disabled = true;
    }

    function closeNewGroupModal() {
      document.getElementById('new-group-modal-backdrop').style.display = 'none';
    }

    // ÊâìÂºÄ/ÂÖ≥Èó≠ GIF Group Modal
    function openGifGroupModal() {
      document.getElementById('add-group-menu').classList.remove('active');
      document.getElementById('gif-group-modal-backdrop').style.display = 'flex';
      document.getElementById('gif-group-search').value = '';
      renderGifGroupList();
    }

    function closeGifGroupModal() {
      document.getElementById('gif-group-modal-backdrop').style.display = 'none';
    }

    // Ê∏≤Êüì GIF Group ÂàóË°®
    function renderGifGroupList(filter = '') {
      const container = document.getElementById('gif-group-list');
      const filtered = gifGroupTemplates.filter(g =>
        g.label.includes(filter) ||
        g.labelEn.toLowerCase().includes(filter.toLowerCase())
      );

      container.innerHTML = filtered.map(g => `
        <div class="gif-group-item" data-group-id="${g.id}">
          <div class="group-icon">${g.icon}</div>
          <div class="group-info">
            <div class="group-name">${g.label}</div>
            <div class="group-name-en">${g.labelEn}</div>
          </div>
        </div>
      `).join('');
    }

    // ÈÄâÊã© GIF Group - Ë∑≥ËΩ¨Âà∞ËØ• Group
    function selectGifGroup(groupId) {
      closeGifGroupModal();
      // Â¶ÇÊûú Group Â∑≤Â≠òÂú®ÔºåÁõ¥Êé•Ë∑≥ËΩ¨
      if (groupList.includes(groupId)) {
        currentGroupId = groupId;
        const group = groupStore[groupId];
        
        // Update header
        const titleEl = document.getElementById('schema-model-title');
        const keyEl = document.getElementById('schema-model-key');
        const backBtn = document.getElementById('schema-back-btn');
        if (titleEl) titleEl.textContent = group.label;
        if (keyEl) keyEl.textContent = '#' + group.key;
        if (backBtn) backBtn.classList.remove('hidden');

        renderModelList();
        renderGroups();
        renderFields();
        removePlaceholder();
      }
    }

    // ÂàõÂª∫Êñ∞ Group
    function createNewGroup() {
      const name = document.getElementById('new-group-name').value.trim();
      const description = document.getElementById('new-group-description').value.trim();
      const key = document.getElementById('new-group-key').value.trim();

      // È™åËØÅ
      if (!name || !key || key.length < 3) return;
      if (!/^[a-zA-Z0-9_-]+$/.test(key)) return;
      if (groupStore[key]) {
        alert('Group key already exists');
        return;
      }

      // ÂàõÂª∫Êñ∞ Group
      groupStore[key] = {
        label: name,
        key: key,
        description: description,
        fields: [],
        meta: []
      };
      groupList.push(key);

      closeNewGroupModal();
      currentGroupId = key;
      
      // Update header
      const titleEl = document.getElementById('schema-model-title');
      const keyEl = document.getElementById('schema-model-key');
      const backBtn = document.getElementById('schema-back-btn');
      if (titleEl) titleEl.textContent = groupStore[key].label;
      if (keyEl) keyEl.textContent = '#' + groupStore[key].key;
      if (backBtn) backBtn.classList.remove('hidden');

      renderModelList();
      renderGroups();
      renderFields();
      removePlaceholder();
    }

    // ÂàùÂßãÂåñ Group Add ‰∫ã‰ª∂
    function initGroupAddEvents() {
      const btn = document.getElementById('add-group-btn');
      const menu = document.getElementById('add-group-menu');

      // ‰∏ãÊãâËèúÂçïÂàáÊç¢
      btn?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = menu.classList.toggle('active');
        if (isActive) {
          // Âä®ÊÄÅÂÆö‰Ωç dropdownÔºà‰ΩøÁî® fixed ÂÆö‰ΩçÈÅøÂÖçË¢´ overflow Ë£ÅÂâ™Ôºâ
          const rect = btn.getBoundingClientRect();
          menu.style.top = (rect.bottom + 4) + 'px';
          menu.style.left = rect.left + 'px';
        }
      });

      // New Group ÈÄâÈ°π
      document.getElementById('new-group-option')?.addEventListener('click', openNewGroupModal);

      // GIF Group ÈÄâÈ°π
      document.getElementById('gif-group-option')?.addEventListener('click', openGifGroupModal);

      // GIF Group ÊêúÁ¥¢
      document.getElementById('gif-group-search')?.addEventListener('input', (e) => {
        renderGifGroupList(e.target.value);
      });

      // GIF Group ÈÄâÊã©
      document.getElementById('gif-group-list')?.addEventListener('click', (e) => {
        const item = e.target.closest('.gif-group-item');
        if (item) selectGifGroup(item.dataset.groupId);
      });

      // New Group Ë°®ÂçïÈ™åËØÅ
      const nameInput = document.getElementById('new-group-name');
      const keyInput = document.getElementById('new-group-key');

      function validateNewGroupForm() {
        const name = nameInput?.value.trim();
        const key = keyInput?.value.trim();
        const valid = name && key && key.length >= 3 && /^[a-zA-Z0-9_-]+$/.test(key);
        document.getElementById('new-group-save').disabled = !valid;
      }

      nameInput?.addEventListener('input', validateNewGroupForm);
      keyInput?.addEventListener('input', (e) => {
        document.getElementById('group-key-count').textContent = e.target.value.length;
        validateNewGroupForm();
      });

      // ÂàõÂª∫ Group
      document.getElementById('new-group-save')?.addEventListener('click', createNewGroup);
      document.getElementById('new-group-cancel')?.addEventListener('click', closeNewGroupModal);
      document.getElementById('new-group-modal-close')?.addEventListener('click', closeNewGroupModal);
      document.getElementById('gif-group-modal-close')?.addEventListener('click', closeGifGroupModal);

      // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ËèúÂçï
      document.addEventListener('click', (e) => {
        if (!menu?.contains(e.target) && e.target !== btn) {
          menu?.classList.remove('active');
        }
      });

      // ÁÇπÂáª backdrop ÂÖ≥Èó≠ modal
      document.getElementById('new-group-modal-backdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'new-group-modal-backdrop') closeNewGroupModal();
      });
      document.getElementById('gif-group-modal-backdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'gif-group-modal-backdrop') closeGifGroupModal();
      });
    }

    function currentFields() {
      if (currentGroupId && groupStore[currentGroupId]) {
        return groupStore[currentGroupId].fields;
      }
      return modelStore[currentModelId].fields;
    }
    function currentMeta() {
      if (currentGroupId && groupStore[currentGroupId]) {
        return groupStore[currentGroupId].meta;
      }
      return modelStore[currentModelId].meta;
    }
    function currentGroups() {
      return modelStore[currentModelId].groups || [];
    }
    const placeholder = document.createElement('div');
    placeholder.className = 'field-placeholder';
    let currentPlaceholderIndex = null;

    function removePlaceholder() {
      if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
      currentPlaceholderIndex = null;
    }

    function placeholderIndex() {
      if (!fieldListEl) return fields.length;
      const children = Array.from(fieldListEl.children);
      let idx = 0;
      for (const child of children) {
        if (child === placeholder) break;
        if (child.classList.contains('field-card')) idx++;
      }
      return idx;
    }

    function showPlaceholderAt(idx) {
      if (idx === currentPlaceholderIndex) return;
      removePlaceholder();
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      if (cards[idx]) {
        fieldListEl.insertBefore(placeholder, cards[idx]);
      } else {
        fieldListEl.appendChild(placeholder);
      }
      currentPlaceholderIndex = idx;
    }

    function calcInsertIndex(clientY) {
      const cards = Array.from(fieldListEl.querySelectorAll('.field-card'));
      for (let i = 0; i < cards.length; i++) {
        const rect = cards[i].getBoundingClientRect();
        const upper = rect.top + rect.height * 0.35;
        const lower = rect.bottom - rect.height * 0.35;
        if (clientY < upper) return i;         // top zone: insert before
        if (clientY > lower) continue;         // bottom zone: keep scanning
        return i + 1;                          // middle zone: insert after
      }
      return cards.length;
    }

    function addField(item, index = currentFields().length) {
      let key, newField;

      if (item.isGroup && item.groupId) {
        // Group field - use the group's key so it matches for the group icon
        const group = groupStore[item.groupId];
        key = group ? group.key : item.groupId;
        newField = {
          label: item.label,
          key,
          type: 'Group',
          meta: 'Group reference',
          groupId: item.groupId
        };
      } else {
        // Regular field
        key = `${item.type.toLowerCase()}_${(Date.now()).toString(36).slice(-4)}`;
        newField = { label: item.label, key, type: item.type, meta: item.desc };
      }

      currentFields().splice(index, 0, newField);
      currentMeta().splice(index, 0, {
        display: item.label,
        key,
        description: "",
        required: false,
        options: [],
        allowMultiple: false,
        pattern: "",
        defaultValue: ""
      });
      renderFields();
      removePlaceholder();
    }

    function getFieldTypeIcon(type) {
      const iconMap = {
        'Text': { icon: 'T', class: 'text' },
        'TextArea': { icon: '‚â°', class: 'textarea' },
        'Markdown': { icon: 'MD', class: 'markdown' },
        'Asset': { icon: 'üìÅ', class: 'asset' },
        'Date': { icon: 'üìÖ', class: 'date' },
        'Boolean': { icon: '‚óê', class: 'boolean' },
        'Option': { icon: '‚â°', class: 'option' },
        'Int': { icon: '9', class: 'int' },
        'Float': { icon: '‚àû', class: 'float' },
        'Coordinate': { icon: 'üìç', class: 'coordinate' },
        'URL': { icon: 'üîó', class: 'url' },
        'Reference': { icon: '‚Üó', class: 'group' },
        'Group': { icon: '‚â°', class: 'group' }
      };
      return iconMap[type] || { icon: 'T', class: 'text' };
    }

    // Check if a field label matches a group name and return the group id
    function findMatchingGroup(fieldLabel) {
      for (const groupId of groupList) {
        const group = groupStore[groupId];
        if (group && group.label === fieldLabel) {
          return groupId;
        }
      }
      return null;
    }

    function renderFields() {
      if (!fieldListEl) return;
      fieldListEl.innerHTML = "";
      currentFields().forEach((f, idx) => {
        const card = document.createElement('div');
        card.className = 'field-card';
        card.dataset.index = idx;
        const meta = currentMeta()[idx];
        const isRequired = meta?.required || f.required;
        const requiredMark = isRequired ? '*' : '';

        // Check if this field is a group reference (either by label match or direct groupId)
        let matchingGroupId = f.groupId || findMatchingGroup(f.label);
        const isGroupField = matchingGroupId !== null && groupStore[matchingGroupId];

        let iconHtml;
        if (isGroupField) {
          iconHtml = `<div class="schema-group-icon field-group-icon"><span></span><span></span></div>`;
        } else {
          const typeInfo = getFieldTypeIcon(f.type);
          iconHtml = `<div class="field-type-icon ${typeInfo.class}">${typeInfo.icon}</div>`;
        }

        card.innerHTML = `
          <span class="drag-handle" draggable="true" title="Drag">‚â°</span>
          ${iconHtml}
          <div class="field-card-center">
            <span class="field-card-name">${f.label}${requiredMark}</span>
            <span class="field-card-key">#${f.key}</span>
          </div>
          <div class="field-card-right">
            <button class="field-card-action field-delete-btn" title="Delete" data-index="${idx}">üóë</button>
            <button class="field-card-action" title="More" onclick="event.stopPropagation();">‚ãØ</button>
          </div>
        `;

        // Delete button handler
        const deleteBtn = card.querySelector('.field-delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const fieldIndex = parseInt(deleteBtn.dataset.index);
            if (confirm(`Delete field "${f.label}"?`)) {
              currentFields().splice(fieldIndex, 1);
              currentMeta().splice(fieldIndex, 1);
              renderFields();
            }
          });
        }

        // Click handler - if group field, navigate to group; otherwise open modal
        if (isGroupField) {
          card.style.cursor = 'pointer';
          card.addEventListener('click', () => {
            currentGroupId = matchingGroupId;
            const group = groupStore[matchingGroupId];
            const titleEl = document.getElementById('schema-model-title');
            const keyEl = document.getElementById('schema-model-key');
            const backBtn = document.getElementById('schema-back-btn');
            if (titleEl) titleEl.textContent = group.label;
            if (keyEl) keyEl.textContent = '#' + group.key;
            if (backBtn) backBtn.classList.remove('hidden');
            renderModelList();
            renderGroups();
            renderFields();
            removePlaceholder();
          });
        } else {
          card.addEventListener('click', () => openModal(idx));
        }
        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          card.classList.add('drop-target');
          const insertIdx = calcInsertIndex(e.clientY);
          showPlaceholderAt(insertIdx);
        });
        card.addEventListener('dragleave', () => {
          card.classList.remove('drop-target');
        });
        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drop-target');
          const data = e.dataTransfer.getData('application/json');
          if (!data) return;
          const item = JSON.parse(data);
          const insertIdx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
          addField(item, insertIdx);
        });
        fieldListEl.appendChild(card);
      });
    }

    function renderModelList() {
      const container = document.getElementById('model-list');
      if (!container) return;
      container.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const item = document.createElement('div');
        item.className = 'schema-model-item';
        // Only show as active if viewing model (not a group) and this is the current model
        if (id === currentModelId && currentGroupId === null) item.classList.add('active');
        item.dataset.model = id;
        item.textContent = modelStore[id].label;
        item.addEventListener('click', () => {
          currentModelId = id;
          currentGroupId = null; // Clear group selection when clicking on model
          // Update header title and key
          const titleEl = document.getElementById('schema-model-title');
          const keyEl = document.getElementById('schema-model-key');
          const backBtn = document.getElementById('schema-back-btn');
          if (titleEl) titleEl.textContent = modelStore[id].label;
          if (keyEl) keyEl.textContent = '#' + id.replace(/-/g, '_');
          if (backBtn) backBtn.classList.add('hidden');
          renderModelList();
          renderGroups();
          renderFields();
          removePlaceholder();
        });
        container.appendChild(item);
      });
    }

    function renderGroups() {
      const container = document.getElementById('group-list');
      if (!container) return;
      container.innerHTML = "";
      groupList.forEach((groupId) => {
        const group = groupStore[groupId];
        if (!group) return;
        const row = document.createElement('div');
        row.className = 'schema-group-item';
        row.draggable = true;
        if (currentGroupId === groupId) row.classList.add('active');
        row.dataset.group = groupId;
        row.innerHTML = `
          <div class="schema-group-icon"><span></span><span></span></div>
          <span>${group.label}</span>
        `;
        // Drag handler - allow dragging group into field list
        row.addEventListener('dragstart', (e) => {
          const groupData = {
            label: group.label,
            type: 'Group',
            desc: 'Group reference',
            groupId: groupId,
            isGroup: true
          };
          e.dataTransfer.setData('application/json', JSON.stringify(groupData));
        });
        row.addEventListener('click', () => {
          currentGroupId = groupId;
          // Update header title and key
          const titleEl = document.getElementById('schema-model-title');
          const keyEl = document.getElementById('schema-model-key');
          const backBtn = document.getElementById('schema-back-btn');
          if (titleEl) titleEl.textContent = group.label;
          if (keyEl) keyEl.textContent = '#' + group.key;
          if (backBtn) backBtn.classList.remove('hidden');
          renderModelList();
          renderGroups();
          renderFields();
          removePlaceholder();
        });
        container.appendChild(row);
      });
    }

    function getPaletteIcon(type) {
      const iconMap = {
        'Text': { icon: 'T', class: 'text' },
        'TextArea': { icon: '‚â°', class: 'textarea' },
        'Markdown': { icon: 'MD', class: 'markdown' },
        'Asset': { icon: 'üìÅ', class: 'asset' },
        'Date': { icon: 'üìÖ', class: 'date' },
        'Boolean': { icon: '‚óê', class: 'boolean' },
        'Option': { icon: '‚â°', class: 'option' },
        'Int': { icon: '9', class: 'int' },
        'Float': { icon: '‚àû', class: 'float' },
        'Coordinate': { icon: 'üìç', class: 'coordinate' },
        'URL': { icon: 'üîó', class: 'url' },
        'Reference': { icon: '‚Üó', class: 'group' }
      };
      return iconMap[type] || { icon: 'T', class: 'text' };
    }

    function renderPalette() {
      if (!paletteEl) return;
      paletteEl.innerHTML = "";
      paletteGroups.forEach(group => {
        const wrapper = document.createElement('div');
        wrapper.className = 'palette-group';
        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = group.title;
        wrapper.appendChild(title);
        group.items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'palette-item';
          el.draggable = true;
          el.dataset.type = item.type;
          el.dataset.label = item.label;
          const iconInfo = getPaletteIcon(item.type);
          el.innerHTML = `
            <div class="palette-item-icon ${iconInfo.class}">${iconInfo.icon}</div>
            <div class="palette-item-content">
              <strong>${item.label}</strong>
              <span>${item.desc}</span>
            </div>
          `;
          el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('application/json', JSON.stringify(item));
          });
          wrapper.appendChild(el);
        });
        paletteEl.appendChild(wrapper);
      });
    }

    if (fieldListEl) {
      fieldListEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "#2563eb";
        const insertIdx = calcInsertIndex(e.clientY);
        showPlaceholderAt(insertIdx);
      });

      fieldListEl.addEventListener('dragleave', () => {
        fieldListEl.style.borderColor = "var(--border)";
        removePlaceholder();
      });

      fieldListEl.addEventListener('drop', (e) => {
        e.preventDefault();
        fieldListEl.style.borderColor = "var(--border)";
        const idx = placeholder.parentNode ? placeholderIndex() : calcInsertIndex(e.clientY);
        const data = e.dataTransfer.getData('application/json');
        if (!data) return;
        const item = JSON.parse(data);
        addField(item, idx); // drop at placeholder or calculated position
      });
    }
  </script>
  <script>
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalSave = document.getElementById('modal-save');
    const tabs = document.querySelectorAll('.modal-tab');
    const panes = document.querySelectorAll('.modal-pane');
    const displayInput = document.getElementById('field-display');
    const keyInput = document.getElementById('field-key');
    const descInput = document.getElementById('field-desc');
    const optionsSection = document.getElementById('field-options-section');
    const optionsInput = document.getElementById('field-options');
    const multiInput = document.getElementById('field-multi');
    const requiredInput = document.getElementById('field-required');
    const patternSection = document.getElementById('field-pattern-section');
    const patternInput = document.getElementById('field-pattern');
    const defaultInput = document.getElementById('field-default');
    let editingIndex = null;

    function switchTab(tabName) {
      tabs.forEach(t => {
        const active = t.dataset.tab === tabName;
        t.classList.toggle('active', active);
      });
      panes.forEach(p => {
        const show = p.dataset.pane === tabName;
        p.classList.toggle('hidden', !show);
      });
    }
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

    function openModal(idx) {
      editingIndex = idx;
      const f = currentFields()[idx];
      const meta = currentMeta()[idx];
      modalTitle.textContent = `${meta.display || f.label}`;
      displayInput.value = meta.display || f.label || "";
      keyInput.value = meta.key || f.key || "";
      descInput.value = meta.description || "";
      optionsSection.style.display = f.type === "Option" ? "grid" : "none";
      optionsInput.value = (meta.options || []).join(",");
      multiInput.checked = !!meta.allowMultiple;
      requiredInput.checked = !!meta.required;
      patternSection.style.display = f.type === "Text" || f.type === "Coordinate" ? "block" : "none";
      patternInput.value = meta.pattern || "";
      defaultInput.value = meta.defaultValue || "";
      switchTab("settings");
      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      editingIndex = null;
    }
    modalClose.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    modalSave.addEventListener('click', () => {
      if (editingIndex === null) return closeModal();
      const f = currentFields()[editingIndex];
      const meta = currentMeta()[editingIndex];
      meta.display = displayInput.value.trim() || f.label;
      meta.key = keyInput.value.trim() || f.key;
      meta.description = descInput.value.trim();
      if (f.type === "Option") {
        meta.options = optionsInput.value
          .split(",")
          .map((v) => v.trim())
          .filter(Boolean);
        meta.allowMultiple = multiInput.checked;
      }
      meta.required = requiredInput.checked;
      meta.pattern = patternInput.value.trim();
      meta.defaultValue = defaultInput.value;

      // sync display/key back to field for rendering
      f.label = meta.display;
      f.key = meta.key;
      f.meta = meta.description;
      renderFields();
      closeModal();
    });

    function ensureModelFromTemplate(tplId) {
      if (modelStore[tplId]) return;
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      const baseFields = tpl.id === "aed-locations" ? modelStore["aed-locations"].fields : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].fields : modelStore["public-facilities"].fields;
      const baseMeta = tpl.id === "aed-locations" ? modelStore["aed-locations"].meta : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].meta : modelStore["public-facilities"].meta;
      modelStore[tplId] = {
        label: tpl.label,
        fields: JSON.parse(JSON.stringify(baseFields)),
        meta: JSON.parse(JSON.stringify(baseMeta)),
        groups: tpl.id === "aed-locations" ? modelStore["aed-locations"].groups : tpl.id === "childcare-facilities" ? modelStore["childcare-facilities"].groups : modelStore["public-facilities"].groups
      };
    }

    function applyTemplate(tplId) {
      ensureModelFromTemplate(tplId);
      currentModelId = tplId;
      renderModelList();
      renderGroups();
      renderFields();
      removePlaceholder();
      // Switch to Schema view
      switchView('schema');
      closeTemplateModal();
    }

    function renderTemplates() {
      const container = document.getElementById('templates-cards');
      if (!container) return;
      container.innerHTML = "";
      templateList.forEach((tpl) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>${tpl.label}</h3><span class="badge">Template</span>
          </div>
          <div class="muted">#${tpl.key} ‚Ä¢ ${tpl.version || ""}</div>
          <div class="muted">${tpl.summary || ""}</div>
          <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
            <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
          </div>
          <div style="position:absolute; right:10px; bottom:10px;">
            <div class="dropdown menu-wrap">
              <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">‚ãØ</button>
              <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Templates view apply buttons (delegated)
    document.addEventListener('click', (e) => {
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
      }
    });

    // New Model dropdown
    const newModelBtn = document.getElementById('new-model-btn');
    const newModelMenu = document.getElementById('new-model-menu');
    newModelBtn?.addEventListener('click', () => {
      newModelMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!newModelMenu.contains(e.target) && e.target !== newModelBtn) {
        newModelMenu.classList.remove('active');
      }
    });
    newModelMenu?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'template') {
        openTemplateModal();
      }
      if (e.target.dataset.action === 'blank') {
        const id = `custom-${Date.now()}`;
        modelStore[id] = { label: "Custom Model", fields: [], meta: [], groups: ["Âü∫Êú¨ÊÉÖÂ†±"] };
        currentModelId = id;
        renderModelList();
        renderGroups();
        renderFields();
        removePlaceholder();
        switchView('schema');
      }
    });

    // Template modal handlers
    const templateModal = document.getElementById('template-modal-backdrop');
    const templateModalCards = document.getElementById('template-modal-cards');
    const templateSearch = document.getElementById('template-search');
    const templateFilter = document.getElementById('template-filter');
    document.getElementById('template-modal-close').addEventListener('click', closeTemplateModal);
    document.getElementById('template-modal-cancel').addEventListener('click', closeTemplateModal);

    // Template edit modal
    const tplEditBackdrop = document.getElementById('template-edit-backdrop');
    const tplEditTitle = document.getElementById('template-edit-title');
    const tplEditLabel = document.getElementById('tpl-edit-label');
    const tplEditKey = document.getElementById('tpl-edit-key');
    const tplEditVersion = document.getElementById('tpl-edit-version');
    const tplEditCategory = document.getElementById('tpl-edit-category');
    const tplEditSummary = document.getElementById('tpl-edit-summary');
    const tplEditSave = document.getElementById('tpl-edit-save');
    const tplEditClose = document.getElementById('template-edit-close');
    const tplEditCancel = document.getElementById('tpl-edit-cancel');
    let editingTemplateId = null;

    function renderTemplateModalCards() {
      const query = (templateSearch?.value || "").toLowerCase();
      const filter = templateFilter?.value || "all";
      templateModalCards.innerHTML = "";
      templateList
        .filter((tpl) => {
          const matchText = tpl.label.toLowerCase().includes(query) || tpl.key.toLowerCase().includes(query) || (tpl.summary || "").toLowerCase().includes(query);
          const matchCat = filter === "all" || tpl.category === filter;
          return matchText && matchCat;
        })
        .forEach((tpl) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>${tpl.label}</h3><span class="badge">Template</span>
            </div>
            <div class="muted">#${tpl.key} ‚Ä¢ ${tpl.version || ""} ‚Ä¢ ${tpl.category || ""}</div>
            <div class="muted">${tpl.summary || ""}</div>
            <div class="row" style="justify-content:flex-start; align-items:center; gap:6px;">
              <button class="btn primary" data-action="apply-template" data-id="${tpl.id}">Use Template</button>
            </div>
            <div style="position:absolute; right:10px; bottom:10px;">
              <div class="dropdown menu-wrap">
                <button class="btn icon-btn tpl-menu-btn" data-id="${tpl.id}">‚ãØ</button>
                <div class="dropdown-menu tpl-menu" data-id="${tpl.id}">
                  <button data-action="preview-template" data-id="${tpl.id}">Preview</button>
                  <button data-action="edit-template" data-id="${tpl.id}">Edit</button>
                </div>
              </div>
            </div>
          `;
          templateModalCards.appendChild(card);
        });
    }
    function openTemplateModal() {
      renderTemplateModalCards();
      templateModal.style.display = "flex";
    }
    function closeTemplateModal() {
      templateModal.style.display = "none";
    }
    templateSearch?.addEventListener('input', renderTemplateModalCards);
    templateFilter?.addEventListener('change', renderTemplateModalCards);
    templateModal.addEventListener('click', (e) => {
      if (e.target === templateModal) closeTemplateModal();
    });

    function openTemplateEditModal(tplId) {
      const tpl = templateList.find((t) => t.id === tplId);
      if (!tpl) return;
      editingTemplateId = tplId;
      tplEditTitle.textContent = tpl.label;
      tplEditLabel.value = tpl.label;
      tplEditKey.value = tpl.key;
      tplEditVersion.value = tpl.version || "";
      tplEditCategory.value = tpl.category || "";
      tplEditSummary.value = tpl.summary || "";
      tplEditBackdrop.style.display = "flex";
    }
    function closeTemplateEditModal() {
      tplEditBackdrop.style.display = "none";
      editingTemplateId = null;
    }
    tplEditClose.addEventListener('click', closeTemplateEditModal);
    tplEditCancel.addEventListener('click', closeTemplateEditModal);
    tplEditBackdrop.addEventListener('click', (e) => {
      if (e.target === tplEditBackdrop) closeTemplateEditModal();
    });
    tplEditSave.addEventListener('click', () => {
      if (!editingTemplateId) return closeTemplateEditModal();
      const tpl = templateList.find((t) => t.id === editingTemplateId);
      if (!tpl) return closeTemplateEditModal();
      tpl.label = tplEditLabel.value.trim() || tpl.label;
      tpl.key = tplEditKey.value.trim() || tpl.key;
      tpl.version = tplEditVersion.value.trim();
      tpl.category = tplEditCategory.value.trim() || tpl.category;
      tpl.summary = tplEditSummary.value.trim();
      renderTemplates();
      renderTemplateModalCards();
      renderModelList();
      closeTemplateEditModal();
    });
    // delegated template menu (apply/preview/edit)
    document.addEventListener('click', (e) => {
      const menuBtn = e.target.closest('.tpl-menu-btn');
      if (menuBtn) {
        e.stopPropagation();
        const id = menuBtn.dataset.id;
        closeAllTplMenus();
        toggleTplMenu(id);
        return;
      }
      if (e.target?.dataset?.action === 'edit-template') {
        openTemplateEditModal(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'preview-template') {
        alert(`Preview for ${e.target.dataset.id} (stub)`);
        closeAllTplMenus();
        return;
      }
      if (e.target?.dataset?.action === 'apply-template') {
        applyTemplate(e.target.dataset.id);
        closeAllTplMenus();
        return;
      }
      // click outside menus
      if (!e.target.closest('.tpl-menu')) {
        closeAllTplMenus();
      }
    });

    // Content view
    const quickCards = document.getElementById('quick-cards');
    const quickModal = document.getElementById('quick-modal-backdrop');
    const quickForm = document.getElementById('quick-form');
    const quickModalClose = document.getElementById('quick-modal-close');
    const quickModalCancel = document.getElementById('quick-modal-cancel');
    const quickModalSave = document.getElementById('quick-modal-save');
    const quickModalTitle = document.getElementById('quick-modal-title');
    const contentModelList = document.getElementById('content-model-list');
    const contentTable = document.getElementById('content-table');
    const contentSearch = document.getElementById('content-search');
    const contentActionsBtn = document.getElementById('content-actions-btn');
    const contentActionsWrap = document.getElementById('content-actions-wrap');
    const contentActionsMenu = document.getElementById('content-actions-menu');
    const newItemBtn = document.getElementById('new-item-btn');
    let currentUser = localStorage.getItem('ace_user') || `User-${Math.floor(Math.random()*1000)}`;
    const itemModal = document.getElementById('item-modal-backdrop');
    const itemForm = document.getElementById('item-form');
    const itemModalClose = document.getElementById('item-modal-close');
    const itemModalCancel = document.getElementById('item-modal-cancel');
    const itemModalSave = document.getElementById('item-modal-save');
    const itemModalTitle = document.getElementById('item-modal-title');
    let currentQuickTemplateId = null;

    function renderQuickCards() {
      if (!quickCards) return;
      quickCards.innerHTML = "";
      quickTemplates.forEach((tpl) => {
        const card = document.createElement('div');
        card.className = 'quick-card';
        card.dataset.id = tpl.id;
        card.innerHTML = `
          <h3>${tpl.label}</h3>
          <div class="muted">${tpl.description}</div>
        `;
        card.addEventListener('click', () => openQuickModal(tpl.id));
        quickCards.appendChild(card);
      });
    }

    function openQuickModal(tplId) {
      const tpl = quickTemplates.find((t) => t.id === tplId);
      if (!tpl) return;
      ensureModelFromTemplate(tpl.id);
      currentQuickTemplateId = tpl.id;
      quickModalTitle.textContent = tpl.label;
      quickForm.innerHTML = "";
      const intro = document.createElement('div');
      intro.className = 'muted';
      intro.style.fontSize = '12px';
      intro.textContent = 'ÂøÖÈ†à„Å†„ÅëÂÖ•Âäõ„Åó„Å¶‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ„Ç™„Éó„Ç∑„Éß„É≥„ÅØÂæå„ÅßËøΩÂä†ÂèØËÉΩ„ÄÇ';
      quickForm.appendChild(intro);

      const requiredBlocks = [];
      const optionalBlocks = [];

      tpl.fields.forEach((field) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-section';
        const typeAttr = field.type === "number" ? 'type="number"' : 'type="text"';
        wrapper.innerHTML = `
          <label>${field.label} ${field.required ? '<span class="badge required">‚óé</span>' : ''}</label>
          <input class="input" ${typeAttr} data-key="${field.key}" placeholder="${field.placeholder || ''}">
        `;
        (field.required ? requiredBlocks : optionalBlocks).push(wrapper);
      });

      const requiredContainer = document.createElement('div');
      requiredContainer.className = 'modal-section';
      requiredBlocks.forEach((el) => requiredContainer.appendChild(el));
      quickForm.appendChild(requiredContainer);

      if (optionalBlocks.length) {
        const optionalContainer = document.createElement('div');
        optionalContainer.className = 'collapsible';
        optionalContainer.innerHTML = `
          <div class="collapsible-header">
            <div>
              <strong>„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ (${optionalBlocks.length})</strong>
              <div class="muted" style="font-size:12px;">Âæå„ÅßÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô</div>
            </div>
            <span class="chevron">‚ñæ</span>
          </div>
          <div class="collapsible-body hidden"></div>
        `;
        const body = optionalContainer.querySelector('.collapsible-body');
        optionalBlocks.forEach((el) => body.appendChild(el));
        optionalContainer.querySelector('.collapsible-header').addEventListener('click', () => {
          const isHidden = body.classList.contains('hidden');
          body.classList.toggle('hidden', !isHidden);
          optionalContainer.querySelector('.chevron').textContent = isHidden ? '‚ñ¥' : '‚ñæ';
        });
        quickForm.appendChild(optionalContainer);
      }
      quickModal.style.display = "flex";
    }

    function closeQuickModal() {
      quickModal.style.display = "none";
      currentQuickTemplateId = null;
    }
    quickModalClose?.addEventListener('click', closeQuickModal);
    quickModalCancel?.addEventListener('click', closeQuickModal);
    quickModal?.addEventListener('click', (e) => {
      if (e.target === quickModal) closeQuickModal();
    });

    quickModalSave?.addEventListener('click', () => {
      if (!currentQuickTemplateId) return closeQuickModal();
      const tpl = quickTemplates.find((t) => t.id === currentQuickTemplateId);
      if (!tpl) return closeQuickModal();
      const record = { status: "Draft" };
      let valid = true;
      const errors = [];
      tpl.fields.forEach((f) => {
        const el = quickForm.querySelector(`[data-key="${f.key}"]`);
        if (!el) return;
        const value = el.value.trim();
        if (f.required && !value) {
          valid = false;
          errors.push(`${f.label} „ÅØÂøÖÈ†à„Åß„Åô`);
        }
        if (value) record[f.key] = value;
      });
      if (!valid) {
        alert(errors.join("\n"));
        return;
      }
      if (!contentStore[tpl.id]) contentStore[tpl.id] = [];
      contentStore[tpl.id].push(record);
      currentModelId = tpl.id;
      renderModelList();
      renderContentModelList();
      renderContentTable();
      updateActionsVisibility();
      switchView('content');
      closeQuickModal();
    });

    function renderContentModelList() {
      if (!contentModelList) return;
      contentModelList.innerHTML = "";
      Object.keys(modelStore).forEach((id) => {
        const row = document.createElement('div');
        row.className = 'content-model-item';
        if (id === currentModelId) row.classList.add('active');
        row.textContent = modelStore[id].label;
        row.addEventListener('click', () => {
          currentModelId = id;
          renderContentModelList();
          renderContentTable();
          renderModelList();
          renderGroups();
          sendJoin(currentModelId);
        });
        contentModelList.appendChild(row);
      });
    }

    const updatedCells = [];

    function renderContentTable() {
      if (!contentTable) return;
      const thead = contentTable.querySelector('thead');
      const tbody = contentTable.querySelector('tbody');
      thead.innerHTML = "";
      tbody.innerHTML = "";
      const fields = currentFields().slice(0, 7); // show first few columns
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th class="col-checkbox"><input type="checkbox" id="content-select-all"></th>
        <th class="col-icon"></th>
        <th>Status</th>
        ${fields.map((f) => `<th>${f.label} <span class="sort-icon">‚áÖ</span></th>`).join("")}
      `;
      thead.appendChild(headerRow);

      const items = (contentStore[currentModelId] || []).filter((item) => {
        const q = (contentSearch?.value || "").toLowerCase();
        if (!q) return true;
        return Object.values(item).some((v) => (v || "").toString().toLowerCase().includes(q));
      });

      items.forEach((item, rowIdx) => {
        const tr = document.createElement('tr');
        tr.dataset.row = rowIdx;
        const showC = item.status === "Published";
        tr.innerHTML = `
          <td class="col-checkbox"><input type="checkbox" class="content-select-row" data-row="${rowIdx}"></td>
          <td class="col-icon">${showC ? '<span class="icon-detail" title="Published">C</span>' : ''}</td>
          <td><span class="status-dot"><span class="dot ${item.status === "Published" ? "published" : "draft"}"></span> ${item.status}</span></td>
          ${fields.map((f) => `<td title="${item[f.key] || ""}">${item[f.key] || "-"}</td>`).join("")}
        `;
        tbody.appendChild(tr);
      });

      // Update header with model name and key
      const tplKey = (templateList.find((t)=>t.id===currentModelId)?.key) || currentModelId;
      const contentModelName = document.getElementById('content-model-name');
      const contentModelKey = document.getElementById('content-model-key');
      if (contentModelName) contentModelName.textContent = modelStore[currentModelId].label;
      if (contentModelKey) contentModelKey.textContent = `#${tplKey}`;

      // Update pagination info
      const pageInfo = document.getElementById('page-info');
      if (pageInfo) {
        const total = items.length;
        pageInfo.textContent = `1-${total} of ${total} items`;
      }

      applyUpdatedHighlights();
    }

    function openItemModal() {
      itemForm.innerHTML = "";
      itemModalTitle.textContent = modelStore[currentModelId].label;
      const intro = document.createElement('div');
      intro.className = 'muted';
      intro.style.fontSize = '12px';
      intro.textContent = 'ÂøÖÈ†àÈ†ÖÁõÆ„Å†„ÅëÂÖ•Âäõ„Åô„Çå„Å∞‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ„Ç™„Éó„Ç∑„Éß„É≥„ÅØÂæå„ÅßÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô„ÄÇ';
      itemForm.appendChild(intro);

      const requiredBlocks = [];
      const optionalBlocks = [];

      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-section';
        wrapper.innerHTML = `
          <label>${meta.display || f.label} ${meta.required ? '<span class="badge required">‚óé</span>' : ''}</label>
          ${renderInputForField(f, meta)}
        `;
        if (meta.required) {
          requiredBlocks.push(wrapper);
        } else {
          optionalBlocks.push(wrapper);
        }
      });
      const requiredContainer = document.createElement('div');
      requiredContainer.className = 'modal-section';
      requiredBlocks.forEach((el) => requiredContainer.appendChild(el));
      itemForm.appendChild(requiredContainer);

      if (optionalBlocks.length) {
        const optionalContainer = document.createElement('div');
        optionalContainer.className = 'collapsible';
        optionalContainer.innerHTML = `
          <div class="collapsible-header" id="optional-toggle">
            <div>
              <strong>„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ (${optionalBlocks.length})</strong>
              <div class="muted" style="font-size:12px;">Âæå„ÅßÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô</div>
            </div>
            <span class="chevron">‚ñæ</span>
          </div>
          <div class="collapsible-body hidden" id="optional-body"></div>
        `;
        const body = optionalContainer.querySelector('#optional-body');
        optionalBlocks.forEach((el) => body.appendChild(el));
        optionalContainer.querySelector('#optional-toggle').addEventListener('click', () => {
          const isHidden = body.classList.contains('hidden');
          body.classList.toggle('hidden', !isHidden);
          optionalContainer.querySelector('.chevron').textContent = isHidden ? '‚ñ¥' : '‚ñæ';
        });
        itemForm.appendChild(optionalContainer);
      }
      itemModal.style.display = "flex";
    }

    function renderInputForField(f, meta) {
      if (f.type === "Option" && meta.options?.length) {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            ${meta.options.map((opt) => `<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
      }
      if (f.type === "Int") {
        return `<input class="input" type="number" step="1" data-key="${meta.key}">`;
      }
      if (f.type === "Float") {
        return `<input class="input" type="number" step="any" data-key="${meta.key}">`;
      }
      if (f.type === "Boolean") {
        return `
          <select class="input" data-key="${meta.key}">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        `;
      }
      if (f.type === "Date") {
        return `<input class="input" type="date" data-key="${meta.key}">`;
      }
      if (f.type === "Coordinate") {
        return `
          <div class="row" style="gap:8px;">
            <input class="input" type="text" placeholder="lat" data-key="${meta.key}-lat">
            <input class="input" type="text" placeholder="lng" data-key="${meta.key}-lng">
          </div>
        `;
      }
      return `<input class="input" type="text" data-key="${meta.key}" placeholder="${meta.pattern ? meta.pattern : ''}">`;
    }

    function closeItemModal() {
      itemModal.style.display = "none";
    }
    itemModalClose.addEventListener('click', closeItemModal);
    itemModalCancel.addEventListener('click', closeItemModal);
    itemModal.addEventListener('click', (e) => {
      if (e.target === itemModal) closeItemModal();
    });
    newItemBtn?.addEventListener('click', openItemModal);
    contentActionsBtn?.addEventListener('click', () => {
      contentActionsMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!contentActionsMenu.contains(e.target) && e.target !== contentActionsBtn) {
        contentActionsMenu.classList.remove('active');
      }
    });

    itemModalSave.addEventListener('click', () => {
      const inputs = itemForm.querySelectorAll('[data-key]');
      const record = { status: "Draft" };
      let valid = true;
      const errors = [];
      currentFields().forEach((f, idx) => {
        const meta = currentMeta()[idx];
        if (f.type === "Coordinate") {
          const lat = itemForm.querySelector(`[data-key="${meta.key}-lat"]`)?.value.trim();
          const lng = itemForm.querySelector(`[data-key="${meta.key}-lng"]`)?.value.trim();
          if (meta.required && (!lat || !lng)) {
            valid = false; errors.push(`${meta.display} „ÅØÂøÖÈ†à`);
          }
          if (lat && lng) record[meta.key] = `${lat}, ${lng}`;
          return;
        }
        const el = itemForm.querySelector(`[data-key="${meta.key}"]`);
        if (!el) return;
        const value = el.value.trim();
        if (meta.required && !value) {
          valid = false; errors.push(`${meta.display} „ÅØÂøÖÈ†à`);
        }
        if (meta.pattern && value && !(new RegExp(meta.pattern).test(value))) {
          valid = false; errors.push(`${meta.display} „ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì`);
        }
        record[meta.key] = value;
      });
      if (!valid) {
        alert(errors.join("\n"));
        return;
      }
      if (!contentStore[currentModelId]) contentStore[currentModelId] = [];
      contentStore[currentModelId].push(record);
      renderContentTable();
      sendPatch(currentModelId, contentStore[currentModelId]);
      updateActionsVisibility();
      closeItemModal();
    });

    contentSearch?.addEventListener('input', renderContentTable);

    // Inline edit handlers
    contentTable?.addEventListener('focusin', (e) => {
      const rowIdx = e.target.dataset.row;
      const key = e.target.dataset.key;
      if (rowIdx !== undefined) {
        highlightRow(rowIdx);
        e.target.dataset.prev = e.target.value;
      }
      if (key) {
        e.target.classList.remove('cell-error');
        const tooltip = e.target.parentElement.querySelector('.tooltip');
        if (tooltip) tooltip.style.display = 'none';
      }
    });

    function validateCell(key, value, meta) {
      if (key === 'status') return { ok: true };
      if (meta?.required && !value) return { ok: false, reason: 'ÂøÖÈ†à„Åß„Åô' };
      let pattern = meta?.pattern;
      let hint = "";
      if (key === 'identifier') {
        pattern = '^\\d+$'; // ID must be digits
        hint = "Êï∞Â≠ó„ÅÆ„Åø„ÄÅÁ©∫Ê¨Ñ‰∏çÂèØ";
      } else if (pattern) {
        hint = `Pattern: ${pattern}`;
      }
      if (pattern && value && !(new RegExp(pattern).test(value))) {
        return { ok: false, reason: hint || 'ÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì' };
      }
      return { ok: true };
    }

    function getMetaByKey(key) {
      const idx = currentMeta().findIndex((m) => m.key === key);
      return idx >= 0 ? currentMeta()[idx] : null;
    }

    contentTable?.addEventListener('focusout', (e) => {
      const rowIdx = e.target.dataset.row;
      const key = e.target.dataset.key;
      if (rowIdx === undefined || !key) return;
      const meta = getMetaByKey(key);
      const value = e.target.value.trim();
      const validation = validateCell(key, value, meta);
      if (!validation.ok) {
        e.target.classList.add('cell-error');
        const tooltip = e.target.parentElement.querySelector('.tooltip');
        if (tooltip) {
          tooltip.textContent = validation.reason || 'ÂÖ•Âäõ„Ç®„É©„Éº';
          tooltip.style.display = 'block';
        }
        // keep user input (do not revert), just block save/broadcast
        return;
      }
      e.target.classList.remove('cell-error');
      const tooltip = e.target.parentElement.querySelector('.tooltip');
      if (tooltip) tooltip.style.display = 'none';
      const record = (contentStore[currentModelId] || [])[rowIdx];
      if (!record) return;
      const oldValue = record[key];
      record[key] = value;
      markCellUpdated(rowIdx, key);
      sendPatch(currentModelId, [{ rowId: Number(rowIdx), key, oldValue, newValue: value, ts: Date.now(), user: currentUser }]);
      // keep highlight if checkbox or focused; remove if neither
      const checkbox = contentTable.querySelector(`.content-select-row[data-row="${rowIdx}"]`);
      if (!(checkbox && checkbox.checked)) {
        unhighlightRow(rowIdx);
      }
    });

    contentTable?.addEventListener('input', (e) => {
      if (e.target.classList.contains('content-select-row')) {
        updateActionsVisibility();
        if (e.target.checked) {
          highlightRow(e.target.dataset.row);
        } else {
          unhighlightRow(e.target.dataset.row);
        }
      }
      if (e.target.id === 'content-select-all') {
        updateActionsVisibility();
        document.querySelectorAll('.content-select-row').forEach((c) => {
          if (c.checked) highlightRow(c.dataset.row); else unhighlightRow(c.dataset.row);
        });
      }
    });
    contentTable?.addEventListener('change', (e) => {
      if (e.target.id === 'content-select-all') {
        const checked = e.target.checked;
        document.querySelectorAll('.content-select-row').forEach((c) => (c.checked = checked));
        updateActionsVisibility();
      }
    });

    contentActionsMenu?.addEventListener('click', (e) => {
      const action = e.target.dataset.action;
      if (!action) return;
      const selected = Array.from(document.querySelectorAll('.content-select-row'))
        .filter((c) => c.checked)
        .map((c) => Number(c.dataset.row));
      const items = contentStore[currentModelId] || [];
      if (action === 'delete-selected') {
        contentStore[currentModelId] = items.filter((_, idx) => !selected.includes(idx));
      }
      if (action === 'publish-selected') {
        selected.forEach((idx) => { if (items[idx]) items[idx].status = "Published"; });
      }
      if (action === 'draft-selected') {
        selected.forEach((idx) => { if (items[idx]) items[idx].status = "Draft"; });
      }
      if (action === 'sort-asc' || action === 'sort-desc') {
        const key = currentFields()[0]?.key;
        if (key) {
          items.sort((a, b) => {
            const av = (a[key] || "").toString();
            const bv = (b[key] || "").toString();
            return action === 'sort-asc' ? av.localeCompare(bv, "ja") : bv.localeCompare(av, "ja");
          });
        }
      }
      renderContentTable();
      const edits = [];
      selected.forEach((idx) => {
        if (!items[idx]) return;
        edits.push({ rowId: idx, key: "status", oldValue: items[idx].status, newValue: items[idx].status, ts: Date.now(), user: currentUser });
      });
      sendPatch(currentModelId, edits);
      contentActionsMenu.classList.remove('active');
    });

    function updateActionsVisibility() {
      if (!contentActionsWrap) return;
      const anySelected = document.querySelector('.content-select-row:checked');
      contentActionsWrap.style.display = anySelected ? 'inline-block' : 'none';
    }

    function highlightRow(rowIdx) {
      const row = contentTable?.querySelector(`tr[data-row="${rowIdx}"]`);
      if (row) row.classList.add('active-row');
    }
    function unhighlightRow(rowIdx) {
      const row = contentTable?.querySelector(`tr[data-row="${rowIdx}"]`);
      if (row) row.classList.remove('active-row');
    }

    function markCellUpdated(rowIdx, key) {
      updatedCells.push({ rowIdx, key, ts: Date.now() });
    }

    function applyUpdatedHighlights() {
      if (!contentTable) return;
      updatedCells.splice(0).forEach(({ rowIdx, key }) => {
        const input = contentTable.querySelector(`input[data-row="${rowIdx}"][data-key="${key}"]`);
        if (input) {
          input.classList.add('cell-updated');
          setTimeout(() => input.classList.remove('cell-updated'), 1200);
        }
      });
    }

    function toggleTplMenu(id) {
      const menu = document.querySelector(`.tpl-menu[data-id="${id}"]`);
      if (!menu) return;
      menu.classList.toggle('active');
    }
    function closeAllTplMenus() {
      document.querySelectorAll('.tpl-menu').forEach((m) => m.classList.remove('active'));
    }

    // WebSocket sync (optional)
    let ws;
    function initWS() {
      try {
        ws = new WebSocket("ws://localhost:7070");
      } catch (e) {
        console.warn("WS not available");
        return;
      }
      ws.addEventListener("open", () => {
        sendJoin(currentModelId);
      });
      ws.addEventListener("message", (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === "snapshot" && msg.modelId === currentModelId) {
            // Only update if server has data, otherwise keep local sample data
            if (msg.items && msg.items.length > 0) {
              contentStore[msg.modelId] = msg.items;
              renderContentTable();
            }
          }
          if (msg.type === "patch" && msg.modelId === currentModelId) {
            if (!contentStore[msg.modelId]) contentStore[msg.modelId] = [];
            msg.edits?.forEach((edit) => {
              if (!contentStore[msg.modelId][edit.rowId]) contentStore[msg.modelId][edit.rowId] = {};
              contentStore[msg.modelId][edit.rowId][edit.key] = edit.newValue;
              markCellUpdated(edit.rowId, edit.key);
            });
            renderContentTable();
          }
        } catch (_) {}
      });
      ws.addEventListener("close", () => {
        setTimeout(initWS, 2000);
      });
    }
    function sendPatch(modelId, edits) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "patch", modelId, edits, user: currentUser }));
    }
    function sendJoin(modelId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "join", modelId, user: currentUser }));
    }

    // Excel Import functionality
    const excelImportBtn = document.getElementById('excel-import-btn');
    const excelImportBackdrop = document.getElementById('excel-import-backdrop');
    const excelImportClose = document.getElementById('excel-import-close');
    const excelImportCancel = document.getElementById('excel-import-cancel');
    const excelImportSave = document.getElementById('excel-import-save');
    const excelDropzone = document.getElementById('excel-dropzone');
    const excelFileInput = document.getElementById('excel-file-input');
    const excelBrowseBtn = document.getElementById('excel-browse-btn');
    const excelUploadStep = document.getElementById('excel-upload-step');
    const excelLoadingStep = document.getElementById('excel-loading-step');
    const excelPreviewStep = document.getElementById('excel-preview-step');
    const excelFieldList = document.getElementById('excel-field-list');
    const excelFieldCount = document.getElementById('excel-field-count');
    const excelTplLabel = document.getElementById('excel-tpl-label');
    const excelTplId = document.getElementById('excel-tpl-id');
    const excelTplDesc = document.getElementById('excel-tpl-desc');
    const excelJsonPreview = document.getElementById('excel-json-preview');
    const excelWarningBanner = document.getElementById('excel-warning-banner');

    let currentExcelSchema = null;

    function openExcelImportModal() {
      excelImportBackdrop.style.display = 'flex';
      resetExcelImport();
    }

    function closeExcelImportModal() {
      excelImportBackdrop.style.display = 'none';
      resetExcelImport();
    }

    function resetExcelImport() {
      currentExcelSchema = null;
      excelFileInput.value = '';
      excelUploadStep.classList.remove('hidden');
      excelLoadingStep.classList.add('hidden');
      excelPreviewStep.classList.add('hidden');
      excelImportSave.classList.add('hidden');
      excelWarningBanner.classList.add('hidden');
      excelFieldList.innerHTML = '';
      excelTplLabel.value = '';
      excelTplId.value = '';
      excelTplDesc.value = '';
    }

    function showExcelLoading() {
      excelUploadStep.classList.add('hidden');
      excelLoadingStep.classList.remove('hidden');
      excelPreviewStep.classList.add('hidden');
    }

    function showExcelPreview(result) {
      excelUploadStep.classList.add('hidden');
      excelLoadingStep.classList.add('hidden');
      excelPreviewStep.classList.remove('hidden');
      excelImportSave.classList.remove('hidden');

      currentExcelSchema = result.schema;

      // Show warning if not AI-generated
      if (result.warning || !result.aiGenerated) {
        excelWarningBanner.textContent = result.warning || 'Schema was generated using rule-based analysis (AI unavailable).';
        excelWarningBanner.classList.remove('hidden');
      } else {
        excelWarningBanner.classList.add('hidden');
      }

      // Populate fields
      excelTplLabel.value = result.schema.label || '';
      excelTplId.value = result.schema.id || '';
      excelTplDesc.value = result.schema.description || '';

      renderExcelFields(result.schema.fields);
      updateExcelJsonPreview();
    }

    function renderExcelFields(fields) {
      excelFieldCount.textContent = fields.length;
      excelFieldList.innerHTML = fields.map((field, idx) => `
        <div class="excel-field-card" data-index="${idx}">
          <div class="field-top">
            <div>
              <input class="field-name" value="${escapeHtml(field.label)}" data-field="label" style="font-weight:600; border:none; padding:0; font-size:14px;" placeholder="Field Label">
              <div class="field-key">#<input value="${escapeHtml(field.fieldKey)}" data-field="fieldKey" style="border:none; padding:0; font-size:12px; color: var(--muted); width: 120px;" placeholder="fieldKey"></div>
            </div>
            <select data-field="type" style="min-width: 140px;">
              <option value="string" ${field.type === 'string' ? 'selected' : ''}>String</option>
              <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
              <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
              <option value="boolean" ${field.type === 'boolean' ? 'selected' : ''}>Boolean</option>
              <option value="latitude" ${field.type === 'latitude' ? 'selected' : ''}>Latitude</option>
              <option value="longitude" ${field.type === 'longitude' ? 'selected' : ''}>Longitude</option>
              <option value="controlledVocabulary" ${field.type === 'controlledVocabulary' ? 'selected' : ''}>Controlled Vocabulary</option>
            </select>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" data-field="required" ${field.required ? 'checked' : ''}> Required
            </label>
            ${field.type === 'controlledVocabulary' && field.options ? `
              <div class="muted" style="font-size: 11px;">Options: ${field.options.slice(0, 3).join(', ')}${field.options.length > 3 ? '...' : ''}</div>
            ` : ''}
          </div>
        </div>
      `).join('');

      // Add change listeners
      excelFieldList.querySelectorAll('[data-field]').forEach(input => {
        input.addEventListener('change', () => updateFieldFromInput(input));
        input.addEventListener('input', () => updateFieldFromInput(input));
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function updateFieldFromInput(input) {
      const card = input.closest('.excel-field-card');
      const idx = parseInt(card.dataset.index);
      const fieldName = input.dataset.field;
      const value = input.type === 'checkbox' ? input.checked : input.value;

      if (currentExcelSchema && currentExcelSchema.fields[idx]) {
        currentExcelSchema.fields[idx][fieldName] = value;
        updateExcelJsonPreview();
      }
    }

    function updateExcelJsonPreview() {
      if (!currentExcelSchema) return;
      const schema = {
        ...currentExcelSchema,
        id: excelTplId.value || currentExcelSchema.id,
        label: excelTplLabel.value || currentExcelSchema.label,
        description: excelTplDesc.value || currentExcelSchema.description
      };
      excelJsonPreview.textContent = JSON.stringify(schema, null, 2);
    }

    async function uploadExcelFile(file) {
      showExcelLoading();

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/v1/excel-to-schema/analyze', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to analyze file');
        }

        const result = await response.json();
        showExcelPreview(result);
      } catch (error) {
        alert('Error: ' + error.message);
        resetExcelImport();
      }
    }

    async function saveExcelTemplate() {
      if (!currentExcelSchema) return;

      const schema = {
        ...currentExcelSchema,
        id: excelTplId.value.trim() || currentExcelSchema.id,
        label: excelTplLabel.value.trim() || currentExcelSchema.label,
        description: excelTplDesc.value.trim() || currentExcelSchema.description
      };

      // Validate ID
      if (!/^[a-z0-9-]+$/.test(schema.id)) {
        alert('Template ID must be kebab-case (lowercase letters, numbers, and hyphens only)');
        return;
      }

      try {
        const response = await fetch('/v1/excel-to-schema/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            schema: {
              ...schema,
              fields: schema.fields.map(f => ({
                ...f,
                pattern: f.pattern?.source || f.pattern
              }))
            }
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.errors?.join(', ') || 'Failed to create template');
        }

        // Add to local templateList for immediate UI update
        templateList.push({
          id: schema.id,
          label: schema.label,
          key: schema.id.replace(/-/g, '_'),
          version: 'v1.0',
          category: 'imported',
          summary: schema.description || 'Imported from Excel'
        });

        closeExcelImportModal();
        renderTemplates();
        renderTemplateModalCards();
        alert('Template created successfully!');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Event listeners
    excelImportBtn?.addEventListener('click', openExcelImportModal);
    excelImportClose?.addEventListener('click', closeExcelImportModal);
    excelImportCancel?.addEventListener('click', closeExcelImportModal);
    excelImportBackdrop?.addEventListener('click', (e) => {
      if (e.target === excelImportBackdrop) closeExcelImportModal();
    });

    excelBrowseBtn?.addEventListener('click', () => excelFileInput?.click());
    excelDropzone?.addEventListener('click', (e) => {
      if (e.target !== excelBrowseBtn) excelFileInput?.click();
    });

    excelFileInput?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) uploadExcelFile(file);
    });

    excelDropzone?.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelDropzone.classList.add('drag-over');
    });
    excelDropzone?.addEventListener('dragleave', () => {
      excelDropzone.classList.remove('drag-over');
    });
    excelDropzone?.addEventListener('drop', (e) => {
      e.preventDefault();
      excelDropzone.classList.remove('drag-over');
      const file = e.dataTransfer?.files?.[0];
      if (file) uploadExcelFile(file);
    });

    excelImportSave?.addEventListener('click', saveExcelTemplate);

    // Tab switching for excel modal
    document.querySelectorAll('[data-excel-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        const pane = tab.dataset.excelTab;
        document.querySelectorAll('[data-excel-tab]').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('[data-excel-pane]').forEach(p => p.classList.add('hidden'));
        tab.classList.add('active');
        document.querySelector(`[data-excel-pane="${pane}"]`)?.classList.remove('hidden');
        if (pane === 'json') updateExcelJsonPreview();
      });
    });

    // Update JSON preview when settings change
    excelTplLabel?.addEventListener('input', updateExcelJsonPreview);
    excelTplId?.addEventListener('input', updateExcelJsonPreview);
    excelTplDesc?.addEventListener('input', updateExcelJsonPreview);

    // Back button handler
    const schemaBackBtn = document.getElementById('schema-back-btn');
    function updateBackButton() {
      if (schemaBackBtn) {
        if (currentGroupId !== null) {
          schemaBackBtn.classList.remove('hidden');
        } else {
          schemaBackBtn.classList.add('hidden');
        }
      }
    }
    if (schemaBackBtn) {
      schemaBackBtn.addEventListener('click', () => {
        currentGroupId = null;
        const titleEl = document.getElementById('schema-model-title');
        const keyEl = document.getElementById('schema-model-key');
        if (titleEl) titleEl.textContent = modelStore[currentModelId].label;
        if (keyEl) keyEl.textContent = '#' + currentModelId.replace(/-/g, '_');
        renderModelList();
        renderGroups();
        renderFields();
        updateBackButton();
        removePlaceholder();
      });
    }

    renderModelList();
    renderGroups();
    renderFields();
    updateBackButton();
    renderPalette();
    renderTemplates();
    renderContentModelList();
    renderContentTable();
    renderQuickCards();
    initWS();
    updateActionsVisibility();

    // Restore last view
    const lastView = (() => {
      try {
        return localStorage.getItem('ace_last_view') || 'models';
      } catch (_) {
        return 'models';
      }
    })();
    // ÂàùÂßãÂåñ Group Add ÂäüËÉΩ
    initGroupAddEvents();

    switchView(lastView);
  </script>
</body>
</html>
